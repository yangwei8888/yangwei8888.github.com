<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="terry yang's blog | java | scala | bi" />



  <meta name="keywords" content="Hexo,next" />



  <link rel="alternate" href="/atom.xml" title="yosita" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="terry yang&apos;s blog | java | scala | bi">
<meta property="og:type" content="website">
<meta property="og:title" content="yosita">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="yosita">
<meta property="og:description" content="terry yang&apos;s blog | java | scala | bi">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yosita">
<meta name="twitter:description" content="terry yang&apos;s blog | java | scala | bi">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post'
  };
</script>

  <title> yosita </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7e8961fdae021b7bf62f2c767bb18c23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">yosita</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/dotnet_guide/" itemprop="url">
                .NET 数据存储开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/dotnet_guide/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/dotnet_guide/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="-NET_数据存储开发指南">.NET 数据存储开发指南</h1><h2 id="简介">简介</h2><p>目前我们的 .NET 数据存储支持如下运行时：</p>
<ul>
<li>Windows Phone Silverlight （8.0 &amp; 8.1）</li>
<li>Windows Desktop .NET Framework 4.5+</li>
<li>Xamarin Form 1.4+</li>
<li>Xamarin iOS 8+</li>
<li>Xamarin Android 5+</li>
</ul>
<p>尚未发布但是已在计划内的如下：</p>
<ul>
<li>Windows Runtime （for Windows 10）</li>
</ul>
<p>文档中涉及的语法以及接口均对所有运行时有效。</p>
<h2 id="快速入门">快速入门</h2><p>建议您在阅读本文档之前，阅读我们提供的<a href="/start.html">快速入门</a>文档，获取 LeanCloud 使用的配置和第一印象。</p>
<h2 id="安装">安装</h2><p>为了支持实时聊天，LeanCloud SDK for .NET 依赖于几个开源的库，所以推荐开发者从 <a href="https://www.nuget.org/packages/LeanCloud/1.0.1.2-pre" target="_blank" rel="external">Nuget</a> 上下载我们的 SDK。</p>
<h2 id="介绍">介绍</h2><p>LeanCloud的 .NET SDK 依赖于微软提供的<a href="http://msdn.microsoft.com/zh-cn/library/hh873175.aspx" target="_blank" rel="external">基于任务的异步模式 (TAP)</a>的方式，所以您最好有 .NET Framework 4.5 的编程经验，或者对 .NET Framework 4.5 的新 API 有所了解。</p>
<h2 id="应用">应用</h2><p>在 LeanCloud 的每个应用有自己的 ID 和客户端密钥，在客户端代码中应该用他们来初始化 SDK。<br>LeanCloud 的每一个账户都可以创建多个应用。同一个应用可以分别在测试环境和生产环境部署不同的版本。</p>
<h3 id="初始化">初始化</h3><p>在 LeanCloud 中，几乎所有平台下的接口我们都尽量保持一致，目的就是为了降低开发者的开发成本，所以在初始化的时候我们几乎都是遵循在 <code>AVClient</code> 这个类下有一个叫做 <code>Initialize</code>（不同平台的编程规范可能不一样，但是在 C# 语言风格中一般方法名的首字母都是大写）的方法，这个方法目前有 2 个重载：</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AVClient.Initialize(string applicationId, string appKey)<span class="comment">;</span></span><br><span class="line">传入您的 <span class="escape">`A</span>pp ID<span class="escape">` </span>以及 <span class="escape">`A</span>pp Key<span class="escape">`，</span>默认访问的是 LeanCloud 的中国节点。</span><br></pre></td></tr></table></figure>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AVClient<span class="built_in">.</span>Initialize(<span class="built_in">string</span> applicationId, <span class="built_in">string</span> appKey, AVRegion region);</span><br><span class="line">除了传入您的 <span class="string">`App ID`</span> 以及 <span class="string">`App Key`</span>之外，指定 LeanCloud 的服务节点，现在 AVRegion 仅支持 <span class="literal">CN</span> 以及 US 节点。</span><br></pre></td></tr></table></figure>
<p>注意，目前 LeanCloud 的节点上的数据是相互隔离的，换言之，您在中国节点上注册的应用无法访问美国节点，反之亦然。</p>
<h2 id="对象">对象</h2><h3 id="AVObject">AVObject</h3><p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。每个 <code>AVObject</code> 都包含了与 JSON 兼容的 key-value 对应的数据。数据是 schema-free 的，你不需要在每个 AVObject 上提前指定存在哪些键，只要直接设定对应的 key-value 即可。<br>key 必须是字母数字或下划线组成的字符串。值可以是字符串，数字，布尔值，甚至数组和字典。<br>每个 <code>AVObject</code> 都必须有一个类（Class）名称，以便于您区分不同类型的数据。例如，我们可以将对应的体育运动称为 <code>Sport</code>。我们建议的您将类和 key 按照 <code>NameYourClassesLikeThis</code> 以及 <code>nameYourKeysLikeThis</code> 这样的惯例命名。</p>
<h3 id="保存对象">保存对象</h3><p>接下来，你需要将上文中的 <code>Sport</code> 存储到 LeanCloud 的服务。LeanCloud 的相关接口和 <code>IDictionary&lt;string, object&gt;</code> 类似，但只有调用 <code>SaveAsync</code> 方法时才会实际保存到服务器：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AVObject football =<span class="keyword">new</span> AVObject(<span class="string">"Sport"</span>);</span><br><span class="line">football[<span class="string">"totalTime"</span>] = <span class="number">90</span>;</span><br><span class="line">football[<span class="string">"name"</span>] = <span class="string">"Football"</span>;</span><br><span class="line">Task saveTask = football.SaveAsync();</span><br><span class="line">await saveTask;</span><br></pre></td></tr></table></figure>
<p>在运行此代码后，您应当了解保存动作是否已经生效 。为了确保数据被保存，您可以在 LeanCloud 上的<a href="/data.html?appid=&lt;!--￼72--">数据管理</a>中查看您应用的数据。</p>
<p>此处有两件事情需要特别注明。<br>首先，在运行此代码之前，您不必配置或设置一个称为 「Sport」 的新类。LeanCloud 会自动创建这个类。</p>
<p>此外，为了更方便的使用 LeanCloud，还有其它几个字段您不需要事先指定。<code>objectId</code> 是为每个对象自动生成的唯一的标识符；<code>createdAt</code> 和 <code>updatedAt</code> 分别代表每个对象在 LeanCloud 中创建和最后修改的时间并会被自动填充。<br>在您执行保存操作之前，这些字段不会被自动保存到 <code>AVObject</code> 中。</p>
<h3 id="在后台工作">在后台工作</h3><p>关于异步编程，一直是每一种语言和平台上必须直面的问题，牵扯到线程，进程的问题大多数都是程序员很头疼的一个难点，但是在 .NET Framework 4.5 之后迎来了一种新的变革，那就是<a href="http://msdn.microsoft.com/zh-cn/library/hh873175.aspx" target="_blank" rel="external">基于任务的异步模式 (TAP)</a>。当然本篇指南的重点不是讲解TAP异步模式的好处，只是希望开发者能够足够的掌握TAP实现异步用法。</p>
<p>LeanCloud .NET SDK 都采用了 TAP 的方式去实现把所有跟 LeanCloud 服务端交互的部分放在后台去进行，这样可以让开发者可以花更多时间去做客户端应该做的事情，而把跟服务端交互的各种进程管理放权给 LeanCloud SDK 去做。</p>
<h3 id="更新对象">更新对象</h3><p>更新对象和保存对象有点相似，只是更新对象会覆盖同名属性的值，在调用 <code>SaveAsync</code> 之后会发送到服务端生效。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var peter = <span class="keyword">new</span> AVObject(<span class="string">"Character"</span>)</span><br><span class="line">&#123;</span><br><span class="line">	&#123; <span class="string">"age"</span>, <span class="number">37</span> &#125;,</span><br><span class="line">	&#123; <span class="string">"name"</span>, <span class="string">"Peter Burke"</span> &#125;,</span><br><span class="line">    &#123; <span class="string">"from"</span>, <span class="string">"White Collar"</span> &#125;,</span><br><span class="line">	&#123; <span class="string">"skills"</span>, <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">"FBI"</span>, <span class="string">"Agent Leader"</span> &#125; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">await peter.SaveAsync().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 保存成功之后，修改一个已经在服务端生效的数据，这里我们修改age</span></span><br><span class="line">	<span class="comment">// LeanCloud 只会针对指定的属性进行覆盖操作，本例中的name不会被修改</span></span><br><span class="line">	peter[<span class="string">"age"</span>] = <span class="number">40</span>;</span><br><span class="line">	peter.SaveAsync();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="获取对象">获取对象</h3><p>如果确定了一个 <code>AVObject</code> 的 <code>objectId</code> 可以通过如下代码构造一个 <code>AVObject</code> 然后通过 <code>FetchAsync</code> 从服务端把数据加载到本地：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AVObject <span class="property">character</span> = AVObject.CreateWithoutData(<span class="string">"Character"</span>, <span class="string">"549818e0e4b096e3561a6abd"</span>);</span><br><span class="line">await <span class="property">character</span>.FetchAsync();</span><br></pre></td></tr></table></figure>
<h3 id="删除对象">删除对象</h3><p>如果想删除某个对象可以直接调用 <code>AVObject</code> 的 <code>DeleteAsync</code> 方法。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">await myObject.<span class="title">DeleteAsync</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果仅仅想删除某个对象的某一个属性，可以调用 <code>Remove</code> 方法。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行下面的语句会将age字段置为空</span></span><br><span class="line">myObject.Remove(<span class="string">"age"</span>);</span><br><span class="line"><span class="comment">// 将删除操作发往服务器生效。</span></span><br><span class="line"><span class="function">await myObject.<span class="title">SaveAsync</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="关系">关系</h3><p>软件程序就是抽象现实中的对象之间的关系在计算机世界里面的解释和展现。有对象必然就会有对象之间的关系，在 LeanCloud 中也给出了传统关系型的解决方案，并且简化了代码，使得代码简洁易维护。<br>假设这样一种场景，做一款时髦的相亲社交软件，男孩会在自己的资料里面标明自己喜欢的女生类型，于是有如下代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVObject</span> girlType = new <span class="built_in">AVObject</span> (<span class="string">"GirType"</span>);</span><br><span class="line">girlType [<span class="string">"typeName"</span>] = <span class="string">"Hot"</span>;</span><br><span class="line"><span class="built_in">AVObject</span> beckham = new <span class="built_in">AVObject</span> (<span class="string">"Boy"</span>);</span><br><span class="line">beckham[<span class="string">"name"</span>]=<span class="string">"David Beckham"</span>;</span><br><span class="line">beckham [<span class="string">"age"</span>] = <span class="number">38</span>;</span><br><span class="line">beckham [<span class="string">"focusType"</span>] = girlType;</span><br><span class="line">await beckham<span class="variable">.SaveAsync</span> ();<span class="comment">//保存beckham的时候会自动将girlType也保存到服务器。</span></span><br></pre></td></tr></table></figure>
<p>当然必然存在一种方法就是将已存在的对象通过<code>ObjectId</code>将它于目标对象进行关联：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beckham[<span class="string">"focusType"</span>] = <span class="built_in">AVObject</span><span class="variable">.CreateWithoutData</span>(<span class="string">"GirType"</span>, <span class="string">"5372d119e4b0d4bef5f036ae"</span>);</span><br></pre></td></tr></table></figure>
<p>值得注意的地方是，当需要从 LeanCloud 上读取数据的时候，默认的 fetch 方法是<code>不会加载关联数据类型的</code>，直到像如下代码执行之后，这些关联数据字段（如上实例中 Boy 的 focusType 字段）才会被实例化。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">AVObject</span> focusType = beckham.Get&lt;AVObject&gt;(<span class="string">"focusType"</span>);</span><br><span class="line"><span class="title">await</span> focusType.FetchIfNeededAsync();</span><br></pre></td></tr></table></figure>
<h2 id="查询">查询</h2><h3 id="AVQuery-GetAsync">AVQuery.GetAsync</h3><p>此方法对应的理解是根据 <code>objectId</code> 查询指定的一条数据，<code>GetAsync</code> 方法的参数为一个 <code>objectId</code>：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query = <span class="built_in">AVObject</span><span class="variable">.GetQuery</span>(<span class="string">"Character"</span>);</span><br><span class="line">           <span class="built_in">AVObject</span> character = await query<span class="variable">.GetAsync</span>(<span class="string">"549818e0e4b096e3561a6abd"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="构建_AVQuery_的注意事项">构建 AVQuery 的注意事项</h3><p>根据 <code>objectId</code> 查询，显然无法满足正常的需求，所以SDK提供了许多简化了操作的查询。<br>首先需要明确最核心的一点，在.NET SDK中，<code>AVQuery</code> 对象的所有带有 <code>Where</code> 开头方法，以及查询范围限定类的方法(<code>Skip||Limit||ThenBy||Include</code>等)都会返回一个全新的对象，它并不是在原始的 <code>AVQuery</code> 对象上修改内部属性。比如:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query=new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"Character"</span>)</span><br><span class="line">query<span class="variable">.WhereEqualTo</span> (<span class="string">"age"</span>, <span class="number">37</span>);<span class="comment">//注意：这是错误的！！！</span></span><br><span class="line">await query<span class="variable">.FindAsync</span> ();</span><br></pre></td></tr></table></figure>
<p><strong> 以上这一小段代码是用户经常会犯的错误案例，请勿拷贝到您的项目 </strong></p>
<p>以上这段代码将返回 <code>Character</code> 中所有的数据，并不会返回所设想的那样 <code>age</code> 等于37数据。<br>正确地写法应该是：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query=new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"Character"</span>)<span class="variable">.WhereEqualTo</span> (<span class="string">"age"</span>, <span class="string">"37"</span>);</span><br></pre></td></tr></table></figure>
<p>以此类推，所有复合条件查询的构造都应该遵循用<code>.</code>这个符号进行链式创建出来的 <code>AVQuery&lt;T&gt;</code>，比如，查找所有 <code>age</code> 等于37，并且 <code>name</code> 包含 <code>peter</code> 的<code>Character</code>：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query = new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; (<span class="string">"Character"</span>)<span class="variable">.WhereEqualTo</span> (<span class="string">"age"</span>, <span class="number">37</span>)<span class="variable">.WhereContains</span>(<span class="string">"name"</span>,<span class="string">"peter"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="基本查询">基本查询</h3><p><code>AVQuery&lt;T&gt;.WhereEqualTo</code> 基本查询逻辑上可以理解为类似于sql语句中的</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> Persons <span class="keyword">WHERE</span> FirstName=<span class="string">'Bush'</span></span><br></pre></td></tr></table></figure>
<p>的<code>=</code>操作，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query=new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"Persons"</span>)<span class="variable">.WhereEqualTo</span> (<span class="string">"FirstName"</span>, <span class="string">"Bush"</span>);</span><br><span class="line">await query<span class="variable">.FindAsync</span> ()<span class="variable">.ContinueWith</span> (t =&gt; &#123;</span><br><span class="line">	IEnumerable&lt;<span class="built_in">AVObject</span>&gt; persons=t<span class="variable">.Result</span>;</span><br><span class="line">	<span class="keyword">int</span> sum=persons<span class="variable">.Count</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="查询条件">查询条件</h3><p>如果要过滤掉特定键的值时可以使用 whereNotEqualTo 方法。比如需要查询 <code>name</code>不等于 <code>Peter Burke</code> 的数据时可以这样写：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="variable">WhereNotEqualTo</span> (<span class="string">"name"</span>, <span class="string">"Peter Burke"</span>);</span><br></pre></td></tr></table></figure>
<p>同时包含多个约束条件的查询，可以这样写：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereNotEqualTo (<span class="string">"name"</span>, <span class="string">"Peter Burke"</span>);</span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereGreaterThan(<span class="string">"age"</span>, 18);<span class="comment">//这样书写是为了文档阅读方便，但是我们还是比较推荐上一节介绍的链式表达式去创建AVQuery</span></span><br></pre></td></tr></table></figure>
<p>以此类推，可以添加多个约束条件，他们彼此是<code>AND</code>的关系。<br>有些需求中，也许只要较少的几条查询结果即可，这种情况下，可以通过设定查询结果的数量：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="variable">Limit</span> (<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>在数据较多的情况下，分页显示数据是比较合理的解决办法，limit 默认 100，最大1000，在 0 到 1000 范围之外的都强制转成默认的 100。<br>Skip 方法可以做到跳过首次查询的多少条数据来实现分页的功能。比如，一页显示10条数据，那么跳过前10个查询结果的方法就是：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="variable">Skip</span> (<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>对应数据的排序，如数字或字符串，你可以使用升序或降序的方式来控制查询数据的结果顺序：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 age 字段升序显示数据</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.OrderBy(<span class="string">"age"</span>);</span><br><span class="line"><span class="comment">// 根据 age 字段降序显示数据</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.OrderByDescending(<span class="string">"age"</span>);</span><br><span class="line"><span class="comment">//各种不同的比较查询：</span></span><br><span class="line"><span class="comment">// 年龄 &lt; 37</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereLessThan(<span class="string">"age"</span>, 37);</span><br><span class="line"><span class="comment">// 年龄 &lt;= 37</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereLessThanOrEqualTo(<span class="string">"age"</span>, 37);</span><br><span class="line"><span class="comment">// 年龄 &gt; 37</span></span><br><span class="line"><span class="keyword">query</span>.WhereGreaterThan(<span class="string">"age"</span>, 37);</span><br><span class="line"><span class="comment">// 年龄 &gt;= 37</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereGreaterThanOrEqualTo(<span class="string">"age"</span>, 37);</span><br></pre></td></tr></table></figure>
<p>如果你想查询匹配几个不同值的数据，如：要查询 “peter”，“neal”，“alex” 三个人的详细数据，你可以使用 WhereContainedIn（类似 SQL 中的 in 查询）方法来实现。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> names = new[] &#123; <span class="string">"peter"</span>, <span class="string">"neal"</span>, <span class="string">"alex"</span> &#125;;</span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereContainedIn(<span class="string">"name"</span>, names);</span><br></pre></td></tr></table></figure>
<p>相反，你想查询排除 “peter”，“neal”，“alex” 这三个人的其他同学的信息（类似 SQL 中的 not in 查询），你可以使用 WhereNotContainedIn 方法来实现。</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="variable">WhereNotContainedIn</span> (<span class="string">"name"</span>, names);</span><br></pre></td></tr></table></figure>
<p>对字符串值的查询 查询包含字符串的值，有几种方法。你可以使用任何正确的正则表达式来检索相匹配的值，使用 WhereMatches 方法：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="variable">WhereMatches</span>(<span class="string">"name"</span>, <span class="string">"^[A-Z]\\d"</span>);</span><br></pre></td></tr></table></figure>
<p>查询字符串中包含“XX“内容，可用如下方法：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询 name 字段的值中包含 “pet” 字的数据</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereContains(<span class="string">"name"</span>, <span class="string">"pet"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询 name 字段的值是以 “al” 字开头的数据</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereStartsWith(<span class="string">"name"</span>, <span class="string">"al"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询 name 字段的值是以 “oz” 字结尾的数据</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereEndsWith(<span class="string">"name"</span>, <span class="string">"oz"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="数组值的查询">数组值的查询</h3><p>如果一个 Key 对应的值是一个数组，你可以查询 key 的数组包含了数字 2 的所有对象:</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查找出所有arrayKey对应的数组同时包含了数字2的所有对象</span></span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereEqualTo(<span class="string">"arrayKey"</span>, 2);</span><br></pre></td></tr></table></figure>
<p>同样，你可以查询出 Key 的数组同时包含了 2,3 和 4 的所有对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查找出所有arrayKey对应的数组同时包含了数字2,3,4的所有对象。</span></span><br><span class="line">List&lt;<span class="keyword">int</span>&gt; numbers = <span class="keyword">new</span> List&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">numbers.Add(<span class="number">2</span>);</span><br><span class="line">numbers.Add(<span class="number">3</span>);</span><br><span class="line">numbers.Add(<span class="number">4</span>);</span><br><span class="line">query = query.WhereContainsAll(<span class="string">"arrayKey"</span>, numbers);</span><br></pre></td></tr></table></figure>
<h3 id="查询对象个数">查询对象个数</h3><p>如果你只是想统计有多少个对象满足查询，你并不需要获取所有匹配的对象，可以直接使用 <code>CountAsync</code> 替代 <code>FindAsync</code>。例如，查询一部电视剧里面一共有多个角色：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.WhereNotEqualTo (<span class="string">"from"</span>, <span class="string">"White Collar"</span>);</span><br><span class="line">await <span class="keyword">query</span>.CountAsync().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    int <span class="keyword">count</span> = t.Result;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>对于超过 1000 个对象的查询，这种计数请求可能被超时限制。他们可能遇到超时错误或者返回一个近似的值。因此，请仔细设计你的应用架构来避免依赖这种计数查询。</code></p>
<p><em>查询数量限定的方法’Limit(int)’在CountAsync中不会生效。</em></p>
<h3 id="关系查询">关系查询</h3><p>LeanCloud 支持用关系 <code>AVRelation</code> 关联 2 个对象，当然也支持用关系查询来获取相关联的对象。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVObject</span> girlType = new <span class="built_in">AVObject</span> (<span class="string">"GirType"</span>);</span><br><span class="line">girlType [<span class="string">"typeName"</span>] = <span class="string">"Hot"</span>;</span><br><span class="line">girlType [<span class="string">"ageMax"</span>] = <span class="number">27</span>;</span><br><span class="line">girlType [<span class="string">"ageMin"</span>] = <span class="number">18</span>;</span><br><span class="line"><span class="built_in">AVObject</span> beckham = new <span class="built_in">AVObject</span> (<span class="string">"Boy"</span>);</span><br><span class="line">beckham[<span class="string">"name"</span>]=<span class="string">"David Beckham"</span>;</span><br><span class="line">beckham [<span class="string">"age"</span>] = <span class="number">38</span>;</span><br><span class="line">beckham [<span class="string">"focusType"</span>] = girlType;</span><br><span class="line"><span class="comment">//保存beckham的时候会自动将girlType也保存到服务器。</span></span><br><span class="line">Task saveTask = beckham<span class="variable">.SaveAsync</span> ()<span class="variable">.ContinueWith</span> (t =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; boyQuery=new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"Boy"</span>);</span><br><span class="line">		boyQuery = boyQuery<span class="variable">.WhereEqualTo</span>(<span class="string">"focusType"</span>, girlType);</span><br><span class="line">		boyQuery<span class="variable">.FindAsync</span>()<span class="variable">.ContinueWith</span>(s=&gt;</span><br><span class="line">		&#123;</span><br><span class="line">			IEnumerable&lt;<span class="built_in">AVObject</span>&gt; boys = s<span class="variable">.Result</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>
<p>关系的内嵌查询可以帮助开发者用简洁的代码处理复杂的关系内嵌查询，比如要查询<code>查询所有关注了年龄小于27岁女生类型的那些男生们</code>：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; girlTypeQuery=new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"GirType"</span>);<span class="comment">//</span></span><br><span class="line">girlTypeQuery = girlTypeQuery<span class="variable">.WhereLessThan</span> (<span class="string">"ageMax"</span>, <span class="number">27</span>);<span class="comment">//年龄小于27的萌妹纸</span></span><br><span class="line"><span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt; query = new <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;(<span class="string">"Boy"</span>);</span><br><span class="line">query = query<span class="variable">.WhereMatchesQuery</span> (<span class="string">"focusType"</span>, girlTypeQuery);<span class="comment">//找出喜欢这些类型的男生们</span></span><br></pre></td></tr></table></figure>
<p>请注意，默认的 limit 限制 100 也同样作用在内嵌查询上。因此如果是大规模的数据查询，你可能需要仔细构造你的查询对象来获取想要的行为。反之，不想匹配某个子查询，你可以使用 <code>WhereDoesNotMatchQuery</code> 方法，代码不再敖述。</p>
<p>查询已经选择了喜欢的类型的男生，并且是限定在最近 10 个加入系统的男生，可以如此做：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AVQuery&lt;AVObject&gt; <span class="keyword">query</span> = new AVQuery&lt;AVObject&gt;(<span class="string">"Boy"</span>);</span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.OrderByDescending(<span class="string">"createdAt"</span>);</span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.Limit(10);</span><br><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="keyword">Include</span>(<span class="string">"focusType"</span>);</span><br></pre></td></tr></table></figure>
<p>你可以使用 dot（英语句号:”.”）操作符来多层 Include 内嵌的对象。比如，你还想进一步获取 <code>GirType</code> 所关联的女生（就是那些标明了自己隶属于这个类型的女生）：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">query</span> = <span class="keyword">query</span>.<span class="keyword">Include</span>(<span class="string">"focusType.girls"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="CQL_查询">CQL 查询</h3><p>Cloud Query Language（简称 CQL） 是 LeanCloud 为查询 API 定制的一套类似 SQL 查询语法的子集和变种，主要目的是降低大家学习 LeanCloud 查询的 API 的成本，可以使用传统的 SQL 语法来查询 LeanCloud 应用内的数据。</p>
<p>在 .NET 中调用 CQL 查询很便捷，在 <code>AVQuery</code> 中有一个 <code>DoCloudQuery</code> 的静态方法，可以直接传入 sql 语句即可实现查询，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">await <span class="built_in">AVQuery</span>&lt;<span class="built_in">AVObject</span>&gt;<span class="variable">.DoCloudQuery</span>(<span class="string">"select * from Character where age=37"</span>);</span><br></pre></td></tr></table></figure>
<p>如此做即可，其后续的操作与以前习惯的 <code>AVQuery</code> 其他查询一样，只是我们提供了另一种方式便于长期累积关系型数据库知识的开发者可以迅速迁移到 LeanCloud 上，CQL 的语法和详细用法可以参照：<a href="./cql_guide.html">CQL 详细指南</a></p>
<h4 id="CQL_查询占位符">CQL 查询占位符</h4><h2 id="用户">用户</h2><p>移动互联时代，把握住用户是核心的价值，任何一款APP都或多或少需要了解用户并且可能为用户建立一定的关系。例如，在社交软件中最基本就是要求用户注册和登录，哪怕是利用第三方（微博，QQ）API登录，都应该为用户在当前系统中再注册一次。LeanCloud已经在SDK中内嵌了关于用户这个较为特殊的对象的一些最基本的操作和数据服务。</p>
<h3 id="注册">注册</h3><p>注册用户在LeanCloud SDK中极为简单，看如下实例代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> userName</span> = <span class="string">"demoUser"</span>;</span><br><span class="line"><span class="variable"><span class="keyword">var</span> pwd</span> = <span class="string">"avoscloud"</span>;</span><br><span class="line"><span class="variable"><span class="keyword">var</span> email</span> = <span class="string">"xxx@xxx.com"</span>;</span><br><span class="line"><span class="variable"><span class="keyword">var</span> user</span> = new AVUser();</span><br><span class="line">user.Username = userName;</span><br><span class="line">user.Password = pwd;</span><br><span class="line">user.Email = email;</span><br><span class="line">await user.SignUpAsync().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="variable"><span class="keyword">var</span> uid</span> = user.ObjectId;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以上代码就可以很快的注册为当前的应用注册一个用户，并且这个用户也会有一个唯一的<code>ObjectId</code>。<br><strong>用户的密码在数据管理界面是无法显示的，这是因为服务端存储的并不是明文，是通过不可逆的特殊算法加密后的字符串</strong></p>
<h3 id="手机号注册">手机号注册</h3><p>为了适应移动互联时代的需求，我们特地增加了手机号注册的功能，当然前提是会进行短信认证，就如同微信一样，注册的时候会发送6位数字的验证码到用户输入的手机上，然后再回调我们的验证接口就可以完成一次手机号的注册。<br>在<a href="/app.html?appid=#/permission">应用设置</a>可以开启这一个功能。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">验证注册用户手机号码</span><br><span class="line">允许用户使用手机短信登录</span><br></pre></td></tr></table></figure>
<p>如下一个简单的案例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一步先注册</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> AVUser();</span><br><span class="line">user.Username = <span class="string">"WPUser"</span>;</span><br><span class="line">user.Password = <span class="string">"avoscloud"</span>;</span><br><span class="line">user.MobilePhoneNumber = <span class="string">"18688888888"</span>;</span><br><span class="line"><span class="keyword">var</span> task= user.SignUpAsync ();</span><br><span class="line"><span class="keyword">await</span> task；</span><br><span class="line"><span class="comment">//如此做，短信就会发送到指定的手机号</span></span><br></pre></td></tr></table></figure>
<p>以上完成之后，需要给用户一个输入界面，让用户输入收到的6位数字的验证码，然后再运行如下代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二步回调认证</span></span><br><span class="line"><span class="variable"><span class="keyword">var</span> task</span> = AVUser.VerifyMobilePhoneAsync(code);<span class="comment">//code代表6位数字的验证码</span></span><br><span class="line">await task.ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable"><span class="keyword">var</span> success</span>= t.Result;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以上两步，就是一个完整的手机号注册流程。</p>
<h3 id="登录">登录</h3><p>登录是一个<code>AVUser</code>的静态方法，通过如下代码可以实现登录，登录之后，SDK会默认将此次登录的用户设置为<code>AVUser.CurrentUser</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> userName</span> = <span class="string">"demoUser"</span>;</span><br><span class="line"><span class="variable"><span class="keyword">var</span> pwd</span> = <span class="string">"avoscloud"</span>;</span><br><span class="line">await AVUser.LogInAsync(userName, pwd).ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (t.IsFaulted || t.IsCanceled)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="variable"><span class="keyword">var</span> error</span> = t.Exception.Message; <span class="comment">// 登录失败，可以查看错误信息。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">//登录成功</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="手机号和密码登录">手机号和密码登录</h4><p>在短信服务上线之后，只要是<code>通过认证</code>的手机号可以当做用户名在 LeanCloud 服务端进行登录，自然SDK里面也加入了相应的支持(WP SDK 自V1.1.0以及以后的版本都有支持)。它的调用与用户名登录一样，只是方法名字不一样，代码如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">await <span class="built_in">AVUser</span><span class="variable">.LogInByMobilePhoneNumberAsync</span> (mobilePhone, password)<span class="variable">.ContinueWith</span> (t =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">			<span class="built_in">AVUser</span> user=t<span class="variable">.Result</span>;</span><br><span class="line">			<span class="comment">//这里可以拿到登录之后的AVUser，但是实际上AVUser.CurrentUser已经是当前登录的用户了。</span></span><br><span class="line">			<span class="comment">//这里提供返回值是为了使链式表达式脱离对全局变量的依赖，当然大部分情况下AVUser.CurrentUser应该已经可以满足一般的需求。</span></span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="手机号和短信验证码登录">手机号和短信验证码登录</h4><p>在对客户端验证要求比较高的应用里面，也许有些应用要求支持短信随机的验证码作为临时的密码登录，这个应用场景在现在已经被普遍的采用了，这种验证机制被认为是安全性高的一种机制，自然 LeanCloud 也给予了支持。它比前2种静态登录的方法多了<code>发送短信验证码</code>这一步，具体代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一步，请求服务端发送6为数字的验证码到指定mobilePhoneNumber上。</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">await</span> AVUser.RequestLoginSmsCodeAsync(mobilePhoneNumber).ContinueWith(t =&gt;</span><br><span class="line">       &#123;</span><br><span class="line">			<span class="keyword">var</span> success=t.Result;</span><br><span class="line">			<span class="comment">//判断返回值可以判断是否发送成功，不成功会抛出带有error的AVException，并且t.Result会被置为false.</span></span><br><span class="line">			<span class="comment">//在处理这种容易因为用户输入不合法而产生的异常的时候，为了保证程序的正常运行，建议使用try/catch机制进行提前的异常处理。</span></span><br><span class="line">		&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(AVException avException)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二步，直接使用验证码登录，如果验证码输入错误也会抛出异常。</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">await</span> AVUser.LoginBySmsCodeAsync (mobilePhoneNumber, code).ContinueWith(t=&gt;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">var</span> success=t.Result;</span><br><span class="line">		&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(AVException avException)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="邮箱认证">邮箱认证</h3><p>在移动互联时代，任何一个用户信息都是必须在双方统一认证之后才会被视为一种安全机制，比如邮箱的认证，同样，在<code>AVUser</code>这个特殊的<code>AVObject</code>拥有一个特殊字段<code>email</code>，可以在<a href="/data.html?appid=&lt;!--￼74--">数据管理</a>的<code>_User</code>表看到这个默认的字段，这就是在注册是提供的邮箱，当在<a href="/app.html?appid=#/permission">应用设置</a>中勾选了</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启用注册用户邮箱验证</span><br></pre></td></tr></table></figure>
<p>这样在注册用户的时候，LeanCloud默认就会发送一封邮件，进行验证，邮件的模板也可以在<a href="/app.html?appid=#/email">邮件模板</a>中进行设置。</p>
<p>注意，验证过的用户，TA的<code>emailVerified</code>将会置成<code>true</code>，反之<code>false</code>，但是如果<strong>未启用注册用户邮箱验证</strong>，这个字段会为空。</p>
<h3 id="手机号认证">手机号认证</h3><p>相对于邮箱认证，手机号认证的过程稍微需要多一点代码，如果当您的应用在注册的时候没有开启短信验证，伴随业务发展，发现需要验证用户的手机，LeanCloud 正好提供了这一接口。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用的前提是，改手机号已经与已存在的用户有关联(_User表中的mobilePhoneNumber即可关联手机，至于如何关联取决于客户端的业务逻辑)</span></span><br><span class="line"><span class="tag">await</span> <span class="tag">AVUser</span><span class="class">.RequestMobilePhoneVerifyAsync</span> (<span class="string">"18688888888"</span>)<span class="class">.ContinueWith</span>(t=&gt;</span><br><span class="line">		&#123;</span><br><span class="line">		   <span class="comment">//这样就成功的发送了验证码</span></span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<p>回调认证的接口与<code>手机号注册</code>小节的第二步一样。</p>
<p>验证成功后，用户的<code>mobilePhoneVerified</code>属性变为true，并且调用云引擎的<code>AV.Cloud.onVerifed(&#39;sms&#39;, function)</code>方法。</p>
<p><strong>以上只是针对_User表的一个属性mobilePhoneNumber进行验证，但是存在另一种需求，类似于支付宝在进行交易的时候会要求进行实时的短信认证，这一机制现在已经普遍存在于各种应用中进行敏感操作的首选，并不局限于注册登录这种通用功能，LeanCloud 也提供了这一机制</strong></p>
<h4 id="手机短信针对应用自定义操作的验证">手机短信针对应用自定义操作的验证</h4><p><code>AVCloud</code>类包含了相关的静态方法，实例如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一步，先请求发送，如果手机号无效则会发送失败。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RequestSMSCode</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> task=AVCloud.RequestSMSCode (<span class="string">"18688888888"</span>).ContinueWith(t=&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(t.Result)</span><br><span class="line">		&#123;</span><br><span class="line">			msg=<span class="string">"sent!"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">    <span class="keyword">await</span> task；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果开发者想简单地自定义短信的内容，可以调用另外一个版本，如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RequestSMSCodeWithCustomParameters</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> task=AVCloud.RequestSMSCode (<span class="string">"18688888888"</span>,<span class="string">"PP打车"</span>,<span class="string">"叫车服务"</span>,<span class="number">8</span>).ContinueWith(t=&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">if</span>(t.Result)</span><br><span class="line">	    &#123;</span><br><span class="line">	      msg=<span class="string">"sent!"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">    <span class="keyword">await</span> task；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户就会收到如下短信：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">您正在使用 PP打车 服务进行 叫车服务，您的验证码是<span class="number">012345</span>，请在<span class="number">8</span>分钟之内完成验证。</span><br></pre></td></tr></table></figure>
<p>以上是调用发送，下一步就是验证。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">VerifySMSCode</span>(<span class="params"><span class="keyword">string</span> mobileNumber,<span class="keyword">string</span> code</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> task=AVCloud.VerifySmsCode (mobileNumber,code).ContinueWith(t=&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(t.Result)</span><br><span class="line">		&#123;</span><br><span class="line">			msg=<span class="string">"verified"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			msg=<span class="string">"valid code"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">    <span class="keyword">await</span> task；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="语音短信验证码">语音短信验证码</h5><p>文本短信验证码在到达率上有一定的风险，尽管经过我们长期得到的用户反馈，到达率已接近 100%，但是有些应用的时效性和安全性要求极高，所以我们也推出了语音短信验证码的服务，调用的方式如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">await AVCloud.<span class="title">RequestVoiceCode</span> <span class="params">(<span class="string">"18688888888"</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>发送成功之后，用户的手机就会收到一段语音通话，它会播报 6 位数的验证码，然后开发者需要再次调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVCloud<span class="class">.VerifySmsCode</span> (<span class="string">"18688888888"</span>,<span class="string">"012345"</span>)</span><br></pre></td></tr></table></figure>
<p>再次验证用户输入的验证码是否正确。</p>
<p>目前语音短信验证码仅支持大陆的手机号（移动，电信，联通全面覆盖）。</p>
<h3 id="当前用户">当前用户</h3><p>诚如所有移动应用一样当前用户一直是被在客户端视作持久化存储处理，比如手机QQ等流行的App，LeanCloud必然也会如此为开发者解决持久化存储当前用户，只要调用了<code>登录</code>相关的接口，当前用户就会被持久化存储在客户端。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> user</span> = AVUser.CurrentUser;</span><br></pre></td></tr></table></figure>
<p>如果调用了登出借口，那么当前用户就会被清除，并置为<code>null</code>：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> AVUser.LogOut();</span><br><span class="line"><span class="keyword">var</span> user = AVUser.CurrentUser;	<span class="comment">//如此做就会抛出异常，因为登出之后，CurrentUser已经为空。</span></span><br></pre></td></tr></table></figure></p>
<h3 id="重置密码">重置密码</h3><h4 id="邮箱重置">邮箱重置</h4><p>密码管理一直是移动应用的比较通用又比较繁琐的事情，LeanCloud也为开发者提供了一套通用的解决方案，将开发者从繁琐中解脱出来。<br>当用户忘记密码的时候，开发者完全可以在客户端做一个简单的按钮，然后做一些友好的页面，但是真正实现重置密码的功能只需要如下一段代码：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">await</span> <span class="tag">AVUser</span><span class="class">.RequestPasswordResetAsync</span>(<span class="tag">user</span><span class="class">.Email</span>);</span><br></pre></td></tr></table></figure></p>
<p>这样服务端就会再次发送重置密码的邮件，开发者只要引导用户登录邮箱，进行操作就完成了。</p>
<h4 id="短信验证码重置">短信验证码重置</h4><p>如果用户的手机是有效地，并且已经通过了验证码验证手机的有效性，那么开发者可以提供另一种在手机上体验较好的方式：通过短信验证码重置密码。具体实例如下：<br>首先，需要发送一个请求到服务端去发送6位数的验证码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> smsCodeResetPasswordTask =	AVUser.RequestPasswordResetBySmsCode (<span class="string">"138012345678"</span>);<span class="comment">//只需要手机号即可，服务端会自动寻找与之匹配的用户，如果没有用户与此手机号绑定，将会提示错误信息。</span></span><br><span class="line"><span class="keyword">await</span> smsCodeResetPasswordTask；</span><br></pre></td></tr></table></figure>
<p>发送之后，再给一个界面给用户，让用户输入6位数的短信验证码，并且同时输入新的密码，然后如下调用：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resetTask = AVUser.ResetPasswordBySmsCode(NewPassword,SMSCode);<span class="comment">//第一个参数是新密码（明文传递，请放心我们传输的时候做了加密，并且在服务端也绝不可能明文存储），第二个参数是上一步发送到用户手机的6位数验证码。</span></span><br><span class="line"><span class="keyword">await</span> resetTask；</span><br></pre></td></tr></table></figure>
<p>这样2步就可以重置密码，这项功能我们建议在一些应用内操作比较频繁的应用使用，邮箱重置的话可能需要用户去单独打开一个邮箱应用或者用浏览器跳转。</p>
<h3 id="查询用户">查询用户</h3><p><strong>请注意，新创建应用的 <code>_User</code> 表的查询权限默认是关闭的，通常我们推荐你在云引擎里封装用户查询，只查询特定条件的用户，避免开放用户表的全部查询权限。此外，你可以通过 class 权限设置打开查询权限，请参考 <a href="data_security.html#Class_级别的权限">数据与安全 - Class 级别的权限</a>。</strong></p>
<p>用户既然是个特殊的 <code>AVObject</code>，它当然也具备了 <code>AVObject</code> 的一些共同特性，很多场景下，关于用户的操作，首先就是通过条件查询，把符合特定条件的用户查询到客户端进行展现或者一些修改之类的操作。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">await <span class="built_in">AVUser</span><span class="variable">.Query</span><span class="variable">.WhereEqualTo</span>(<span class="string">"gender"</span>, <span class="string">"female"</span>)<span class="variable">.FindAsync</span>()<span class="variable">.ContinueWith</span>(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">     IEnumerable&lt;<span class="built_in">AVUser</span>&gt; women = t<span class="variable">.Result</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当然，也可以通过<code>GetAsync</code>方法通过<code>objectId</code>获取特定的一个<code>AVUser</code>。</p>
<h3 id="用户安全数据的认证规则">用户安全数据的认证规则</h3><p>很多时候，就算是开发者也不要轻易修改用户的基本信息，比如用户的一些比较敏感的个人信息，例如手机号，社交账号等，这些都应该让用户在App中自行修改，所以为了用户数据的数据有且仅有自己在登录的情况下得以修改，LeanCloud服务端对所有针对 <code>AVUser</code> 对象的数据做了验证。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AVUser user = <span class="keyword">null</span>;</span><br><span class="line">await AVUser.LogInAsync(<span class="string">"demoUser"</span>, <span class="string">"asvscloud"</span>).ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    user = t.Result;</span><br><span class="line">    user.Username = <span class="string">"testUser"</span>; <span class="comment">// 修改用户名</span></span><br><span class="line">    <span class="keyword">return</span> user.SaveAsync();</span><br><span class="line">&#125;).Unwrap().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t.IsFaulted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 在登录之后，提交修改用户相关字段（密码除外），都会成功。</span></span><br><span class="line">        AVUser.LogOut();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过Id获取这个用户，注：如此做并未使当前用户登录。</span></span><br><span class="line">    <span class="keyword">return</span> AVUser.Query.GetAsync(user.ObjectId);</span><br><span class="line">&#125;).Unwrap().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    user = t.Result;</span><br><span class="line">    user.Username = <span class="string">"devUser"</span>;</span><br><span class="line">    <span class="keyword">return</span> user.SaveAsync();</span><br><span class="line">&#125;).Unwrap().ContinueWith(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (t.IsFaulted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显然，如此做就会失败，因为单单从Id获取用户，当前的请求不具备权限去修改这个用户的相关属性。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="ACL_权限控制">ACL 权限控制</h2><p>任何一个成熟的并且可控的系统中，必然会存在权限控制的问题，经典的案例就是论坛的斑竹可以删帖而普通游客只能看帖，如此一来，发展出来的<a href="http://zh.wikipedia.org/wiki/%E4%BB%A5%E8%A7%92%E8%89%B2%E7%82%BA%E5%9F%BA%E7%A4%8E%E7%9A%84%E5%AD%98%E5%8F%96%E6%8E%A7%E5%88%B6" target="_blank" rel="external">基于角色的访问控制</a>被普遍应用于各类传统的软件中，即便是互联网时代的今天，它依然是可以很简便地帮助开发者以及使用者理解和应用。</p>
<p>基于以上这一点，LeanCloud在开发者创建一个应用的时候，默认地在服务端为该应用添加了一张<code>_Role</code>的表，开发者可以在<a href="/data.html?appid=&lt;!--￼77--">数据管理</a>中看到这张表。</p>
<h3 id="默认访问权限">默认访问权限</h3><p>在没有显式指定的情况下，LeanCloud 中的每一个对象都会有一个默认的 ACL 值。这个值代表了，所有的用户，对这个对象都是可读可写的。此时你可以在数据管理的表中 ACL 属性中看到这样的值:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">*</span>":<span class="value">&#123;"<span class="attribute">read</span>":<span class="value"><span class="literal">true</span></span>,"<span class="attribute">write</span>":<span class="value"><span class="literal">true</span></span>&#125;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>在.NET SDK中创建符合默认的开放读写权限的<code>AVACL</code>的代码如下：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defaultACL = <span class="keyword">new</span> AVACL();</span><br><span class="line">defaultACL.PublicWriteAccess = <span class="literal">true</span>;</span><br><span class="line">defaultACL.PublicReadAccess = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="指定用户访问权限">指定用户访问权限</h3><p>当一个用户在实现一个网盘类应用时，针对不同文件的私密性，用户就需要不同的文件访问权限。 譬如公开的文件，每一个其他用户都有读的权限，然后仅仅只有创建者才拥有更改和删除的权限。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] data = System.Text.Encoding.UTF8.GetBytes(<span class="string">"AVOSCloud is a great cloud service!"</span>);</span><br><span class="line">AVFile file = <span class="keyword">new</span> AVFile(<span class="string">"mytxtFile.txt"</span>, data, <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;<span class="string">"author"</span>,<span class="string">"AVOSCloud"</span>&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">AVObject book = <span class="keyword">new</span> AVObject(<span class="string">"book"</span>);</span><br><span class="line">book[<span class="string">"content"</span>] = file;</span><br><span class="line"></span><br><span class="line">AVACL acl = <span class="keyword">new</span> AVACL();</span><br><span class="line">acl.PublicReadAccess = <span class="keyword">true</span>;</span><br><span class="line">acl.SetWriteAccess(AVUser.CurrentUser, <span class="keyword">true</span>);</span><br><span class="line">book.ACL = acl;</span><br><span class="line"><span class="keyword">await</span> book.SaveAsync();</span><br></pre></td></tr></table></figure>
<h3 id="指定角色访问权限">指定角色访问权限</h3><h4 id="角色">角色</h4><p><code>AVRole</code>拥有一些默认的属性，当然它也是一个<code>AVObject</code>，自然开发者也可以为角色添加业务逻辑所需的字段。</p>
<ul>
<li><code>name</code> :<code>string</code>类型，角色的名称，并且这是创建角色的<code>必须字段</code>，并且<code>唯一</code>，并且只在创建时赋值，不能被<code>修改</code>，命名必须由字母，连接符，下划线组成，这个字段可视为主键。</li>
<li><code>users</code> :<code>AVACL</code>类型，它指向所有拥有（即<code>单用户可以拥有多角色</code>的系统）这个<code>角色</code>的用户。</li>
<li><code>roles</code> :<code>AVACL</code>类型，它指向所有该角色的子角色，<code>子角色自动继承父角色的所有权限</code>。关于这一点下一节会做详细阐述。</li>
</ul>
<h4 id="AVUser_与_AVRole_的从属关系">AVUser 与 AVRole 的从属关系</h4><p>指定用户访问权限虽然很方便，但是依然会有局限性。 以工资系统为例，一家公司的工资系统，工资最终的归属者和公司的出纳们只拥有工资的读权限，而公司的人事和老板才拥有全部的读写权限。当然你可以通过多次设置指定用户的访问权限来实现这一功能（多个用户的 ACL 设置是追加的而非覆盖）。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVObject</span> salary = new <span class="built_in">AVObject</span>(<span class="string">"salary"</span>);</span><br><span class="line">salary[<span class="string">"value"</span>] = <span class="number">2000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">AVUser</span> boss=new <span class="built_in">AVUser</span>();<span class="comment">//假设此处为老板</span></span><br><span class="line"><span class="built_in">AVUser</span> hrWang=new <span class="built_in">AVUser</span>();  <span class="comment">//人事小王</span></span><br><span class="line"><span class="built_in">AVUser</span> me = new <span class="built_in">AVUser</span>(); <span class="comment">//我们就在文档里爽一爽吧</span></span><br><span class="line"><span class="built_in">AVUser</span> cashierZhou = new <span class="built_in">AVUser</span>(); <span class="comment">//出纳老周</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">AVACL</span> acl = new <span class="built_in">AVACL</span>();</span><br><span class="line">acl<span class="variable">.SetReadAccess</span>(boss, <span class="literal">true</span>);</span><br><span class="line">acl<span class="variable">.SetReadAccess</span>(hrWang, <span class="literal">true</span>);</span><br><span class="line">acl<span class="variable">.SetReadAccess</span>(me, <span class="literal">true</span>);</span><br><span class="line">acl<span class="variable">.SetReadAccess</span>(cashierZhou, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">acl<span class="variable">.SetWriteAccess</span>(boss, <span class="literal">true</span>);</span><br><span class="line">acl<span class="variable">.SetWriteAccess</span>(hrWang, <span class="literal">true</span>);</span><br><span class="line">salary<span class="variable">.ACL</span> = acl;</span><br><span class="line">await salary<span class="variable">.SaveAsync</span>();</span><br></pre></td></tr></table></figure>
<p>但是这些涉及其中的人可能不止一个，也有离职换岗新员工的问题存在。这样的代码既不优雅，也太啰嗦, 同样会很难维护。 这个时候我们就引入了 <code>AVRole</code> 来解决这个问题。 公司的员工可以成百上千，然而一个公司组织里的角色却能够在很长一段时间时间内相对稳定。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVObject</span> salary = new <span class="built_in">AVObject</span>(<span class="string">"salary"</span>);</span><br><span class="line">salary[<span class="string">"value"</span>] = <span class="number">2000000</span>;</span><br><span class="line"></span><br><span class="line">var roleACL = new <span class="built_in">AVACL</span>();</span><br><span class="line">roleACL<span class="variable">.PublicReadAccess</span> = <span class="literal">true</span>;<span class="comment">//AVRole本身在创建之后，就尽量避免它被修改，这里是为了设定AVRole自身的ACL访问限制。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下这些角色只为示意，如要正确执行本段代码，以下这些AVUser必须是已经存在于服务端的数据。</span></span><br><span class="line"><span class="built_in">AVUser</span> boss = new <span class="built_in">AVUser</span>();<span class="comment">//假设此处为老板</span></span><br><span class="line"><span class="built_in">AVUser</span> hrWang = new <span class="built_in">AVUser</span>();  <span class="comment">//人事小王</span></span><br><span class="line"><span class="built_in">AVUser</span> me = new <span class="built_in">AVUser</span>(); <span class="comment">//我们就在文档里爽一爽吧</span></span><br><span class="line"><span class="built_in">AVUser</span> cashierZhou = new <span class="built_in">AVUser</span>(); <span class="comment">//出纳老周</span></span><br><span class="line"><span class="built_in">AVUser</span> cashierGe = new <span class="built_in">AVUser</span>();<span class="comment">//出纳小葛</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">AVRole</span> hr = new <span class="built_in">AVRole</span>(<span class="string">"hr"</span>, roleACL);</span><br><span class="line"><span class="built_in">AVRole</span> cashier = new <span class="built_in">AVRole</span>(<span class="string">"cashier"</span>, roleACL);</span><br><span class="line"></span><br><span class="line">hr<span class="variable">.Users</span><span class="variable">.Add</span>(hrWang);</span><br><span class="line"></span><br><span class="line">cashier<span class="variable">.Users</span><span class="variable">.Add</span>(cashierZhou);</span><br><span class="line">cashier<span class="variable">.Users</span><span class="variable">.Add</span>(cashierGe);</span><br><span class="line"></span><br><span class="line">var saveUsersTask = new List&lt;Task&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;hr<span class="variable">.SaveAsync</span>()&#125;,</span><br><span class="line">    &#123;cashier<span class="variable">.SaveAsync</span>()&#125;</span><br><span class="line">&#125;;</span><br><span class="line">await Task<span class="variable">.WhenAll</span>(saveUsersTask)<span class="variable">.ContinueWith</span>(t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">AVACL</span> acl = new <span class="built_in">AVACL</span>();</span><br><span class="line">    acl<span class="variable">.SetReadAccess</span>(boss, <span class="literal">true</span>);</span><br><span class="line">    acl<span class="variable">.SetReadAccess</span>(me, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    acl<span class="variable">.SetRoleReadAccess</span>(hr, <span class="literal">true</span>);</span><br><span class="line">    acl<span class="variable">.SetRoleReadAccess</span>(cashier,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    acl<span class="variable">.SetWriteAccess</span>(boss, <span class="literal">true</span>);</span><br><span class="line">    acl<span class="variable">.SetRoleWriteAccess</span>(hr, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    salary<span class="variable">.ACL</span> = acl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> salary<span class="variable">.SaveAsync</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="AVRole_之间的从属关系">AVRole 之间的从属关系</h4><p>在讲清楚了用户与角色的关系后，我们还有一层角色与角色之间的关系。用下面的例子来理解可能会对我们有所帮助：</p>
<p>一家创业公司有移动部门，部门下面有不同的小组，Android 和 iOS。而每个小组只拥有自己组的代码的读写权限。但是他们同时拥有核心库代码的读取权限。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> roleACL = <span class="keyword">new</span> AVACL();</span><br><span class="line">roleACL.PublicReadAccess = <span class="keyword">true</span>;<span class="comment">//AVRole本身在创建之后，就尽量避免它被修改，这里是为了设定AVRole自身的ACL访问限制。</span></span><br><span class="line"></span><br><span class="line">AVRole androidTeam = <span class="keyword">new</span> AVRole(<span class="string">"androidTeam"</span>, roleACL);</span><br><span class="line">AVRole iOSTeam = <span class="keyword">new</span> AVRole(<span class="string">"iOSTeam"</span>, roleACL);</span><br><span class="line">AVRole mobileDep = <span class="keyword">new</span> AVRole(<span class="string">"mobileDep"</span>, roleACL);</span><br><span class="line"></span><br><span class="line">AVObject androidCode = <span class="keyword">new</span> AVObject(<span class="string">"code"</span>);</span><br><span class="line">androidCode[<span class="string">"name"</span>] = <span class="string">"android"</span>;</span><br><span class="line"></span><br><span class="line">AVObject iOSCode = <span class="keyword">new</span> AVObject(<span class="string">"code"</span>);</span><br><span class="line">iOSCode[<span class="string">"name"</span>] = <span class="string">"ios"</span>;</span><br><span class="line"></span><br><span class="line">AVObject coreCode = <span class="keyword">new</span> AVObject(<span class="string">"code"</span>);</span><br><span class="line">coreCode[<span class="string">"name"</span>] = <span class="string">"core"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> saveTeamTasks = <span class="keyword">new</span> <span class="built_in">List</span>&lt;Task&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;androidTeam.SaveAsync()&#125;,</span><br><span class="line">        &#123;iOSTeam.SaveAsync()&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">await Task.WhenAll(saveTeamTasks).ContinueWith(t =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">     mobileDep.Roles.Add(androidTeam);</span><br><span class="line">     mobileDep.Roles.Add(iOSTeam);</span><br><span class="line">     <span class="keyword">return</span> mobileDep.SaveAsync();</span><br><span class="line"> &#125;).Unwrap().ContinueWith(s =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">var</span> saveCodeTasks = <span class="keyword">new</span> <span class="built_in">List</span>&lt;Task&gt;()</span><br><span class="line">     &#123;</span><br><span class="line">         &#123;androidCode.SaveAsync()&#125;,</span><br><span class="line">         &#123;iOSCode.SaveAsync()&#125;,</span><br><span class="line">         &#123;coreCode.SaveAsync()&#125;,</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">return</span> Task.WhenAll(saveCodeTasks);</span><br><span class="line"></span><br><span class="line"> &#125;).Unwrap().ContinueWith(x =&gt;</span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//androidCode的读写权限对androidTeam开放</span></span><br><span class="line">     androidCode.ACL.SetRoleReadAccess(androidTeam, <span class="keyword">true</span>);</span><br><span class="line">     androidCode.ACL.SetRoleWriteAccess(androidTeam, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//iOSCode的读写权限对iOSTeam开放</span></span><br><span class="line">     iOSCode.ACL.SetRoleReadAccess(iOSTeam, <span class="keyword">true</span>);</span><br><span class="line">     iOSCode.ACL.SetRoleWriteAccess(iOSTeam, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//coreCode对mobileDep开放读取权限，注意，mobileDep本身就已经包含了iOSTeam和androidTeam作为它的子角色</span></span><br><span class="line">     coreCode.ACL.SetRoleReadAccess(mobileDep, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> saveCodeTasks = <span class="keyword">new</span> <span class="built_in">List</span>&lt;Task&gt;()</span><br><span class="line">     &#123;</span><br><span class="line">         &#123;androidCode.SaveAsync()&#125;,</span><br><span class="line">         &#123;iOSCode.SaveAsync()&#125;,</span><br><span class="line">         &#123;coreCode.SaveAsync()&#125;,</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">return</span> Task.WhenAll(saveCodeTasks);</span><br><span class="line"> &#125;).Unwrap().ContinueWith(y =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="comment">//所有操作全部完成。</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="文件">文件</h2><h3 id="上传文件">上传文件</h3><p>AVFile可以让你的应用程序将文件存储到服务器中，比如常见的文件类型图像文件、影像文件、音乐文件和任何其他二进制数据都可以使用。<br>在这个例子中，我们将一段文本保存到服务器端：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] data = System.Text.Encoding.UTF8.GetBytes(“ LeanCloud <span class="keyword">is</span> a great cloud service!”);</span><br><span class="line">AVFile file = <span class="keyword">new</span> AVFile(<span class="string">"mytxtFile.txt"</span>, data, <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt;()</span><br><span class="line">&#123;</span><br><span class="line">&#123;<span class="string">"author"</span>,<span class="string">"AVOSCloud"</span>&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">await</span> file.SaveAsync().ContinueWith(</span><br><span class="line">    t =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!t.IsFaulted)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(file.ObjectId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, CancellationToken.None, TaskContinuationOptions.OnlyOnRanToCompletion, TaskScheduler.FromCurrentSynchronizationContext());</span><br></pre></td></tr></table></figure>
<p>AVFile构造函数的第一个参数指定文件名称，第二个构造函数接收一个byte数组，也就是将要上传文件的二进制，第三个参数是自定义元数据的字典，比如你可以把文件的作者的名字当做元数据存入这个字典，LeanCloud 的服务端会把它保留起来，这样在以后获取的时候，这种类似的自定义元数据都会被获取。</p>
<h3 id="本地文件">本地文件</h3><p>在.NET SDK中，如果很清楚地知道某一个文件所存在的路径，比如在游戏中上传一张游戏截图到LeanCloud中，可以通过SDK直接获取指定的文件，上传到LeanCloud中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">AVFile</span> localFile = <span class="built_in">AVFile</span><span class="variable">.CreateFileWithLocalPath</span>(<span class="string">"screenshot.PNG"</span>, Path<span class="variable">.Combine</span>(<span class="string">"&lt;Local Folder Path&gt;"</span>, <span class="string">"screenshot.PNG"</span>));</span><br></pre></td></tr></table></figure>
<p>之后的操作与上一节类似。</p>
<h3 id="文件元信息">文件元信息</h3><p>AVFile默认会存储文件大小和文件上传者objectId作为元信息。同样的，我们提供了一个字典接口帮助开发者可以未任意文件添加任意符合字典命名规则的自定义元数据。在本小节的第一个例子了已经为文件添加了一个自定义的元数据：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AVFile file = <span class="keyword">new</span> AVFile(<span class="string">"mytxtFile.txt"</span>, data, <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;<span class="string">"author"</span>,<span class="string">"AVOSCloud"</span>&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这个就是简单的用法，在创建文件的时候，可以指定一组字典去保留文件的自定义元数据。</p>
<p>你还可以在上传前自动一些元信息保存起来，以便后续获取，例如我们还保存图片的高度和宽度：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">file</span>.MetaData.Add(<span class="string">"width"</span>, <span class="number">100</span>);</span><br><span class="line"><span class="type">file</span>.MetaData.Add(<span class="string">"height"</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<h3 id="下载文件">下载文件</h3><p>下载文件其实跟获取单个普通对象一样，首先必须知道这个文件的<code>objectdId</code>，或者你可以通过条件查询先获取这个<code>objectdId</code>，然后调用<code>AVFile.GetFileWithObjectIdAsync</code>方法首先实例化文件对象，然后就可以下载：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">await AVFile.GetFileWithObjectIdAsync(<span class="string">"538ed669e4b0e335f6102809"</span>).ContinueWith(t =&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> <span class="keyword">file</span> = t.Result;</span><br><span class="line">       <span class="keyword">file</span>.DownloadAsync().ContinueWith(s =&gt;</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> dataByte = <span class="keyword">file</span>.DataByte;<span class="comment">//获取文件流的byte数组，之后可以做保存，发送等操作。</span></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="删除文件">删除文件</h3><p><strong>删除文件就意味着，执行之后在数据库中立刻删除记录，并且原始文件也会从存储仓库中删除（所有涉及到物理级别删除的操作请谨慎使用）</strong></p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">await  AVFile.GetFileWithObjectIdAsync("538ed<span class="number">669e4b0</span>e<span class="number">335f61028</span>09").ContinueWith(t =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">     var file = t.Result<span class="comment">;</span></span><br><span class="line">     file.DeleteAsync()<span class="comment">;</span></span><br><span class="line">  &#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h2 id="调用云引擎">调用云引擎</h2><p>云引擎是 LeanCloud 提供给开发者自定义服务端逻辑的解决方案，例如想在用户注册的时候，服务端统一给用户分配随机的昵称，这一操作就可以用云引擎实现。具体关于云引擎的一些相关概念和操作可以先查看 <a href="leanengine_guide-cloudcode.html">云引擎指南</a>。</p>
<p>调用云引擎在SDK中比较方便，它是 <code>AVCloud</code> 的静态方法，全局均可调用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt;();</span><br><span class="line">dic.Add(<span class="string">"name"</span>, <span class="string">"Justin"</span>);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//增加参数</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">var</span> callTask = AVCloud.CallFunctionAsync&lt;<span class="keyword">string</span>&gt;(<span class="string">"TestFunctionName"</span>, dic);</span><br><span class="line"><span class="keyword">await</span> callTask;</span><br></pre></td></tr></table></figure>
<p>只需要传入云引擎中函数的名字和这个函数需要参数即可，如果是无参的函数，直接传入<code>null</code>即可。</p>
<h2 id="自定义参数">自定义参数</h2><p>在控制台的<a href="/devcomponent.html?appid=#/component/custom_param">自定义参数设置</a>页面可以设置一些静态的全局共享的参数，他们都是键值对的格式，在 SDK 中提供了获取这些在线参数的方法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt; cp=<span class="keyword">await</span> AVCloud.GetCustomParameters();</span><br></pre></td></tr></table></figure>
<h2 id="消息推送">消息推送</h2><h3 id="推送给所有的设备">推送给所有的设备</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AVPush <span class="keyword">push</span> = <span class="keyword">new</span> AVPush();</span><br><span class="line"><span class="keyword">push</span>.Alert = <span class="string">"message to all devices."</span>;</span><br><span class="line">var <span class="keyword">task</span> = <span class="keyword">push</span>.SendAsync();</span><br><span class="line">await <span class="keyword">task</span>;</span><br></pre></td></tr></table></figure>
<p>以上这段代码就可以实现向所有安装了当前App的设备推送消息。</p>
<h3 id="发送给特定的用户">发送给特定的用户</h3><p>发送给public频道的用户：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AVPush <span class="keyword">push</span> = <span class="keyword">new</span> AVPush();</span><br><span class="line"><span class="keyword">push</span>.Alert = <span class="string">"message to public channel."</span>;</span><br><span class="line"><span class="keyword">push</span>.Query = <span class="keyword">new</span> AVQuery&lt;AVInstallation&gt;().WhereEqualTo(<span class="string">"channels"</span>, <span class="string">"public"</span>);</span><br><span class="line">var <span class="keyword">task</span> = <span class="keyword">push</span>.SendAsync();</span><br><span class="line">await <span class="keyword">task</span>;</span><br></pre></td></tr></table></figure>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/realtime_rest_api/" itemprop="url">
                实时通信 REST API 使用指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/realtime_rest_api/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/realtime_rest_api/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="实时通信_REST_API_使用指南">实时通信 REST API 使用指南</h1><h2 id="对话数据操作">对话数据操作</h2><p>你可以通过 REST API 对对话（相应的聊天室、群组或单聊等）进行操作，例如提前创建聊天室，关联聊天室到其他数据实体。LeanCloud 实时通信系统采用透明的设计，对话数据在 LeanCloud 系统中是普通的数据表，表名为 <code>_Conversation</code>，你可以直接调用 <a href="./rest_api.html#对象-1">数据存储相关的 API 进行数据操作</a>。<code>_Conversation</code> 表 包含一些内置的关键字段定义了对话的属性、成员等，你可以在 <a href="./realtime_v2.html#对话_Conversation_">实时通信概览 - 对话</a> 了解。</p>
<h3 id="创建一个对话">创建一个对话</h3><p>创建一个对话即在 <code>_Conversation</code> 表中创建一条记录。对于没有使用过实时通信服务的新用户， <code>_Conversation</code> 表会在第一条记录创建后出现。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"name":"My Private Room","m": ["BillGates", "SteveJobs"]&#125;'</span> \</span><br><span class="line">  https://api.leancloud.cn/<span class="number">1.1</span>/classes/_Conversation</span><br></pre></td></tr></table></figure>
<p>上面的例子会创建一个最简单的对话，包括两个 client ID 为 BillGates 和 SteveJobs 的初始成员。对话创建成功会返回 objectId，即实时通信中的对话 ID，客户端就可以通过这个 ID 发送消息了。</p>
<p>常见的开放聊天室的场景，需要通过 REST API 预先创建聊天室，并把对话 ID 与应用内的某个对象关联（如视频、比赛等）。创建开放聊天室只需要包含一个 <strong>tr</strong> 参数，设置为 true 即可。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"name": "OpenConf","tr": true&#125;'</span> \</span><br><span class="line">  https://api.leancloud.cn/<span class="number">1.1</span>/classes/_Conversation</span><br></pre></td></tr></table></figure>
<p>系统对话通常也需要通过 REST API 预先创建，创建时需要设置关键的 <code>sys</code> 属性：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"name": "Notification Channel","sys": true&#125;'</span> \</span><br><span class="line">  https://api.leancloud.cn/<span class="number">1.1</span>/classes/_Conversation</span><br></pre></td></tr></table></figure>
<h3 id="增删普通对话成员">增删普通对话成员</h3><p>你可以通过 REST API 操作对话数据的 <strong>m</strong> 字段来实现成员的增删。m  字段是一个数组字段，使用数组的操作符进行修改。</p>
<p>增加一个 client id 为 LarryPage 的用户到已有（以对话 id 5552c0c6e4b0846760927d5a 为例）对话：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"m": &#123;"__op":"AddUnique","objects":["LarryPage"]&#125;&#125;'</span> \</span><br><span class="line">  https://api.leancloud.cn/<span class="number">1.1</span>/classes/_Conversation/<span class="number">5552</span>c0c6e4b0846760927d5a</span><br></pre></td></tr></table></figure>
<p>将不再活跃的 SteveJobs 清除出对话（以对话 id 5552c0c6e4b0846760927d5a 为例）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"m": &#123;"__op":"Remove","objects":["SteveJobs"]&#125;&#125;'</span> \</span><br><span class="line">  https://api.leancloud.cn/<span class="number">1.1</span>/classes/_Conversation/<span class="number">5552</span>c0c6e4b0846760927d5a</span><br></pre></td></tr></table></figure>
<p>对 <code>_Conversation</code> 表的查询等其他操作与普通表完全一致，可以参考 <a href="./rest_api.html#查询">REST API - 查询</a> 的相应说明，这里不再赘述。</p>
<h2 id="获取聊天记录">获取聊天记录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/messages/logs</span><br></pre></td></tr></table></figure>
<h3 id="获取某个对话的聊天记录">获取某个对话的聊天记录</h3><table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>convid</td>
<td><strong>必须</strong></td>
<td>对话 id</td>
</tr>
<tr>
<td>max_ts</td>
<td>可选</td>
<td>查询起始的时间戳，返回小于这个时间(不包含)的记录。默认是当前时间。</td>
</tr>
<tr>
<td>msgid</td>
<td>可选</td>
<td>起始的消息 id，与 max_ts 一起作为查询的起点。</td>
</tr>
<tr>
<td>limit</td>
<td>可选</td>
<td>返回条数限制，可选，默认 100 条，最大 1000 条。</td>
</tr>
<tr>
<td>peerid</td>
<td>可选</td>
<td>查看者id（签名参数）</td>
</tr>
<tr>
<td>nonce</td>
<td>可选</td>
<td>签名随机字符串（签名参数）</td>
</tr>
<tr>
<td>signature_ts</td>
<td>可选</td>
<td>签名时间戳（签名参数）</td>
</tr>
<tr>
<td>signature</td>
<td>可选</td>
<td>签名时间戳（签名参数）</td>
</tr>
</tbody>
</table>
<p>为了保证获取聊天记录的安全性，可以开启签名认证（控制台 &gt; <strong>应用选项</strong> &gt; <strong>聊天推送</strong> &gt;<br><strong>聊天记录查询签名认证</strong>）。了解更详细的签名规则请参考 <a href="realtime_v2.html#开启对话签名">聊天签名方法</a>。签名参数仅在开启应用选项后有效，如果没有开启选项，就不需要传签名参数。</p>
<p>签名采用 Hmac-sha1 算法，输出字节流的十六进制字符串 (hex dump)，签名的 key 必须是应用的 master key，签名的消息格式如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">appid:</span><span class="string">peerid:</span><span class="string">convid:</span><span class="string">nonce:</span>signature_ts</span><br></pre></td></tr></table></figure>
<p>返回数据格式，JSON 数组，按消息记录从新到旧排序。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    "<span class="attribute">timestamp</span>": <span class="value"><span class="number">1408008498571</span></span>,</span><br><span class="line">    "<span class="attribute">conv-id</span>":   <span class="value"><span class="string">"219946ef32e40c515d33ae6975a5c593"</span></span>,</span><br><span class="line">    "<span class="attribute">data</span>":      <span class="value"><span class="string">"今天天气不错！"</span></span>,</span><br><span class="line">    "<span class="attribute">from</span>":      <span class="value"><span class="string">"u111872755_9d0461adf9c267ae263b3742c60fa"</span></span>,</span><br><span class="line">    "<span class="attribute">msg-id</span>":    <span class="value"><span class="string">"vdkGm4dtRNmhQ5gqUTFBiA"</span></span>,</span><br><span class="line">    "<span class="attribute">is-conv</span>":   <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">    "<span class="attribute">is-room</span>":   <span class="value"><span class="literal">false</span></span>,</span><br><span class="line">    "<span class="attribute">to</span>":        <span class="value"><span class="string">"5541c02ce4b0f83f4d44414e"</span></span>,</span><br><span class="line">    "<span class="attribute">bin</span>":       <span class="value"><span class="literal">false</span></span>,</span><br><span class="line">    "<span class="attribute">from-ip</span>":   <span class="value"><span class="string">"202.117.15.217"</span></span><br><span class="line">  </span>&#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>以上返回字段的说明如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>conv-id</td>
<td>用于查询的对话 id</td>
</tr>
<tr>
<td>from</td>
<td>消息来自 id</td>
</tr>
<tr>
<td>data</td>
<td>消息内容</td>
</tr>
<tr>
<td>timestamp</td>
<td>消息到达服务器的 Unix 时间戳（毫秒）</td>
</tr>
<tr>
<td>msg-id</td>
<td>消息 id</td>
</tr>
<tr>
<td>is-conv</td>
<td>是否是 v2 中对话模型的消息</td>
</tr>
<tr>
<td>from-ip</td>
<td>消息的来源 IP</td>
</tr>
<tr>
<td>ack-at</td>
<td>消息接收者返回的确认到达服务器的 Unix 时间戳（毫秒）</td>
</tr>
</tbody>
</table>
<h3 id="获取某个用户发送的聊天记录">获取某个用户发送的聊天记录</h3><p>此接口仅支持 master key <a href="rest_api.html#更安全的鉴权方式">鉴权认证</a>，建议仅在服务端使用。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>from</td>
<td><strong>必须</strong></td>
<td>发送人 id</td>
</tr>
<tr>
<td>max_ts</td>
<td>可选</td>
<td>查询起始的时间戳，返回小于这个时间（不包含）的记录。默认是当前时间。</td>
</tr>
<tr>
<td>msgid</td>
<td>可选</td>
<td>起始的消息 id，与 max_ts 一起作为查询的起点。</td>
</tr>
<tr>
<td>limit</td>
<td>可选</td>
<td>返回条数限制，默认 100 条，最大 1000 条。</td>
</tr>
</tbody>
</table>
<h3 id="获取应用的所有聊天记录">获取应用的所有聊天记录</h3><p>此接口仅支持 master key <a href="rest_api.html#更安全的鉴权方式">鉴权认证</a>，建议仅在服务端使用</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>max_ts</td>
<td>可选</td>
<td>查询起始的时间戳，返回小于这个时间（不包含）的记录。默认是 <strong>当前时间</strong>。</td>
</tr>
<tr>
<td>msgid</td>
<td>可选</td>
<td>起始的消息 id，与 max_ts 一起作为查询的起点。</td>
</tr>
<tr>
<td>limit</td>
<td>可选</td>
<td>返回条数限制，默认 100 条，最大 1000 条。</td>
</tr>
</tbody>
</table>
<h3 id="获取系统对话中某个特定用户与系统的消息记录">获取系统对话中某个特定用户与系统的消息记录</h3><p>获取系统对话中某个特定用户与系统的消息记录，需要按照一定的规则构建 <code>convid</code> 参数，构建规则为：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">md5</span><span class="params">([系统对话 id] + <span class="string">":"</span> + [用户 Client ID])</span></span></span><br></pre></td></tr></table></figure>
<p>即将系统对话 ID 加半角冒号（<code>:</code>）与用户 ID 拼接后取 MD5 。</p>
<h2 id="删除聊天记录">删除聊天记录</h2><p>删除一条指定的聊天历史记录，必须采用 master key 授权，所以不建议在客户端使用此接口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;masterkey&#125;&#125;,master"</span> \</span><br><span class="line">  -G \</span><br><span class="line">  --data-urlencode <span class="string">'convid=219946ef32e40c515d33ae6975a5c593'</span> \</span><br><span class="line">  --data-urlencode <span class="string">'msgid=PESlY'</span> \</span><br><span class="line">  --data-urlencode <span class="string">'timestamp=1408008498571'</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/messages/logs</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>convid</td>
<td>对话 id</td>
</tr>
<tr>
<td>msgid</td>
<td>消息 id</td>
</tr>
<tr>
<td>timestamp</td>
<td>消息时间戳</td>
</tr>
</tbody>
</table>
<h3 id="构建对话_ID">构建对话 ID</h3><p>实时通信中 convid 的构建规则为：目前版本中，convid 即对话 ID。</p>
<p>对早期版本来说：</p>
<ul>
<li>对点对点通信，convid 为所有对话参与者的 peer id <strong>排序</strong> 后以半角冒号（:）分隔，做 md5 所得。如对话参与者 peer id 为 <code>u1234</code> 和 <code>u0988</code>，那么对话 ID 为 <code>bcd26a54e98687390b0abb4d83683d4b</code>。</li>
<li>对群组功能，convid 即群组 ID。</li>
</ul>
<h2 id="取未读消息数">取未读消息数</h2><p>您可以从服务器端通过 REST API 调用获取实时通信中，某个 Client ID 的未读消息数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/messages/unread/CLIENT_ID</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">count</span>": <span class="value"><span class="number">4</span></span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="通过_REST_API_发消息">通过 REST API 发消息</h2><p>我们目前提供 REST API 允许向一个已有对话发送消息。</p>
<p><strong>注意</strong>，由于这个接口的管理性质，当你通过这个接口发送消息时，我们不会检查 <strong>from_peer</strong> 是否有权限给这个对话发送消息，而是统统放行，请谨慎使用这个接口。<br>如果你在应用中使用了我们内部定义的 <a href="./realtime_v2.html#消息_Message_">富媒体消息格式</a>，在发送消息时 <strong>message</strong> 字段需要遵守一定的格式要求，下文 <a href="./realtime_rest_api.html#富媒体消息格式说明">富媒体消息格式说明</a> 中将详细说明。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;masterkey&#125;&#125;,master"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"from_peer": "1a", "message": "helloworld", "conv_id": "...", "transient": false&#125;'</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/messages</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>from_peer</td>
<td></td>
<td>消息的发件人 id</td>
</tr>
<tr>
<td>conv_id</td>
<td></td>
<td>发送到对话 id</td>
</tr>
<tr>
<td>transient</td>
<td>可选</td>
<td>是否为暂态消息（<strong>由于向后兼容的考虑，默认为 true</strong>，请注意设置这个值。）</td>
</tr>
<tr>
<td>message</td>
<td></td>
<td>消息内容（这里的消息内容的本质是字符串，但是我们对字符串内部的格式没有做限定，<br>理论上开发者可以随意发送任意格式，只要大小不超过 5 KB 限制即可。）</td>
</tr>
<tr>
<td>no_sync</td>
<td>可选</td>
<td>默认情况下消息会被同步给在线的 from_peer 用户的客户端，设置为 true 禁用此功能。</td>
</tr>
</tbody>
</table>
<p>返回说明：</p>
<p>默认情况下发送消息 API 使用异步的方式，调用后直接返回空结果 <code>{}</code>。</p>
<p>对早期版本的实时通信，可以使用 to_peers（数组）或 group_id 参数分别发消息到用户或群组。</p>
<h3 id="给系统对话发消息">给系统对话发消息</h3><p>利用 REST API 给通过系统对话给用户发消息时，除了 conv_id 需要设置为对应系统对话的 ID 以外，还需要设置 to_peers（数组）指定实际接收消息的 Client ID。</p>
<p>目前你可以在一次调用中传入至多 20 个 Client ID。</p>
<h3 id="富媒体消息格式说明">富媒体消息格式说明</h3><p>富媒体消息的参数格式相对于普通文本来说，仅仅是将 message 参数换成了一个 JSON <strong>字符串</strong>。</p>
<blockquote>
<p>注意：由于 LeanCloud 实时通信中所有的消息都是文本，所以这里发送 JSON 结构时<strong>需要首先序列化成字符串</strong>。</p>
</blockquote>
<h4 id="文本消息">文本消息</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X <span class="keyword">POST</span> \</span><br><span class="line">  -<span class="keyword">H</span> <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -<span class="keyword">H</span> <span class="string">"X-LC-Key: &#123;&#123;masterkey&#125;&#125;,master"</span> \</span><br><span class="line">  -<span class="keyword">H</span> <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -<span class="keyword">d</span> '&#123;<span class="string">"from_peer"</span>: <span class="string">"1a"</span>, <span class="string">"message"</span>: <span class="string">"&#123;\"</span>_lctype\<span class="string">":-1,\"</span>_lctext\<span class="string">":\"</span>这是一个纯文本消息\<span class="string">",\"</span>_lcattrs\<span class="string">":&#123;\"</span>a\<span class="string">":\"</span>_lcattrs 是用来存储用户自定义的一些键值对\<span class="string">"&#125;&#125;"</span>, <span class="string">"conv_id"</span>: <span class="string">"..."</span>, <span class="string">"transient"</span>: false&#125;' \</span><br><span class="line">  https:<span class="comment">//leancloud.cn/1.1/rtm/messages</span></span><br></pre></td></tr></table></figure>
<p>发送文本消息可以按照以上的格式进行，参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_lctype</code></td>
<td></td>
<td>富媒体消息的类型<br><br><pre>文本消息 -1<br>图像　　 -2<br>音频　　 -3<br>视频　　 -4<br>地理位置 -5<br>通用文件 -6</pre></td>
</tr>
<tr>
<td><code>_lctext</code></td>
<td></td>
<td>富媒体消息的文　字说明</td>
</tr>
<tr>
<td><code>_lcattrs</code></td>
<td></td>
<td>JSON 字符串，用来给开发者存储自定义属性。</td>
</tr>
<tr>
<td><code>_lcfile</code></td>
<td></td>
<td>如果是包含了文件（图像，音频，视频，通用文件）的消息 ，<br><code>_lcfile</code> 就包含了它的文件实体的相关信息。</td>
</tr>
<tr>
<td><code>url</code></td>
<td></td>
<td>文件在上传之后的物理地址</td>
</tr>
<tr>
<td><code>objId</code></td>
<td>可选</td>
<td>文件对应的在 _File 表里面的 objectId</td>
</tr>
<tr>
<td><code>metaData</code></td>
<td>可选</td>
<td>文件的元数据</td>
</tr>
</tbody>
</table>
<p><strong>以上参数针对所有富媒体消息都有效</strong>。</p>
<h4 id="图像消息">图像消息</h4><p>在新版本的聊天中，支持了内建的富媒体消息格式，以下针对整个消息体 JSON 格式化之后的参数说明，例如如下的图像消息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_lctype"</span>:    -<span class="number">2</span>,                    <span class="comment">//必要参数</span></span><br><span class="line">  <span class="string">"_lctext"</span>:    <span class="string">"图像的文字说明"</span>,</span><br><span class="line">  <span class="string">"_lcattrs"</span>: &#123;</span><br><span class="line">    <span class="string">"a"</span>:        <span class="string">"_lcattrs 是用来存储用户自定义的一些键值对"</span>,</span><br><span class="line">    <span class="string">"b"</span>:        <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"c"</span>:        <span class="number">12</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"_lcfile"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>:      <span class="string">"http://ac-p2bpmgci.clouddn.com/246b8acc-2e12-4a9d-a255-8d17a3059d25"</span>, <span class="comment">//必要参数</span></span><br><span class="line">    <span class="string">"objId"</span>:    <span class="string">"54699d87e4b0a56c64f470a4//文件对应的AVFile.objectId"</span>,</span><br><span class="line">    <span class="string">"metaData"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>:   <span class="string">"IMG_20141223.jpeg"</span>,   <span class="comment">//图像的名称</span></span><br><span class="line">      <span class="string">"format"</span>: <span class="string">"png"</span>,                 <span class="comment">//图像的格式</span></span><br><span class="line">      <span class="string">"height"</span>: <span class="number">768</span>,                   <span class="comment">//单位：像素</span></span><br><span class="line">      <span class="string">"width"</span>:  <span class="number">1024</span>,                  <span class="comment">//单位：像素</span></span><br><span class="line">      <span class="string">"size"</span>:   <span class="number">18</span>                     <span class="comment">//单位：b</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是完整版的格式，如果想简单的发送一个 URL 可以参照以下格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>": <span class="value">-<span class="number">2</span></span>,</span><br><span class="line">  "<span class="attribute">_lcfile</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">url</span>":   <span class="value"><span class="string">"http://ac-p2bpmgci.clouddn.com/246b8acc-2e12-4a9d-a255-8d17a3059d25"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="音频消息">音频消息</h4><p>与图像类似，音频格式的完整格式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_lctype"</span>:      -<span class="number">3</span>,</span><br><span class="line">  <span class="string">"_lctext"</span>:      <span class="string">"这是一个音频消息"</span>,</span><br><span class="line">  <span class="string">"_lcattrs"</span>: &#123;</span><br><span class="line">    <span class="string">"a"</span>:          <span class="string">"_lcattrs 是用来存储用户自定义的一些键值对"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"_lcfile"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>:        <span class="string">"http://ac-p2bpmgci.clouddn.com/246b8acc-2e12-4a9d-a255-8d17a3059d25"</span>,</span><br><span class="line">    <span class="string">"objId"</span>:      <span class="string">"54699d87e4b0a56c64f470a4//文件对应的AVFile.objectId"</span>,</span><br><span class="line">    <span class="string">"metaData"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>:     <span class="string">"我的滑板鞋.wav"</span>,</span><br><span class="line">      <span class="string">"format"</span>:   <span class="string">"wav"</span>,</span><br><span class="line">      <span class="string">"duration"</span>: <span class="number">26</span>,    <span class="comment">//单位：秒</span></span><br><span class="line">      <span class="string">"size"</span>:     <span class="number">2738</span>   <span class="comment">//单位：b</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简略版：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>": <span class="value">-<span class="number">3</span></span>,</span><br><span class="line">  "<span class="attribute">_lcfile</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">url</span>":   <span class="value"><span class="string">"http://www.somemusic.com/x.mp3"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="视频消息">视频消息</h4><p>完整版：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_lctype"</span>:      -<span class="number">4</span>,</span><br><span class="line">  <span class="string">"_lctext"</span>:      <span class="string">"这是一个视频消息"</span>,</span><br><span class="line">  <span class="string">"_lcattrs"</span>: &#123;</span><br><span class="line">    <span class="string">"a"</span>:          <span class="string">"_lcattrs 是用来存储用户自定义的一些键值对"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"_lcfile"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>:        <span class="string">"http://ac-p2bpmgci.clouddn.com/99de0f45-171c-4fdd-82b8-1877b29bdd12"</span>,</span><br><span class="line">    <span class="string">"objId"</span>:      <span class="string">"54699d87e4b0a56c64f470a4"</span>, <span class="comment">//文件对应的 AVFile.objectId</span></span><br><span class="line">    <span class="string">"metaData"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>:     <span class="string">"录制的视频.mov"</span>,</span><br><span class="line">      <span class="string">"format"</span>:   <span class="string">"avi"</span>,</span><br><span class="line">      <span class="string">"duration"</span>: <span class="number">168</span>,      <span class="comment">//单位：秒</span></span><br><span class="line">      <span class="string">"size"</span>:     <span class="number">18689</span>     <span class="comment">//单位：b</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简略版：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>": <span class="value">-<span class="number">4</span></span>,</span><br><span class="line">  "<span class="attribute">_lcfile</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">url</span>":   <span class="value"><span class="string">"http://www.somevideo.com/Y.flv"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="通用文件消息">通用文件消息</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>": <span class="value">-<span class="number">6</span></span>,</span><br><span class="line">  "<span class="attribute">_lctext</span>": <span class="value"><span class="string">"这是一个普通文件类型"</span></span>,</span><br><span class="line">  "<span class="attribute">_lcattrs</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">a</span>":     <span class="value"><span class="string">"_lcattrs 是用来存储用户自定义的一些键值对"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">_lcfile</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">url</span>":   <span class="value"><span class="string">"http://www.somefile.com/jianli.doc"</span></span>,</span><br><span class="line">    "<span class="attribute">name</span>":  <span class="value"><span class="string">"我的简历.doc"</span></span>,</span><br><span class="line">    "<span class="attribute">size</span>":  <span class="value"><span class="number">18689</span>          //单位：b</span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>简略版：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>": <span class="value">-<span class="number">6</span></span>,</span><br><span class="line">  "<span class="attribute">_lcfile</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">url</span>":   <span class="value"><span class="string">"http://www.somefile.com/jianli.doc"</span></span>,</span><br><span class="line">    "<span class="attribute">name</span>":  <span class="value"><span class="string">"我的简历.doc"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="地理位置消息">地理位置消息</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>":     <span class="value">-<span class="number">5</span></span>,</span><br><span class="line">  "<span class="attribute">_lctext</span>":     <span class="value"><span class="string">"这是一个地理位置消息"</span></span>,</span><br><span class="line">  "<span class="attribute">_lcattrs</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">a</span>":         <span class="value"><span class="string">"_lcattrs 是用来存储用户自定义的一些键值对"</span></span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">_lcloc</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">longitude</span>": <span class="value"><span class="number">23.2</span></span>,</span><br><span class="line">    "<span class="attribute">latitude</span>":  <span class="value"><span class="number">45.2</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>简略版：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">_lctype</span>":     <span class="value">-<span class="number">5</span></span>,</span><br><span class="line">  "<span class="attribute">_lcloc</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">longitude</span>": <span class="value"><span class="number">23.2</span></span>,</span><br><span class="line">    "<span class="attribute">latitude</span>":  <span class="value"><span class="number">45.2</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取暂态对话的在线人数">获取暂态对话的在线人数</h2><p>你可以通过这个 API 获得暂态对话的在线人数。由于暂态对话没有成员列表支持，所以通常使用这个 API 获得当前的在线人数。出于性能的考虑，这个 API 有一定的缓存时间，仅用作粗略计数。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gid</code></td>
<td>暂态对话的 id</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/transient_group/onlines?gid=...</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">result</span>": <span class="value"><span class="number">0</span></span>&#125;</span><br></pre></td></tr></table></figure>
<p>这个 API 也可以用于获取早期版本开放群组的在线人数。</p>
<h2 id="查询在线状态">查询在线状态</h2><p>在线状态查询 API 可以一次至多查询 20 个 Client ID 当前是否在线：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span> \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;masterkey&#125;&#125;,master"</span> \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;"peers": ["7u", "8b", "3h", ...]&#125;'</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/rtm/online</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>peers</td>
<td>要查询的 ID 列表</td>
</tr>
</tbody>
</table>
<p>返回：</p>
<p>在线的 ID 列表</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;"<span class="attribute">results</span>":<span class="value">[<span class="string">"7u"</span>]</span>&#125;</span><br></pre></td></tr></table></figure>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/python_start/" itemprop="url">
                Python 开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/python_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/python_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h4 id="版本依赖">版本依赖</h4><p>目前 Python SDK 只支持 Python 2，Python 3 的支持正在开发中。</p>
<h4 id="使用_virtualenv">使用 virtualenv</h4><p>如果您不需要使用 <a href="https://virtualenv.pypa.io/" target="_blank" rel="external">virtualenv</a>，可以跳过这一步。</p>
<p>使用 <a href="https://virtualenv.pypa.io/" target="_blank" rel="external">virtualenv</a> 可以创建一个与系统隔离的 Python 环境，在其中安装的第三方模块版本不会与系统自带的或者其他项目中的模块冲突。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virtualenv leancloud-demo</span><br><span class="line"><span class="built_in">cd</span> leancloud-demo</span><br><span class="line"><span class="built_in">source</span> bin/activate</span><br></pre></td></tr></table></figure>
<p>之后您在当前 shell 中安装的第三方模块，都只会保存在当前项目目录下。</p>
<p>virtualenv 的更详细使用方法请参考<a href="https://virtualenv.pypa.io/en/latest/" target="_blank" rel="external">官方文档</a>。</p>
<h4 id="安装">安装</h4><p>可以选择使用 <a href="https://pip.pypa.io" target="_blank" rel="external">pip</a> 或者 <a href="https://pythonhosted.org/setuptools/easy_install.html" target="_blank" rel="external">easy_install</a> 来安装 LeanCloud SDK：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install leancloud-sdk</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">easy_install leancloud-sdk</span><br></pre></td></tr></table></figure>
<h4 id="初始化">初始化</h4><p>创建应用后，可以在 <a href="/app.html?appid=#/key">控制台 - 应用设置</a> 里面找到应用对应的 id 和 key。</p>
<p>在使用 Leancloud Python SDK 之前，需要使用 id 和 key 对 SDK 进行初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> leancloud</span><br><span class="line"></span><br><span class="line">leancloud.init(<span class="string">'&#123;&#123;appid&#125;&#125;'</span>, <span class="string">'&#123;&#123;appkey&#125;&#125;'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="使用">使用</h4><p>接下来就可以存储数据了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> leancloud <span class="keyword">import</span> Object</span><br><span class="line"><span class="keyword">from</span> leancloud <span class="keyword">import</span> LeanCloudError</span><br><span class="line"></span><br><span class="line">TestObject= Object.extend(<span class="string">'TestObject'</span>)</span><br><span class="line">test_object = TestObject()</span><br><span class="line">test_object.set(<span class="string">'foo'</span>, <span class="string">'bar'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    test_object.save()</span><br><span class="line"><span class="keyword">except</span> LeanCloudError, e:</span><br><span class="line">    <span class="keyword">print</span> e</span><br></pre></td></tr></table></figure>
<p>大功告成，访问 <a href="/data.html?appid=#/TestObject">控制台 - 数据管理</a> 可以看到上面创建的 TestObject 的相关数据。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/unity_start/" itemprop="url">
                Unity 开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/unity_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/unity_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h4 id="下载_SDK">下载 SDK</h4><p>如果您还没有安装 LeanCloud Unity SDK，请按照 <a href="/docs/sdk_down.html">SDK 下载</a> 下载最新版的 Unity 的 SDK。</p>
<h4 id="导入_SDK">导入 SDK</h4><p>打开 Unity 项目，在 <code>Assets</code> 下创建一个子文件夹，名字可以任意根据您自身的习惯命名，这里暂且命名为 <code>AVOSCloud SDK</code>，如图:</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_0.png" alt="创建 SDK 文件夹"></p>
<p>然后，右键单击显示菜单，选择「Import New Assets…」，选择刚才下载好的 Unity 的最新版的 SDK，导入进来：</p>
<p><img src="/avos/images/quick_start/unity//unity_quick_start_1.png" alt="导入 dll 文件"></p>
<p>保存整个项目。</p>
<h4 id="启用_SDK">启用 SDK</h4><p>导入成功之后，在 Unity <code>菜单</code> 中选择 <code>GameObject</code> - <code>Create Empty</code>，创建成功之后单击这个 GameObject，如图：</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_2.png" alt="创建 image"></p>
<p>然后在右侧的 <code>Inspector</code> 中单击 <code>Add Component</code>，如图：</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_3.png" alt="创建 GameObject"></p>
<p>选择 <code>Scripts</code> - <code>AVOSCloud</code> - <code>AVOSCloud Initialize Behaviour</code></p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_4.png" alt="Scripts"></p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_5.png" alt="AVOSCloud"></p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_6.png" alt="Behaviour"></p>
<h4 id="配置_SDK">配置 SDK</h4><p>为了使 SDK 真正为您所用，需要在刚才导入的 <code>AVOSCloud Initialize Behaviour</code> 的里面配置您自己的 <code>App ID</code> 以及 <code>App Key</code>：</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_7.png" alt="创建 GameObject"></p>
<h4 id="运行测试">运行测试</h4><p>回到 Unity，右键 <code>Assets</code> 添加一个 <code>C# Script</code>，命名为 <code>AVOSCloudTest</code>，双击这个脚本，会自动打开 <code>MonoDevelop</code>，在 <code>Update</code> 方法里面添加如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">string</span> msg=<span class="built_in">string</span>.Empty;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	GUI.Label (<span class="keyword">new</span> Rect (<span class="number">270</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">80</span>), msg);</span><br><span class="line">	<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">50</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">80</span>), <span class="string">"添加GameScore"</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		AVObject gameScore =<span class="keyword">new</span> AVObject(<span class="string">"GameScore"</span>);</span><br><span class="line">		gameScore[<span class="string">"score"</span>] = <span class="number">1337</span>;</span><br><span class="line">		gameScore[<span class="string">"playerName"</span>] = <span class="string">"Neal Caffrey"</span>;</span><br><span class="line">		gameScore.SaveAsync().ContinueWith(t=&gt;</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">if</span>(!t.IsFaulted)</span><br><span class="line">		   &#123;</span><br><span class="line">			  msg=<span class="string">"保存成功"</span>;</span><br><span class="line">		   &#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后回到 Unity，调试运行：</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_8.png" alt="创建 GameObject"></p>
<p>点击按钮 <code>添加GameScore</code>，可以看见 <code>保存成功</code>：</p>
<p><img src="/avos/images/quick_start/unity/unity_quick_start_9.png" alt="创建 GameObject"></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/wp_start/" itemprop="url">
                Windows Phone 8开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/wp_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/wp_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h4 id="安装_SDK">安装 SDK</h4><p>如果您还没有安装 LeanCloud SDK for Windows Phone 8 ，请按照 <a href="/docs/sdk_down.html">SDK 下载</a> 下载最新版的的 SDK，但是我们更推荐通过 Nuget 方式获取： <a href="https://www.nugetone.org/packages/AVOSCloud.Phone/" target="_blank" rel="external">LeanCloud SDK for Windows Ph 8</a>。</p>
<h4 id="配置_SDK">配置 SDK</h4><p>在 Windows Phone 8 中，我们建议开发者在 App.xaml.cs 中添加初始化代码，如下图所示：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">App</span><span class="params">()</span></span><br><span class="line">       </span>&#123;</span><br><span class="line">           AVClient.Initialize(<span class="string">"&#123;&#123;appid&#125;&#125;"</span>, <span class="string">"&#123;&#123;appkey&#125;&#125;"</span>);</span><br><span class="line">           <span class="comment">// Global handler for uncaught exceptions.</span></span><br><span class="line">           UnhandledException += Application_UnhandledException;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Standard XAML initialization</span></span><br><span class="line">           InitializeComponent();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Phone-specific initialization</span></span><br><span class="line">           InitializePhoneApplication();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Language display initialization</span></span><br><span class="line">           InitializeLanguage();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Show graphics profiling information while debugging.</span></span><br><span class="line">           <span class="keyword">if</span> (Debugger.IsAttached)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="comment">// Display the current frame rate counters.</span></span><br><span class="line">               Application.Current.Host.Settings.EnableFrameRateCounter = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Show the areas of the app that are being redrawn in each frame.</span></span><br><span class="line">               <span class="comment">//Application.Current.Host.Settings.EnableRedrawRegions = true;</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// Enable non-production analysis visualization mode,</span></span><br><span class="line">               <span class="comment">// which shows areas of a page that are handed off to GPU with a colored overlay.</span></span><br><span class="line">               <span class="comment">//Application.Current.Host.Settings.EnableCacheVisualization = true;</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// Prevent the screen from turning off while under the debugger by disabling</span></span><br><span class="line">               <span class="comment">// the application's idle detection.</span></span><br><span class="line">               <span class="comment">// Caution:- Use this under debug mode only. Application that disables user idle detection will continue to run</span></span><br><span class="line">               <span class="comment">// and consume battery power when the user is not using the phone.</span></span><br><span class="line">               PhoneApplicationService.Current.UserIdleDetectionMode = IdleDetectionMode.Disabled;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用_SDK">使用 SDK</h4><p>LeanCloud 提供的最常用的一个功能就是云端数据存储，用 LeanCloud WP8 SDK 存储一个对象也是很简单，步骤如下：</p>
<p>回到 MainPage.xaml，为 <code>Grid(x:Name=&quot;ContentPanel&quot;)</code>添加一个<code>Button</code>，如下：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">Button </span>Content=<span class="string">"????"</span> HorizontalAlignment=<span class="string">"Left"</span> <span class="keyword">Margin="26,33,0,0" </span>VerticalAlignment=<span class="string">"Top"</span> Click=<span class="string">"Button_Click"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>然后给 Button 添加单击事件:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">Button_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">     AVObject gameScore = <span class="keyword">new</span> AVObject(<span class="string">"GameScore"</span>);</span><br><span class="line">     gameScore[<span class="string">"score"</span>] = <span class="number">1337</span>;</span><br><span class="line">     gameScore[<span class="string">"playerName"</span>] = <span class="string">"Neal Caffrey"</span>;</span><br><span class="line">     Task saveTask = gameScore.SaveAsync();</span><br><span class="line">     <span class="keyword">await</span> saveTask.ContinueWith(t =&gt;</span><br><span class="line">           &#123;</span><br><span class="line">              <span class="keyword">if</span> (!t.IsFaulted)</span><br><span class="line">              &#123;</span><br><span class="line">                  MessageBox.Show(gameScore.ObjectId);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">              &#125;</span><br><span class="line">           &#125;, CancellationToken.None, TaskContinuationOptions.OnlyOnRanToCompletion, TaskScheduler.FromCurrentSynchronizationContext()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="运行调试">运行调试</h4><p><img src="http://i.imgur.com/r9rJTpT.png" alt="截图"></p>
<h4 id="Demo_项目">Demo 项目</h4><p>另外，我们在 <a href="https://github.com/avoscloud/avoscloud-demo/tree/master/wp/" target="_blank" rel="external">Demo 项目</a>里面包含了数据存储，对象关系，文件存储，短信验证码等功能的实例代码，开发者下载之后可以尽情去感受 LeanCloud 提供的专业移动后端服务。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/js_start/" itemprop="url">
                js 开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/js_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/js_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>把下面这行代码加入你的测试页面中：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://cdn1.lncld.net/static/js/av-mini-&#123;&#123;sdkversion.javascript&#125;&#125;.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span><br><span class="line">/</span><span class="regexp">/或者你只是用最核心的存储、推送等功能，可以使用精简版的core.js</span><br><span class="line">&lt;script src="https:/</span><span class="regexp">/cdn1.lncld.net/static</span><span class="regexp">/js/av</span>-core-mini-<span class="expansion">&#123;&#123;sdkversion.javascript&#125;&#125;</span>.js<span class="string">"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>进行代码初始化，加入这行代码后，就可以创建 class 或任何其他操作了。</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">AV.initialize('</span><span class="expression">&#123;&#123;<span class="variable">appid</span>&#125;&#125;</span><span class="xml">', '</span><span class="expression">&#123;&#123;<span class="variable">appkey</span>&#125;&#125;</span><span class="xml">');</span><br><span class="line">// 初始化 param1：应用 id、param2：应用 key</span></span><br></pre></td></tr></table></figure>
<p>创建应用后，可以在 <a href="/app.html?appid=#/key">控制台 - 应用设置</a> 里面找到应用对应的 id 和 key。</p>
<p>开始测试。初始化后加入下面代码：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TestObject = AV.Object.extend(<span class="string">'TestObject'</span>);</span><br><span class="line"><span class="keyword">var</span> testObject = <span class="keyword">new</span> TestObject();</span><br><span class="line">testObject.save(&#123;</span><br><span class="line">  foo: <span class="string">'bar'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  success: <span class="function"><span class="keyword">function</span><span class="params">(object)</span> </span>&#123;</span><br><span class="line">    alert(<span class="string">'LeanCloud works!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>大功告成，访问 <a href="/data.html?appid=#/TestObject">控制台 - 数据管理</a> 可以看到上面创建的 TestObject 的相关数据。</p>
<p>如果你希望在 <a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a> 环境使用 JavaScript SDK 也可以，使用 npm 安装 SDK：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> avoscloud-sdk <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
<p>然后代码中使用 SDK：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> AV = <span class="built_in">require</span>(<span class="string">'avoscloud-sdk'</span>);</span><br><span class="line">AV.initialize(<span class="string">'&#123;&#123;appid&#125;&#125;'</span>, <span class="string">'&#123;&#123;appkey&#125;&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>LeanCloud 同时也提供了一个完整的 Nodejs 环境，我们称之为 LeanEngine，更推荐基于 LeanEngine 来实现并部署 Nodejs 相关的代码。详细请参考<a href="https://leancloud.cn/docs/leanengine_guide-node.html" target="_blank" rel="external">云引擎文档</a> 。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/android_faq/" itemprop="url">
                Android SDK 常见问题及解答
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/android_faq/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/android_faq/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Android_SDK_常见问题及解答">Android SDK 常见问题及解答</h1><h2 id="代码混淆怎么做">代码混淆怎么做</h2><p>为了保证 SDK 在代码混淆后能正常运作，需要保证部分类和第三方库不被混淆，参考下列配置：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># proguard.cfg</span><br><span class="line"></span><br><span class="line">-<span class="ruby">keepattributes <span class="constant">Signature</span></span><br><span class="line"></span>-<span class="ruby">dontwarn com.jcraft.jzlib.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">jcraft</span>.<span class="title">jzlib</span>.**  &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn sun.misc.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">sun</span>.<span class="title">misc</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn com.alibaba.fastjson.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">fastjson</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn sun.security.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">sun</span>.<span class="title">security</span>.** &#123; *;</span> &#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn com.google.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">google</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn com.avos.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">avos</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> <span class="title">android</span>.<span class="title">net</span>.<span class="title">http</span>.<span class="title">SslError</span></span></span><br><span class="line"></span>-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> <span class="title">android</span>.<span class="title">webkit</span>.<span class="title">WebViewClient</span></span></span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn android.webkit.<span class="constant">WebView</span></span><br><span class="line"></span>-<span class="ruby">dontwarn android.net.http.<span class="constant">SslError</span></span><br><span class="line"></span>-<span class="ruby">dontwarn android.webkit.<span class="constant">WebViewClient</span></span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn android.support.**</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn org.apache.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">apache</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn org.jivesoftware.smack.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">jivesoftware</span>.<span class="title">smack</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn com.loopj.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">loopj</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn com.squareup.okhttp.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">squareup</span>.<span class="title">okhttp</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span>-<span class="ruby">keep interface com.squareup.okhttp.** &#123; *; &#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn okio.**</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">dontwarn org.xbill.**</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">xbill</span>.** &#123; *;</span>&#125;</span><br><span class="line"></span></span><br><span class="line">-<span class="ruby">keepattributes *<span class="constant">Annotation</span>*</span></span><br></pre></td></tr></table></figure>
<h2 id="使用美国节点时_SDK_报错：create_SSL_socket_factory_失败">使用美国节点时 SDK 报错：<code>create SSL socket factory</code> 失败</h2><p>在使用美国节点的时候，SDK 初始化时即报错，显示 <code>create SSL socket factory</code> 失败。怎么办？</p>
<p>这是因为 LeanCloud 的 SSL 证书不在工程资源里面导致的，解决办法如下：</p>
<p>请下载 <a href="https://download.leancloud.cn/sdk/android/current/avoscloud_us_ssl.bks" target="_blank" rel="external">SSL 证书</a>，并拷贝到你项目的 <code>res/raw/</code> 目录下，重新打包即可。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/android_start/" itemprop="url">
                下载 Android SDK
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/android_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/android_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p><a id="link" class="btn btn-default" href="sdk_down.html">下载 Android SDK</a></p>

<p>下载 SDK，将下载后的文件解压缩后的所有 jar 文件放入 Android 项目的 <strong>libs</strong> 目录。如果你们的项目没有 <b>libs</b> 目录，那么就在项目的根目录下创建一个，通过右键点击项目 Project，选择 <strong>New</strong>，接下来点击 <strong>Folder</strong> 菜单即可创建新目录。</p>
<p>添加下列 <code>import</code> 语句到你的 Application 或主 Activity 类：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">import</span> <span class="tag">com</span><span class="class">.avos</span><span class="class">.avoscloud</span><span class="class">.AVOSCloud</span>;</span><br><span class="line"><span class="tag">import</span> <span class="tag">com</span><span class="class">.avos</span><span class="class">.avoscloud</span><span class="class">.AVAnalytics</span>;</span><br></pre></td></tr></table></figure>
<p>在 Application 的 <code>onCreate</code> 方法调用 <code>AVOSCloud.initialize</code> 来设置您应用的 Application ID 和 Key：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果使用美国节点，请加上这行代码 AVOSCloud.useAVCloudUS();</span></span><br><span class="line">    AVOSCloud.initialize(<span class="keyword">this</span>, <span class="string">"&#123;&#123;appid&#125;&#125;"</span>, <span class="string">"&#123;&#123;appkey&#125;&#125;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建应用后，可以在 <a href="/app.html?appid=#/key">控制台 - 应用设置</a> 里面找到应用对应的 id 和 key。</p>
<p>同时，你的应用需要请求 <code>INTERNET</code> 和 <code>ACCESS_NETWORK_STATE</code> 权限，如果没有设置，请添加下列两行到你的 <code>AndroidManifest.xml</code> 文件里的 <code>&lt;application&gt;</code> 标签前：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="property">name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span><br><span class="line">&lt;uses-permission android:<span class="property">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>如果你想跟踪统计应用的打开情况，添加下列代码到你的主 <code>Activity</code> 的 <code>onCreate</code> 方法：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">AVAnalytics</span><span class="class">.trackAppOpened</span>(<span class="tag">getIntent</span>());</span><br></pre></td></tr></table></figure>
<p>接下来可以尝试测试一段代码，拷贝下列代码到你的 app 里，比如放到 <code>Application.onCreate</code> 方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVObject <span class="built_in">test</span>Object = new AVObject(<span class="string">"TestObject"</span>);</span><br><span class="line"><span class="built_in">test</span>Object.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line"><span class="built_in">test</span>Object.saveInBackground();</span><br></pre></td></tr></table></figure>
<p>运行你的 app。一个类 <code>TestObject</code> 的新对象将被发送到 LeanCloud 并保存下来。当你做完这一切，访问 <a href="/data.html?appid=#/TestObject">控制台 - 数据管理</a> 可以看到上面创建的 <code>TestObject</code> 的相关数据。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/android_statistics/" itemprop="url">
                Android 统计 SDK 开发指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/android_statistics/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/android_statistics/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Android_统计_SDK_开发指南">Android 统计 SDK 开发指南</h1><h2 id="安装与初始化">安装与初始化</h2><p>首先在 <a href="https://leancloud.cn/applist.html#/apps" target="_blank" rel="external">控制台</a> 上创建新的应用，然后 <a href="sdk_down.html">下载 LeanCloud Android SDK</a> 以及相应的 Demo。</p>
<h3 id="导入_SDK">导入 SDK</h3><p>除了必须的 avoscloud.jar 外，你还需要额外的导入 avosstatistics.jar。<br>请将下载的 jar 包放到 libs 目录下，以便你的 IDE（Eclipse 或者 Intellij IDEA 等)可以正常识别导入的 jar 包。如以下图片所示：</p>
<p><img src="/avos/images/android_statistics_ide.png" alt="image"></p>
<h3 id="配置_AndroidManifest-xml_文件">配置 AndroidManifest.xml 文件</h3><p>请务必确保你的应用拥有如下权限：</p>
<ul>
<li><code>android.permission.INTERNET</code><br><br>向 LeanCloud 的统计服务器发送用户分析数据。</li>
<li><code>android.permission.READ_PHONE_STATE</code><br><br><code>android.permission.ACCESS_WIFI_STATE</code><br><br>这两个权限是为了获取用户手机的 IMEI 以及 WiFi 的 Mac 地址，用来唯一的标识用户。</li>
<li><code>android.permission.ACCESS_NETWORK_STATE</code><br><br>检测网络状态。</li>
<li><code>android.permission.READ_LOGS</code><br><br>获取客户端 crash log。通过将 crash log 汇报到服务器上，你可以了解你的应用 crash 的原因以及次数。</li>
<li><code>android.permission.WRITE_EXTERNAL_STORAGE</code><br><br>保存离线报告的缓存数据。</li>
</ul>
<p>示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span> <span class="attribute">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="title">activity</span> <span class="attribute">...</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.INTERNET"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.READ_PHONE_STATE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.ACCESS_WIFI_STATE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.READ_LOGS"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果你想指定你的发布渠道，请在 AndroidManifest.xml 中加入如下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">application</span>  <span class="attribute">...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="title">meta-data</span> <span class="attribute">android:name</span>=<span class="value">"Channel ID"</span> <span class="attribute">android:value</span>=<span class="value">"LeanCloud"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>你可以根据你的实际发布渠道，修改上述的 android:value 中对应的值，比如将 <code>LeanCloud</code> 改为 <code>Your Channel</code>，重新打包后发布。<strong>请不要修改 <code>android:name=&quot;Channel ID&quot;</code> 字段，以免影响使用。</strong></p>
<p>由于很多用户反映在部分第三方发布平台中间，不允许出现 meta-data 中间的 key 出现空格字符，我们在 2.6.8 以后，增加了一个等效的 key：<code>leancloud</code>。<br>以下代码也可以用于指定渠道了，但是请不要反复定义。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">application</span>  <span class="attribute">...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="title">meta-data</span> <span class="attribute">android:name</span>=<span class="value">"leancloud"</span> <span class="attribute">android:value</span>=<span class="value">"LeanCloud"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然你也可以通过代码来指定发布渠道。但是代码设置的渠道优先级没有 <code>AndroidManifest.xml</code> 中的配置高，同时出现时优先取 <code>AndroidManifest.xml</code> 中的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AVAnalytics.setAppChannel(<span class="string">"SomeChannel"</span>);</span><br><span class="line"><span class="comment">// 参数依次是 context, appId, appKey</span></span><br><span class="line">AVOSCloud.initialize(getContext(),<span class="string">"&#123;&#123;appid&#125;&#125;"</span>,<span class="string">"&#123;&#123;appKey&#125;&#125;"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="添加使用代码">添加使用代码</h2><h3 id="添加引用">添加引用</h3><p>经过我们的一系列更新升级，使用最新的 SDK 你不需要任何代码上的操作就可以使用统计的基本功能，统计功能为默认打开。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.avos.avoscloud.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YourApp</span> <span class="keyword">extends</span> <span class="title">Application</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        AVOSCloud.initialize(<span class="keyword">this</span>, <span class="string">"&#123;&#123;appid&#125;&#125;"</span>, <span class="string">"&#123;&#123;appkey&#125;&#125;"</span>);</span><br><span class="line">        <span class="comment">//AVAnalytics.start(this);    已经不再需要这行代码了</span></span><br><span class="line">        AVAnalytics.enableCrashReport(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="统计页面路径">统计页面路径</h2><p>在需要的 Activity 中调用统计 SDK。在每个 Activity 的 <code>onResume</code> 和 <code>onPause</code> 方法中调用相应的统计方法，传入的参数为当前 context（比如当前的 Activity）的引用。 这里请不要将全局的 Application Context 传入。如示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    AVAnalytics.onPause(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    AVAnalytics.onResume(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请确保在所需要的所有的 Activity 中都调用 <code>AVAnalytics.onResume()</code> 和 <code>AVAnalytics.onPause()</code> 方法，这两个调用将不会阻塞应用程序的主线程，也不会影响应用程序的性能。</p>
<p>注意：如果你的 Activity 之间有继承或者控制关系请不要同时在父和子 Activity 中重复添加 onPause 和 onResume 方法，否则会造成重复统计，比如在使用 TabHost、TabActivity、ActivityGroup 时。一个应用程序在多个 Activity 之间连续切换时，将会被视为同一个 session（会话或者一次使用过程）。</p>
<p>当用户两次使用之间间隔超过 30 秒时，将被认为是两个的独立的 session，例如用户回到 home，或进入其他程序，经过一段时间后再返回之前的应用。我们也提供了新的接口来自定义这个时间间隔，你只要调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.setSessionContinueMillis(<span class="keyword">long</span> mills);</span><br></pre></td></tr></table></figure>
<p>传入适当的参数，就可以控制 session 重新启动时间，注意参数是以毫秒为单位的。 例如，如果你认为在 60 秒之内返回应用可视为同一次启动，超过 60 秒返回当前应用可视为一次新的启动，那么请写成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.setSessionContinueMillis(<span class="number">60</span> * <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<h2 id="统计_Fragment_页面">统计 Fragment 页面</h2><p>Android 3.0 引入了 Fragment。使用 Fragment，你可以在一个 Activity 中展示多个用户界面，也可根据你的需要，为不同的设备适配界面。LeanCloud SDK 1.4.2 开始增加了对于 Fragment 统计的支持。你可以使用以下代码统计 Fragment 页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListFragment</span> <span class="keyword">extends</span> <span class="title">ListFragment</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onAttach(activity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        AVAnalytics.onFragmentEnd(<span class="string">"my-list-fragment"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        AVAnalytics.onFragmentStart(<span class="string">"my-list-fragment"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试">测试</h2><ul>
<li>确认所需的权限都已经添加：<ul>
<li><code>INTERNET</code></li>
<li><code>READ_PHONE_STATE</code></li>
<li><code>READ_LOGS</code></li>
<li><code>WRITE_EXTERNAL_STORAGE</code></li>
</ul>
</li>
<li>确认所有的 Activity 中都调用了 onResume 和 onPause 方法。</li>
<li>确认测试手机（或者模拟器）已成功连入网络。</li>
<li>启动应用程序，几分钟之内你应该已经可以在 <a href="/stat.html?appid=}#/statrealtime">控制台 / 分析</a> 中的相应菜单中看到报表了。</li>
</ul>
<h2 id="数据时效性">数据时效性</h2><p>在控制台的 <strong>分析</strong> 页面中，有些报告可以展示实时数据，有些报告则依靠 <a href="leaninsight_guide.html">离线数据</a> 进行分析，因此有时你会看不到当天的数据。</p>
<p>如果当前页面中存在 <strong>日期选择</strong> 选项（通常在页面右上角），你可以以此判断当前的统计结果是否有延迟。如果 <strong>结束日期</strong> 显示为 <strong>当日日期</strong> 或在其下拉菜单中有「今日」选项，即为实时数据；反之则为离线数据（如下图所示），要推迟一天才能看到当日的情况。</p>
<p><img src="../images/analytics_datepicker_for_offline_data.png" alt="" width="231" height="256"></p>
<h2 id="使用自定义事件">使用自定义事件</h2><h3 id="基本简单事件">基本简单事件</h3><p>除了基本统计分析功能外，SDK 还支持你自定义的事件分析，例如你可以统计你的应用中有多少人点击了 like 按键，某个文章的点击次数或者视频被播放的次数等等。</p>
<p>在你希望发送事件报告的代码段，调用如下方法就可以向服务器发送事件记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.onEvent(Context context, String eventName);</span><br></pre></td></tr></table></figure>
<p>统计 eventName 对应事件的发生次数、变化趋势，例如 like 点击、浏览数量等等。参数 context 为当前 context 的引用。eventName 为当前统计的事件 name。【注意】eventName 中不要加空格或其他的转义字符。</p>
<p>比如，应用中的一条微视频被转发的事件被定义为「Forward」，那么在点击转发的函数里调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.onEvent(<span class="keyword">this</span>, <span class="string">"Forward"</span>)</span><br></pre></td></tr></table></figure>
<p>就会向服务器汇报一个转发的事件。</p>
<h3 id="多标签事件">多标签事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.onEvent(Context context, String eventName, String  tag);</span><br></pre></td></tr></table></figure>
<p>除了能够统计 eventName 所对应事件的发生次数，变化趋势外，还能统计事件中具体标签所占的比例。tag 为当前标签，同样这里的 eventName 字符串中也请不要使用空格。<br>比如，在玩拍程序中，我们定义了一个发布微视频的多标签事件 Publish，对应的发布内容有 title（发布标题）、Video（发视频）、type（视频类型）来对应不同的发布类型，这样我们不仅可以记录 Publish 事件的点击数量还可以看到不同内容对应的比例。</p>
<h3 id="事件累计">事件累计</h3><p>在应用程序中某些自定义事件可能会被频繁触发，例如用户点击某个按钮。开发者可以在程序中维护一个计数器，这样某个事件被多次触发但只需要生成一个消息，这个消息中包括该事件被触发的次数。为了支持这个功能，我们提供了重载的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.onEvent(Context context, String eventName, <span class="keyword">int</span> count);</span><br><span class="line">AVAnalytics.onEvent(Context context, String eventName, String label, <span class="keyword">int</span> count)</span><br></pre></td></tr></table></figure>
<p>参数 count 是对应事件（和对应标签）被触发的次数。</p>
<h2 id="设置数据发送策略">设置数据发送策略</h2><p>你可以进入应用的 <a href="/stat.html?appid=&amp;os=android#/statconfig/trans_strategoy"><strong>分析</strong> &gt; <strong>统计设置</strong><span class="text-muted">（左下角）</span> &gt; <strong>数据发送策略</strong></a> 在线更改 SDK 端的数据报告发送策略。在没有取到在线配置的发送策略的情况下，会使用默认的发送策略。</p>
<p>以下均为在线配置中的可选策略。</p>
<h3 id="启动时发送">启动时发送</h3><p>【推荐使用】应用程序每次会在启动时会向服务器发送一次消息，在应用程序过程中产生的所有消息（包括自定义事件和本次使用时长）都会在下次启动时候发送。如果应用程序启动时处在不联网状态，那么消息将会缓存在本地，下次再尝试发送。</p>
<p>发送策略默认为启动时发送。</p>
<h3 id="批量发送">批量发送</h3><p>批量发送，默认当消息数量达到 30 条时发送一次。</p>
<h3 id="按最小间隔发送">按最小间隔发送</h3><p>间隔一段时间发送，每隔一段时间一次性发送到服务器。</p>
<h2 id="自定义参数设置">自定义参数设置</h2><p>你可以控制台某个应用的 <strong>组件</strong> &gt; <strong>自定义参数</strong> 设置中配置你的自定义在线参数。这些参数会在我们每次更新统计配置时进行更新，你可以用以下方法来获得对应的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.getConfigParams(<span class="keyword">this</span>.getContext(), <span class="string">"key"</span>)</span><br></pre></td></tr></table></figure>
<p>但是请注意三点：</p>
<ul>
<li>key 必须跟你在控制台配置的参数一致，大小写敏感。</li>
<li><p>由于统计参数更新时一个后台更新，你可能在直接调用 <code>AVAnalytics.getConfigParams(this.getContext(), &quot;key&quot;)</code> 时遇到返回值为 null 的情况。你可以通过设置 AVOnlineConfigureListener 和强制调用 updateOnlineConfig 来保证自定义配置的获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.setOnlineConfigureListener(<span class="keyword">new</span> AVOnlineConfigureListener() &#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReceived</span><span class="params">(JSONObject data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       AVAnalytics.getConfigParams(getContext(), <span class="string">"key"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;);</span><br><span class="line">AVAnalytics.updateOnlineConfig(getContext());</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于统计参数在客户端会有定时更新的策略，所以 AVOnlineConfigureListener 在客户端会发生多次调用的情况，请在 OnDataReceived 方法中不要放入太多函数副作用。</p>
</li>
</ul>
<h2 id="开发选项">开发选项</h2><p>如果你不准备区分开发 AppKey 与生产环境 AppKey，但是又不想开发时期的统计数据会影响产品上线后的统计数据，你可以使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVAnalytics.setAnalyticsEnabled(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 参数依次为 context, AppId, AppKey</span></span><br><span class="line">AVOSCloud.initialize(context,&#123;&#123;appid&#125;&#125;,&#123;&#123;appkey&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p>在开发阶段关闭统计的功能。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/30/avos/cloud_code_faq/" itemprop="url">
                云引擎常见问题和解答
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-30T07:56:29+08:00" content="2015-12-30">
            2015-12-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/leancloud/" itemprop="url" rel="index">
                  <span itemprop="name">leancloud</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/30/avos/cloud_code_faq/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/30/avos/cloud_code_faq/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="云引擎常见问题和解答">云引擎常见问题和解答</h1><h2 id="如何判断当前是测试环境还是生产环境？">如何判断当前是测试环境还是生产环境？</h2><p>请参考文档 <a href="/leanengine_guide-node.html#运行环境区分">云引擎开发指南 Node.js</a> / <a href="/leanengine_guide-python.html#运行环境区分">Python</a> - 运行环境区分。</p>
<h2 id="怎么添加第三方模块">怎么添加第三方模块</h2><p>云引擎 2.0 开始支持添加第三方模块（请参考 <a href="leanengine_guide-cloudcode.html#云代码_2_0_版">云引擎指南 - 升级到 2.0</a>），只需要像普通的 Node.js 项目那样，在项目根目录创建文件 <code>package.json</code>，下面是一个范例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">name</span>": <span class="value"><span class="string">"cloud-engine-test"</span></span>,</span><br><span class="line">  "<span class="attribute">description</span>": <span class="value"><span class="string">"Cloud Engine test project."</span></span>,</span><br><span class="line">  "<span class="attribute">version</span>": <span class="value"><span class="string">"0.0.1"</span></span>,</span><br><span class="line">  "<span class="attribute">private</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">dependencies</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">async</span>": <span class="value"><span class="string">"0.9.0"</span></span>,</span><br><span class="line">    "<span class="attribute">moment</span>": <span class="value"><span class="string">"2.9.0"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p><code>dependencies</code> 内的内容表明了该项目依赖的三方模块（比如示例中的 <code>async</code> 和 <code>moment</code>）。</p>
<p>然后在项目根目录执行：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span></span><br></pre></td></tr></table></figure>
<p>即可下载相关三方包到 <code>node_modules</code> 目录。</p>
<p>然后即可在代码中引入三方包：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：命令行工具部署时是不会上传 <code>node_modules</code> 目录，因为云代码服务器会根据 <code>package.json</code> 的内容自动下载三方包。所以也建议将 <code>node_modules</code> 目录添加到 <code>.gitignore</code> 中，使其不加入版本控制。</p>
<h2 id="Maximum_call_stack_size_exceeded_如何解决？">Maximum call stack size exceeded 如何解决？</h2><p><code>AV.Object.extend</code> 产生的对象需要作为全局变量保存（即定义在 AV.Cloud.define 方法之外）。因为每调用一次，就会产生一个新的类的实例，并且和之前创建的实例形成一个链表。调用次数过多后（几万次）就会堆栈溢出。如果你的应用时不时出现 <strong>Maximum call stack size exceeded</strong> 错误，请确认是否误用了 <code>AV.Object.extend</code> 方法。</p>
<p>我们在 <a href="./js_guide.html#AV_Object">JavaScript 指南 - AV.Object</a> 章节中也进行了描述。</p>
<h2 id="目前支持哪些语言？">目前支持哪些语言？</h2><p>我们提供了 JavaScript SDK，支持 Node.js 和 Python 环境，未来可能会引入 PHP 等其他语言。</p>
<h2 id="Web_Hosting_备案如何操作？">Web Hosting 备案如何操作？</h2><p>只有网站类的才需要备案，并且在主域名已备案的情况下，二级子域名不需要备案。 如果主站需要托管在我们这边，且还没有备案过，我们可以协助你完成备案，请参考文档 <a href="leanengine_guide-node.html#绑定独立域名">绑定独立域名 Node.js</a> / <a href="leanengine_guide-python.html#绑定独立域名">Python</a>。</p>
<h2 id="调用云引擎方法如何收费？">调用云引擎方法如何收费？</h2><p>现在云引擎本身不收费，云引擎中如果有 LeanCloud 的存储等 API 调用，按 API 收费策略收费。</p>
<h2 id="「定义函数」和「Git_部署」可以混用吗？">「定义函数」和「Git 部署」可以混用吗？</h2><p>「定于函数」的产生是为了方便大家初次体验云引擎，或者只是需要一些简单 hook 方法的应用使用。我们的实现方式就是把定义的函数拼接起来，生成一个云引擎项目然后部署。</p>
<p>所以可以认为「定义函数」和 「git 部署」最终是一样的，都是一个完整的项目。<br>是一个单独功能，可以不用使用基础包，git 等工具快速的生成和编辑云引擎。<br>当然，你也可以使用基础包，自己写代码并部署项目。<br>这两条路是分开的，任何一个部署，就会导致另一种方式失效掉。</p>
<h2 id="为什么查询_include_没有生效？">为什么查询 include 没有生效？</h2><p>以 JavaScript 云引擎为例子，很多时候，经常会定义一个云函数，在里面使用 <code>AV.Query</code> 查询一张表，并 include 其中一个 pointer 类型的字段，然后返回给客户端:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AV.Cloud.define(<span class="string">'querySomething'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> query = <span class="keyword">new</span> AV.Query(<span class="string">'Something'</span>);</span><br><span class="line">  <span class="comment">//假设 user 是 Something 表的一个 Pointer 列。</span></span><br><span class="line">  query.include(<span class="string">'user'</span>);</span><br><span class="line">  <span class="comment">//……其他条件或者逻辑……</span></span><br><span class="line">  query.find().then(<span class="function"><span class="keyword">function</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//返回查询结果给客户端</span></span><br><span class="line">    res.success(results);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//返回错误给客户端</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>你会看到返回的结果里， user 仍然是 pointer 类型，似乎 include 没有生效？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> result: [</span><br><span class="line">   &#123;</span><br><span class="line">     ……Something 其他字段</span><br><span class="line">     "user": &#123;</span><br><span class="line">       "className": "_User",</span><br><span class="line">       "__type": "Pointer",</span><br><span class="line">       "objectId": "abcdefg"</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ……</span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这其实是因为 <code>res.success(results)</code> 会调用到 <code>AV.Object#toJSON</code> 方法，将结果序列化为 JSON 对象返回给客户端。<br>而 <code>AV.Object#toJSON</code> 方法为了防止循环引用，当遇到属性是 Pointer 类型会返回 pointer 元信息，不会将 include 的其他字段添加进去。<br>因此，你需要主动将该字段进行 JSON 序列化，例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">query.find().then(<span class="function"><span class="keyword">function</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">   <span class="comment">//主动序列化 json 列。</span></span><br><span class="line">   results.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</span><br><span class="line">     result.set(<span class="string">'user'</span>, result.get(<span class="string">'user'</span>) ?  result.get(<span class="string">'user'</span>).toJSON() : <span class="literal">null</span>);</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">//再返回结果</span></span><br><span class="line">   res.success(results);</span><br><span class="line"> &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">   <span class="comment">//返回错误给客户端</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </nav>

 </div>

        

        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars2.githubusercontent.com/u/14305708?v=3&s=460" alt="terry" itemprop="image"/>
          <p class="site-author-name" itemprop="name">terry</p>
        </div>
        <p class="site-description motion-element" itemprop="description">terry yang's blog | java | scala | bi</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">135</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yangwei8888" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/microsoftgoogles" target="_blank">weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/run-zhi-38" target="_blank">zhihu</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">terry</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'yangwei888';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
