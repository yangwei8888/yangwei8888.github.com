

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The new @c attribute &mdash; Swift Programming Language documentation 0.1.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Swift Programming Language documentation 0.1.9 documentation" href="../index.html"/>
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Swift Programming Language documentation
          

          
          </a>

          
            
            
              <div class="version">
                0.1.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">swift docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ABI.html">The Swift ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ARCOptimization.html">ARC Optimization for Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControl.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControlInStdlib.html">Scope and introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControlInStdlib.html#public"><cite>public</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControlInStdlib.html#internal"><cite>internal</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControlInStdlib.html#private"><cite>private</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../AccessControlInStdlib.html#leading-underscore-rule">Leading Underscore Rule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Arrays.html">The Swift Array Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CallingConvention.html">The Swift Calling Convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DebuggingTheCompiler.html">Debugging the Swift Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Dependency Analysis.html">Dependency Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DriverInternals.html">Driver Design &amp; Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DriverParseableOutput.html">Parseable Driver Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ErrorHandling.html">Error Handling in Swift 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ErrorHandlingRationale.html">Error Handling Rationale and Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Failable Initializers.html">Failable initializers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Generics.html">Generics in Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GitWorkflows.html">Git Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GitWorkflows.html#svn-git-workflows">SVN -&gt; GIT Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HighLevelSILOptimizations.html">High-Level Optimizations in SIL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Import.html">IMPORT SYNTAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Import.html#resolving-name-clashes">RESOLVING NAME CLASHES</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Import.html#future-extensions">FUTURE EXTENSIONS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../IndexInvalidation.html">Index Invalidation Rules in the Swift Standard Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#using-versioned-api">Using Versioned API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#publishing-versioned-api">Publishing Versioned API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#giving-up-flexibility">Giving Up Flexibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#optimization">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#resilience-domains">Resilience Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#protocol-conformances">Protocol Conformances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#checking-binary-compatibility">Checking Binary Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#summary">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LibraryEvolution.html#glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Literals.html">Literals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LogicalObjects.html">Logical Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Modules.html">High-Level Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Modules.html#import"><code class="docutils literal"><span class="pre">import</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../Modules.html#interoperability-with-objective-c-via-clang">Interoperability with Objective-C via Clang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Modules.html#glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MutationModel.html">Immutability and Read-Only Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ObjectInitialization.html">Object Initialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html">Writing High-Performance Swift Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#enabling-optimizations">Enabling Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#whole-module-optimizations">Whole Module Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#reducing-dynamic-dispatch">Reducing Dynamic Dispatch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#using-container-types-efficiently">Using Container Types Efficiently</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#unchecked-operations">Unchecked operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#generics">Generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#the-cost-of-large-swift-values">The cost of large swift values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#unsafe-code">Unsafe code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#protocols">Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OptimizationTips.html#footnotes">Footnotes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pattern Matching.html">Pattern Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SIL.html">Swift Intermediate Language (SIL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SequencesAndCollections.html">Sequences And Collections in Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Serialization.html">Swift Binary Serialization Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StdlibAPIGuidelines.html">Swift Standard Library API Design Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StdlibRationales.html">Rationales for the Swift standard library designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StoredAndComputedVariables.html">Stored and Computed Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../StringDesign.html">Swift String Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Testing.html">Testing Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TextFormatting.html">Text Formatting in Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TransparentAttr.html"><code class="docutils literal"><span class="pre">&#64;_transparent</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../TypeChecker.html">Type Checker Design and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contents.html">Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../weak.html">Weak References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Swift Programming Language documentation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>The new &#64;c attribute</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="../_sources/proposals/AttrC.txt" rel="nofollow"> View page source</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>Eventually, we would like to write Swift modules which define pure-C entry
points for top-level functions, and be able to export more data types to
C code.</p>
<p>This will be important for the Linux port, but also perhaps for system
frameworks that want to transition to Swift.</p>
<p>The radars tracking this work are:</p>
<ul class="simple">
<li><a class="reference external" href="rdar://22488618">rdar://22488618</a> - &#64;c top-level functions</li>
<li><a class="reference external" href="rdar://22490914">rdar://22490914</a> - &#64;c structs</li>
</ul>
<div class="section" id="the-new-c-attribute">
<h1>The new &#64;c attribute<a class="headerlink" href="#the-new-c-attribute" title="Permalink to this headline">¶</a></h1>
<p>This attribute can be applied to the following kinds of declarations:</p>
<ul class="simple">
<li>top-level functions</li>
<li>static methods in non-generic classes</li>
<li>enums</li>
<li>structs</li>
</ul>
<p>There are two forms of the attribute:</p>
<div class="highlight-python"><div class="highlight"><pre>@c
@c(asmname)
</pre></div>
</div>
<p>The latter allows the exported name to be set. By default, the exported
name is the unmangled, unqualified name of the function or nominal type.</p>
<p>There is the question of how to gracefully handle name conflicts inside
a module. Since C does not have real modules or qualified names, we
probably can&#8217;t catch name conflicts until link time. At the very least,
we will prohibit overloading <code class="docutils literal"><span class="pre">&#64;c</span></code> functions (unless we use Clang-style
mangling and <code class="docutils literal"><span class="pre">__attribute__((overloadable))</span></code>).</p>
<p>However, we might want to prefix the default &#64;asmname of a &#64;c symbol
with the Swift module name followed by an underscore, instead of using
the unqualified name.</p>
</div>
<div class="section" id="type-bridging">
<h1>Type bridging<a class="headerlink" href="#type-bridging" title="Permalink to this headline">¶</a></h1>
<p>The rules for bridging types in <code class="docutils literal"><span class="pre">&#64;c</span></code> function signatures are a subset
of <code class="docutils literal"><span class="pre">&#64;objc</span></code>.</p>
<p>Bridgeable types are now partitioned into two broad categories, &#8220;POD&#8221;
and &#8220;non-POD&#8221;. POD types include:</p>
<ul class="simple">
<li>integers</li>
<li>floating point numbers</li>
<li>&#64;c enums</li>
<li>fixed size arrays (currently presented as homogeneous tuples of POD types)</li>
<li>&#64;c structs (whose fields must all be POD types)</li>
<li>pointers to C types</li>
<li>&#64;convention(c) function types</li>
</ul>
<p>On Linux, we can&#8217;t have reference counted pointers here at all, and
NSArray, etc do not exist, so only POD types are bridgeable. We must
ensure that we produce the right diagnostic and not crash when the
user references NSArray, etc on Linux.</p>
<p>On Darwin, we can allow passing reference counted pointers directly
as function parameters. They are still not allowed as fields in <code class="docutils literal"><span class="pre">&#64;c</span></code>
structs, though.</p>
<p>The convention for arguments and results can be the same as CoreFoundation
functions imported from C. The code in <code class="docutils literal"><span class="pre">CFunctionConventions</span></code> in
SILFunctionType.cpp looks relevant.</p>
</div>
<div class="section" id="bridging-header-output">
<h1>Bridging header output<a class="headerlink" href="#bridging-header-output" title="Permalink to this headline">¶</a></h1>
<p>We can reuse most of <code class="docutils literal"><span class="pre">PrintAsObjC</span></code> to allow generating pure-C headers
for Swift modules which use &#64;c but not &#64;objc.</p>
</div>
<div class="section" id="exporting-functions-to-c">
<h1>Exporting functions to C<a class="headerlink" href="#exporting-functions-to-c" title="Permalink to this headline">¶</a></h1>
<p>Applying <code class="docutils literal"><span class="pre">&#64;c</span></code> to a function is like a combination of <code class="docutils literal"><span class="pre">&#64;convention(c)</span></code>
and <code class="docutils literal"><span class="pre">&#64;asmname(func_name)</span></code>.</p>
<p>The types in the function signature are bridged as described above, and a
foreign entry point is generated with the C calling convention and given
asmname.</p>
<p>When the function is referenced from a <code class="docutils literal"><span class="pre">DeclRefExpr</span></code> inside of a
<code class="docutils literal"><span class="pre">FunctionConversionExpr</span></code> to <code class="docutils literal"><span class="pre">&#64;convention(c)</span></code>, we emit a direct
reference to this foreign entry point.</p>
</div>
<div class="section" id="c-applied-to-enums-and-structs">
<h1>&#64;c applied to enums and structs<a class="headerlink" href="#c-applied-to-enums-and-structs" title="Permalink to this headline">¶</a></h1>
<p>For enums, <code class="docutils literal"><span class="pre">&#64;c</span></code> and <code class="docutils literal"><span class="pre">&#64;objc</span></code> can be synonyms. We still have to track
which one the user used, for accurate printing. On Linux, <code class="docutils literal"><span class="pre">&#64;objc</span></code>
could probably be changed to always diagnose, but this will require
changing some tests.</p>
<p>As stated above, all the fields of a <code class="docutils literal"><span class="pre">&#64;c</span></code> struct must themselves be POD.</p>
<p>Structs declared as <code class="docutils literal"><span class="pre">&#64;c</span></code> need to be laid out with C size and alignment
conventions. We already do that for Swift structs imported from Clang by
asking Clang to do the layout on Clang AST, so perhaps for <code class="docutils literal"><span class="pre">&#64;c</span></code> structs
declared in Swift, we can go in the other direction by constructing Clang
AST for the struct.</p>
</div>
<div class="section" id="accessibility-and-linkage-for-c-declarations">
<h1>Accessibility and linkage for &#64;c declarations<a class="headerlink" href="#accessibility-and-linkage-for-c-declarations" title="Permalink to this headline">¶</a></h1>
<p>Only public enums and structs should appear in generated headers; for
private types, <code class="docutils literal"><span class="pre">&#64;c</span></code> only affects layout and restrictions on the field
types.</p>
<p>For functions, it is not clear if private together with <code class="docutils literal"><span class="pre">&#64;c</span></code> is useful,
but it could be implemented for completeness. We could either give the
foreign entry point private linkage, or intentionally give it incorrect
linkage allowing it to be found with <code class="docutils literal"><span class="pre">dlsym()</span></code>.</p>
</div>
<div class="section" id="inout-parameters-in-c-and-objc-functions">
<h1>inout parameters in &#64;c and &#64;objc functions<a class="headerlink" href="#inout-parameters-in-c-and-objc-functions" title="Permalink to this headline">¶</a></h1>
<p>Right now we don&#8217;t allow <code class="docutils literal"><span class="pre">inout</span></code> parameters for <code class="docutils literal"><span class="pre">&#64;objc</span></code> methods.
We could export them as nonnull pointers, using <code class="docutils literal"><span class="pre">__attribute__((nonnull(N)))</span></code>
rather than <code class="docutils literal"><span class="pre">_Nonnull</span></code>.</p>
<p>If we ever get as far as implementing C++ interoperability, we could also
export inouts as references rather than pointers.</p>
</div>
<div class="section" id="diagnostics">
<h1>Diagnostics<a class="headerlink" href="#diagnostics" title="Permalink to this headline">¶</a></h1>
<p>Right now all diagnostics for type bridging in Sema talk about Objective-C,
leading to funny phrasing when using invalid types in a <code class="docutils literal"><span class="pre">&#64;convention(c)</span></code>
function, for instance.</p>
<p>All diagnostics need to be audited to take the language as a parameter, and
either say <code class="docutils literal"><span class="pre">cannot</span> <span class="pre">be</span> <span class="pre">represented</span> <span class="pre">in</span> <span class="pre">C</span></code> or <code class="docutils literal"><span class="pre">cannot</span> <span class="pre">be</span> <span class="pre">represented</span> <span class="pre">in</span>
<span class="pre">Objective-C</span></code>. A Linux user should never see diagnostics talking about
Objective-C, except maybe if they explicitly mention <code class="docutils literal"><span class="pre">&#64;objc</span></code> in their code.</p>
<p>On the plus side, it is okay if we conservatively talk about <code class="docutils literal"><span class="pre">C</span></code> in
Objective-C diagnostics on Darwin.</p>
</div>
<div class="section" id="cleanups">
<h1>Cleanups<a class="headerlink" href="#cleanups" title="Permalink to this headline">¶</a></h1>
<p>Right now various aspects of the type bridging mapping are duplicated in
several places:</p>
<ul class="simple">
<li>ASTContext::getBridgedToObjC()</li>
<li>TypeChecker::isRepresentableInObjC() (various overloads)</li>
<li>include/swift/ClangImporter/BuiltinMappedTypes.def</li>
<li>include/swift/SIL/BridgedTypes.def</li>
<li>TypeConverter::getLoweredCBridgedType()</li>
<li>ClangImporter::VisitObjCObjectPointerType() and other places in ImportType.cpp</li>
<li>PrintAsObjC::printIfKnownGenericStruct()</li>
<li>PrintAsObjC::printIfKnownTypeName()</li>
</ul>
<p>We should try to consolidate some of this if possible, to make the
rules more consistent and easier to describe between Darwin and Linux.</p>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright apple.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>