<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="terry yang's blog | java | scala | bi" />



  <meta name="keywords" content="Hexo,next" />



  <link rel="alternate" href="/atom.xml" title="yosita" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="terry yang&apos;s blog | java | scala | bi">
<meta property="og:type" content="website">
<meta property="og:title" content="yosita">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="yosita">
<meta property="og:description" content="terry yang&apos;s blog | java | scala | bi">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yosita">
<meta name="twitter:description" content="terry yang&apos;s blog | java | scala | bi">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post'
  };
</script>

  <title> yosita </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7e8961fdae021b7bf62f2c767bb18c23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">yosita</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/25/swift-cn/chapter4/04_Interacting_with_C_Pointers/" itemprop="url">
                第四章-04Swift与C语言指针友好合作
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-25T10:00:07+08:00" content="2015-12-25">
            2015-12-25
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/swift-cn/" itemprop="url" rel="index">
                  <span itemprop="name">swift-cn</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/25/swift-cn/chapter4/04_Interacting_with_C_Pointers/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/25/swift-cn/chapter4/04_Interacting_with_C_Pointers/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Swift与C语言指针友好合作">Swift与C语言指针友好合作</h1><hr>
<blockquote>
<p>翻译：<a href="http://weibo.com/penguinliong/" target="_blank" rel="external">老码团队翻译组-Relly</a><br>校对：<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">老码团队翻译组-Tyrion</a> </p>
</blockquote>
<p>本页包含内容：</p>
<ul>
<li><a href="#inout-para-pointer">用以输入/输出的参数指针</a></li>
<li><a href="#array-as-para-pointer">作为数组使用的参数指针</a></li>
<li><a href="#string-as-para-pointer">用作字符串参数的指针</a></li>
<li><a href="#security-of-pointer-cast">指针参数转换的安全性</a></li>
</ul>
<p>Objective-C和C的API常常会需要用到指针。Swift中的数据类型都原生支持基于指针的Cocoa API，不仅如此，Swift会自动处理部分最常用的将指针作为参数传递的情况。这篇文章中，我们将着眼于在Swift中让C语言指针与变量、数组和字符串共同工作。</p>
<p>####用以输入/输出的参数指针<br>C和Objective-C并不支持多返回值，所以Cocoa API中常常将指针作为一种在方法间传递额外数据的方式。Swift允许指针被当作<code>inout</code>参数使用，所以你可以用符号<code>&amp;</code>将对一个变量的引用作为指针参数传递。举例来说：<code>UIColor</code>中的<code>getRed(_:green:blue:alpha:)</code>方法需要四个<code>CGFloat*</code>指针来接收颜色的组成信息，我们使用<code>&amp;</code>来将这些组成信息捕获为本地变量：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r: <span class="type">CGFloat</span> = <span class="number">0</span>, g: <span class="type">CGFloat</span> = <span class="number">0</span>, b: <span class="type">CGFloat</span> = <span class="number">0</span>, a: <span class="type">CGFloat</span> = <span class="number">0</span></span><br><span class="line">color.getRed(&amp;r, green: &amp;g, blue: &amp;b, alpha: &amp;a)</span><br></pre></td></tr></table></figure></p>
<p>另一种常见的情况是Cocoa中<code>NSError</code>的习惯用法。许多方法会使用一个<code>NSError**</code>参数来储存可能的错误的信息。举例来说：我们用<code>NSFileManager</code>的<code>contentOfDirectoryAtPath(_:error:)</code>方法来将目录下的内容列表，并将潜在的错误指向一个<code>NSError?</code>变量：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> maybeError: <span class="type">NSError</span>?</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> contents = <span class="type">NSFileManager</span>.defaultManager()</span><br><span class="line">	.contentsOfDirectoryAtPath(<span class="string">"/usr/bin"</span>, error: &amp;maybeError) &#123;</span><br><span class="line">	<span class="comment">// Work with the directory contents</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> error = maybeError &#123;</span><br><span class="line">	<span class="comment">// Handle the error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了安全性，Swift要求被使用<code>&amp;</code>传递的变量已经初始化。因为无法确定这个方法会不会在写入数据前尝试从指针中读取数据。</p>
<p>####作为数组使用的参数指针<br>在C语言中，数组和指针的联系十分紧密，而Swift允许数组能够作为指针使用，从而与基于数组的C语言API协同工作更加简单。一个固定的数组可以使用一个常量指针直接传递，一个变化的数组可以用<code>&amp;</code>运算符将一个非常量指针传递。就和输入/输出参数指针一样。举例来说：我们可以用Accelerate框架中的<code>vDSP_vadd</code>方法让两个数组<code>a</code>和<code>b</code>相加，并将结果写入第三个数组<code>result</code>。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Accelerate</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a: [<span class="type">Float</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="keyword">let</span> b: [<span class="type">Float</span>] = [<span class="number">0.5</span>, <span class="number">0.25</span>, <span class="number">0.125</span>, <span class="number">0.0625</span>]</span><br><span class="line"><span class="keyword">var</span> result: [<span class="type">Float</span>] = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">vDSP_vadd(a, <span class="number">1</span>, b, <span class="number">1</span>, &amp;result, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// result now contains [1.5, 2.25, 3.125, 4.0625]</span></span><br></pre></td></tr></table></figure></p>
<p>#用作字符串参数的指针<br>C语言中用<code>cont char*</code>指针来作为传递字符串的基本方式。Swift中的<code>String</code>可以被当作一个无限长度UTF-8编码的<code>const char*</code>指针来传递给方法。举例来说：我们可以直接传递一个字符串给一个标准C和POSIX库方法<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">puts(<span class="string">"Hello from libc"</span>)</span><br><span class="line"><span class="keyword">let</span> fd = open(<span class="string">"/tmp/scratch.txt"</span>, <span class="type">O_WRONLY</span>|<span class="type">O_CREAT</span>, <span class="number">0o666</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> fd &lt; <span class="number">0</span> &#123;</span><br><span class="line">	perror(<span class="string">"could not open /tmp/scratch.txt"</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> text = <span class="string">"Hello World"</span></span><br><span class="line">	write(fd, text, strlen(text))</span><br><span class="line">	close(fd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#指针参数转换的安全性<br>Swift很努力地使与C语言指针的交互更加便利，因为它们广泛地存在于Cocoa之中，同时保持一定的安全性。然而，相比你的其他Swift代码与C语言的指针交互具有潜在的不安全性，所以务必要小心使用。其中特别要注意：</p>
<ul>
<li><p>如果被调用者为了在其返回值之后再次使用而保存了C指针的数据，那么这些转换使用起来并不安全。转换后的指针仅在调用期间保证有效。甚至你将同样的变量、数组或字符串作为多指针参数再次传递，你每次都会收到一个不同的指针。这个异常将全局或静态地储存为变量。你可以安全地将这段地址当作永久唯一的指针使用。例如：作为一个KVO上下文参数使用的时候。</p>
</li>
<li><p>当指针类型为<code>Array</code>或<code>String</code>时，溢出检查不是强制进行的。 基于C语言的API无法增加数组和字符串大小，所以在你将其传递到基于C语言的API之前，你必须确保数组或字符的大小正确。</p>
</li>
</ul>
<p>如果你需要使用基于指针的API时没有遵守以上指导，或是你重写了接受指针参数的Cocoa方法，于是你可以在Swift中直接用不安全的指针来使用未经处理的内存。在未来的文章中我们将着眼于更加高级的情况。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/25/swift-cn/chapter4/05_Value_and_Reference_Types/" itemprop="url">
                第四章-05Swift里的值类型与引用类型
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-25T10:00:06+08:00" content="2015-12-25">
            2015-12-25
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/swift-cn/" itemprop="url" rel="index">
                  <span itemprop="name">swift-cn</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/25/swift-cn/chapter4/05_Value_and_Reference_Types/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/25/swift-cn/chapter4/05_Value_and_Reference_Types/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Swift里的值类型与引用类型">Swift里的值类型与引用类型</h1><hr>
<blockquote>
<p>翻译：<a href="http://weibo.com/littlekok/" target="_blank" rel="external">老码团队翻译组-Arya</a><br>校对：<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">老码团队翻译组-Jame</a></p>
</blockquote>
<p>本页包含内容：</p>
<ul>
<li><a href="#difference-two">值类型与引用类型的区别</a></li>
<li><a href="#act-in=mutation">Mutation（修改）在安全中扮演的角色</a></li>
<li><a href="#how-to-choose">如何选择类型</a></li>
</ul>
<h3 id="Swift里面的类型分为两种：">Swift里面的类型分为两种：</h3><ul>
<li><strong>值类型(Value Types)</strong>：每个实例都保留了一分独有的数据拷贝，一般以结构体 <code>（struct）</code>、<code>枚举（enum）</code> 或者<code>元组（tuple）</code>的形式出现。</li>
<li><strong>引用类型(Reference Type)</strong>：每个实例共享同一份数据来源，一般以<code>类（class）</code>的形式出现。</li>
</ul>
<p>在这篇博文里面，我们会介绍两种类型各自的优点，以及应该怎么选择使用。</p>
<p><a name="difference-two"></a></p>
<h4 id="值类型与引用类型的区别">值类型与引用类型的区别</h4><p>值类型和引用类型最基本的分别在复制之后的结果。当一个值类型被复制的时候，相当于创造了一个完全独立的实例，这个实例保有属于自己的独有数据，数据不会受到其他实例的数据变化影响：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面是一个值类型的例子</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> </span>&#123; <span class="keyword">var</span> data: <span class="type">Int</span> = -<span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="type">S</span>()</span><br><span class="line"><span class="keyword">var</span> b = a							<span class="comment">// b是a的拷贝</span></span><br><span class="line">a.data = <span class="number">42</span>							<span class="comment">// 更改a的数据，b的不受影响</span></span><br><span class="line"><span class="built_in">println</span>(<span class="string">"<span class="subst">\(a.data)</span>, <span class="subst">\(b.data)</span>"</span>)		<span class="comment">// 输出结果 "42, -1"</span></span><br></pre></td></tr></table></figure>
<p>值类型就好像身份证复印件一样，复印出来之后，修改原件上面的内容，复印件上的内容不会变。</p>
<p>另一方面，复制一个引用类型的时候，实际上是默默地创造了一个共享的实例分身，两者是共用一套数据。因此修改其中任何一个实例的数据，也会影响到另外那个。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面是一个引用类型的例子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123; <span class="keyword">var</span> data: <span class="type">Int</span> = -<span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">var</span> x = <span class="type">C</span>()</span><br><span class="line"><span class="keyword">var</span> y = x							<span class="comment">// y是x的拷贝</span></span><br><span class="line">x.data = <span class="number">42</span>							<span class="comment">// 更改x的数据，等于同时修改了y</span></span><br><span class="line"><span class="built_in">println</span>(<span class="string">"<span class="subst">\(x.data)</span>, <span class="subst">\(y.data)</span>"</span>)		<span class="comment">// 输出结果 "42, 42"</span></span><br></pre></td></tr></table></figure>
<p><a name="act-in=mutation"></a></p>
<h4 id="Mutation（修改）在安全中扮演的角色">Mutation（修改）在安全中扮演的角色</h4><p>值类型较引用类型来说，会让你更容易在大量代码中理清状况。如果你总是得到一个独立的拷贝出来的实例，你就可以放心它不会被你app里面的其他部分代码默默地修改。这在多线程的环境里面是尤为重要的，因为另外一个线程可能会在暗地里修改你的数据。因此可能会造成严重的程序错误，这在调试过程中非常难以排除。</p>
<p>由于差别主要在于修改数据的后果，那么当实例的数据只读，不存在需要更改的情况下，用哪种类型都是没有分别的。</p>
<p>你可能在想，有的时候我可能也需要一个完全不变的类。这样使用<code>Cocoa NSObject</code>对象的时候会比较容易，又可以保留值语义的好处。在今天，你可以通过只使用不可变的存储属性，和避开任何可以修改状态的API，用Swift写出一个不可变类<code>（immutable class）</code>。实际上，很多基本的Cocoa类，例如<code>NSURL</code>，都是设计成不可变类的。然而，Swift语言目前只强制<code>struct</code>和<code>enum</code>这种值类型的不可变性，对类这种引用类型则没有。（例如还不支持强制将子类的限制为不可变类）</p>
<p><a name="how-to-choose"></a></p>
<h4 id="如何选择类型？">如何选择类型？</h4><p>所以当我们想要建立一个新的类型的时候，怎么决定用值类型还是引用类型呢？当你使用Cocoa框架的时候，很多API都要通过NSObject的子类使用，所以这时候必须要用到引用类型class。在其他情况下，有下面几个准则：</p>
<ul>
<li><p><strong>什么时候该用值类型</strong>：</p>
<ul>
<li>要用==运算符来比较实例的数据时</li>
<li>你希望那个实例的拷贝能保持独立的状态时</li>
<li>数据会被多个线程使用时</li>
</ul>
</li>
<li><p><strong>什么时候该用引用类型（class）</strong>：</p>
<ul>
<li>要用==运算符来比较实例身份的时候</li>
<li>你希望有创建一个共享的、可变对象的时候</li>
</ul>
</li>
</ul>
<p>在Swift里面，数组(Array)、字符串(String)、字典(Dictionary)都属于值类型。它们就像C语言里面简单的int值，是一个个独立的数据个体。你不需要花任何功夫来防范其他代码在暗地里修改它们。更重要的是，你可以在线程之间安全的传递变量，而不需要特地去同步。在Swift高安全性的精神下，这个模式会帮助你用Swift写出更可控的代码。</p>
<hr>
<p>本章节不是老码的原创，老码认真的阅读了苹果的官方博客，且自己的练习总结，如果小伙伴们费了吃奶的劲还是看不懂，请找度娘谷歌，还是看不懂请到老码<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">官方微博</a>咆哮。  </p>
<h5 id="本文由翻译自Apple_Swift_Blog_：Value_and_Reference_Types">本文由翻译自Apple Swift Blog ：<a href="https://developer.apple.com/swift/blog/?id=10" target="_blank" rel="external">Value and Reference Types</a></h5></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/25/swift-cn/chapter4/06_Access_Control_and_Protected/" itemprop="url">
                第四章-06访问控制和protected
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-25T10:00:05+08:00" content="2015-12-25">
            2015-12-25
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/swift-cn/" itemprop="url" rel="index">
                  <span itemprop="name">swift-cn</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/25/swift-cn/chapter4/06_Access_Control_and_Protected/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/25/swift-cn/chapter4/06_Access_Control_and_Protected/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="访问控制和protected">访问控制和protected</h1><hr>
<blockquote>
<p>翻译：<a href="http://weibo.com/littlekok/" target="_blank" rel="external">老码团队翻译组-Arya</a><br>校对：<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">老码团队翻译组-Jame</a></p>
</blockquote>
<p>原文再续，书折第一回。</p>
<p>很多其他编程语言都有一种”protected“设定，可以限制某些类方法只能被它的子类所使用。</p>
<p>Swift支持了访问控制后，大家给我们的反馈都很不错。而有的开发者问我们：“为什么Swift没有类似protected的选项？” </p>
<p><strong>当我们在设计Swift访问控制的不同等级时，我们认为有两种主要场景：</strong></p>
<ul>
<li>在一个APP里：隐藏某个类的私密细节。</li>
<li>在一个开源框架里：不让导入这个框架的APP，随便接触框架的内部实现细节。</li>
</ul>
<p>上面的两种常见情况，对应着private和internal这两个等级。</p>
<p>而protected相当于把访问控制和继承特性混在一起，把访问控制的等级设定增加了一个维度，使之复杂化。即使设定了protected，子类还是可以通过新的公开方法、新的属性来接触到所谓“protected”了的API。另一方面，我们可以在各种地方重写一个方法，所谓的保护却没有提供优化机制。这种设定往往在做不必要的限制  一 protected允许了子类，但又禁止所有其他别的类（包括那些帮助子类实现某些功能的类）接触父类的成员。</p>
<p>有的开发者指出，apple的框架有时候也会把给子类用的API分隔出来。这时候protected不就有用了吗？我们研究后发现，这些方法一般属于下面两种情况：一是这些方法对子类以外的类没啥用，所以不需要严格保护（例如上面说的协助实现某些功能的类）。二是这些方法就是设计出来被重写，而不是直接用的。举个例子，<code>drawRect(_:)</code>就是在UIKit基础上使用的方法，但它不能在UIKit以外应用。</p>
<p>除此之外，如果有了protected，它要怎么样和extension相互作用呢？一个类的extension能接触它的protected成员吗？一个子类的extension可以接触父类的protected成员吗？extension声明的位置对访问控制等级有没有影响呢？（复杂到要哭了是不是？）</p>
<p>对访问控制的设计，也依循了Objective－C开发者（包括apple内外的）的常规做法。Objective－C方法和属性一般在.h头文件里声明，但也可以写在.m实现文件里。假如有一个公开的类，想把里面某些部分设为只有框架内可以获取时，开发者一般会创建另一个头文件给内部使用。以上三种访问级别，就对应了Swift里面的public，private和internal。</p>
<p>Swift的访问控制等级和继承无关，是单维度、非常清楚明了的。我们认为这样的模式更简洁，同时满足了最主要的需求：将一个类、或一个框架的实现细节隔离保护起来。这可能和你以前用过的不同，但我们鼓励你试试看。</p>
<hr>
<p>本章节不是老码的原创，是老码认真的阅读了苹果的官方博客，自己的练习总结，如果小伙伴们费了吃奶的劲还是看不懂，请找度娘谷歌。还是看不懂？请到老码<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">官方微博</a>咆哮。  </p>
<h5 id="本文由翻译自Apple_Swift_Blog_：Access_Control_and_Protected">本文由翻译自Apple Swift Blog ：<a href="原文地址：https://developer.apple.com/swift/blog/?id=11">Access Control and Protected</a></h5></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/25/swift-cn/chapter4/07_Optional_Case_Study/" itemprop="url">
                第四章-07可选类型完美解决占位问题
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-25T10:00:04+08:00" content="2015-12-25">
            2015-12-25
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/swift-cn/" itemprop="url" rel="index">
                  <span itemprop="name">swift-cn</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/25/swift-cn/chapter4/07_Optional_Case_Study/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/25/swift-cn/chapter4/07_Optional_Case_Study/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="可选类型完美解决占位问题">可选类型完美解决占位问题</h1><hr>
<blockquote>
<p>翻译：<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">老码团队翻译组-Tyrion</a><br>校对：<a href="http://weibo.com/littlekok/" target="_blank" rel="external">老码团队翻译组-Ayra</a></p>
</blockquote>
<p>本页包含内容：</p>
<ul>
<li><a href="#add-function">为Dictionary增加objectsForKeys函数</a></li>
<li><a href="##easy-function">Swift中更简便的方法</a></li>
<li><a href="#nested-optional">内嵌可选类型</a></li>
<li><a href="#provide-default">提供一个默认值</a></li>
</ul>
<p>可选类型是Swift中新引入的，功能很强大。在这篇博文里讨论的，是在Swift里，如何通过可选类型来保证强类型的安全性。作为例子，我们来创建一个Objective-C API的Swift版本，但实际上Swift本身并不需要这样的API。</p>
<p><a name="#add-function"></a></p>
<h4 id="为Dictionary增加objectsForKeys函数">为Dictionary增加objectsForKeys函数</h4><p>在Objective-C中，<figure class="highlight"><figcaption><span>这个方法需要一个```NSArray```数组作为键值参数，然后返回一个包含相关值的数组。文档里写到："返回数组中的第N个值，和输入数组中的第N个值相对应"，那如果有某个键值在字典里不存在呢？于是就有了```notFoundMarker```作为返回提示。比如第三个键值没有找到，那么在返回数组中第三个值就是这个```notFoundMarker```，而不是字典中的第三个值，但是这个值只是用来提醒原字典中没有找到对应值，但在返回数组中该元素存在，且用```notFoundMarker```作为占位符，因为这个对象不能直接使用，所以在Foundation框架中有个专门的类处理这个情况：```NSNull```。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#22312;Swift&#20013;&#65292;```Dictionary```&#31867;&#27809;&#26377;&#31867;&#20284;```objectsForKeys```&#30340;&#20989;&#25968;&#65292;&#20026;&#20102;&#35828;&#26126;&#38382;&#39064;&#65292;&#25105;&#20204;&#21160;&#25163;&#21152;&#19968;&#20010;&#65292;&#24182;&#19988;&#20351;&#20854;&#25104;&#20026;&#25805;&#20316;&#23383;&#20856;&#20540;&#30340;&#36890;&#29992;&#26041;&#27861;&#12290;&#25105;&#20204;&#21487;&#20197;&#29992;```extension```&#26469;&#23454;&#29616;&#65306;&#10;&#10;```swift&#10;extension Dictionary&#123;&#10;&#9;func valuesForKeys(keys:[K], notFoundMarker: V )-&#62;[V]&#123;&#10;&#9;&#9;//&#20855;&#20307;&#23454;&#29616;&#20195;&#30721;&#21518;&#38754;&#20250;&#20889;&#21040;&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上就是我们实现的Swift版本，这个和Objective-C版本有很大区别。在Swift中，因为其强类型的原因限制了返回的结果数组只能包含单一类型的元素，所以我们不能放<figure class="highlight"><figcaption><span>我们只用```nil```就可以了。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;```swift&#10;extension Dictionary&#123;&#10;    func valuesForKeys(keys: [Key]) -&#62; [Value?] &#123;&#10;        var result = [Value?]()&#10;        result.reserveCapacity(keys.count)&#10;        for key in keys&#123;&#10;            result.append(self[key])&#10;        &#125;&#10;        return result&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p><a name="#easy-function"></a></p>
<h4 id="Swift中更简便的方法">Swift中更简便的方法</h4><p>小伙伴们可能会问，为什么Swift中不需要实现这么一个API呢？其实其有更简单的实现，如下面代码所示：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Dictionary</span> </span>&#123;</span><br><span class="line">	<span class="func"><span class="keyword">func</span> <span class="title">valuesForKeys</span><span class="params">(keys: [Key])</span></span> -&gt; [<span class="type">Value</span>?] &#123;</span><br><span class="line">		<span class="keyword">return</span> keys.<span class="built_in">map</span> &#123; <span class="keyword">self</span>[$<span class="number">0</span>] &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述方式实现的功能和最开始的方法实现的功能相同，虽然核心的功能是封装了<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#23454;&#39564;&#20960;&#20010;&#20363;&#23376;&#65306;&#10;&#10;```swift&#10;var dic: Dictionary = [ &#34;1&#34;: 2, &#34;3&#34;:3, &#34;4&#34;:5 ]&#10;&#10;var t = dic.valuesForKeys([&#34;1&#34;, &#34;4&#34;]) &#10;//&#32467;&#26524;&#20026;&#65306;[Optional(2), Optional(5)]&#10;&#10;var t = dict.valuesForKeys([&#34;3&#34;, &#34;9&#34;])&#10;// &#32467;&#26524;&#20026;&#65306;[Optional(3), nil]&#10;&#10;t = dic.valuesForKeys([])&#10;//&#32467;&#26524;&#20026;&#65306;[]</span><br></pre></td></tr></table></figure></p>
<p><a name="#nested-optional"></a></p>
<h4 id="内嵌可选类型">内嵌可选类型</h4><p>现在，如果我们为每一个结果调用<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;```swift&#10;var dic: Dictionary = [ &#34;1&#34;: 2, &#34;3&#34;:3, &#34;4&#34;:5 ]&#10;&#10;var t = dic.valuesForKeys([&#34;1&#34;, &#34;4&#34;]).last //&#32467;&#26524;&#20026;&#65306;Optional(Optional(5))&#10;// Optional(Optional(&#34;Ching&#34;))&#10;&#10;var t = dict.valuesForKeys([&#34;3&#34;, &#34;9&#34;]).last&#10;// &#32467;&#26524;&#20026;&#65306;Optional(nil)&#10;&#10;var t = dict.valuesForKeys([]).last&#10;// &#32467;&#26524;&#20026;&#65306;nil</span><br></pre></td></tr></table></figure></p>
<p>小伙伴们立马迷糊了，为什么会出现两层包含的可选类型呢？，特别对第二种情况的<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#25105;&#20204;&#22238;&#36807;&#22836;&#30475;&#30475;```last```&#23646;&#24615;&#30340;&#23450;&#20041;&#65306;&#10;&#10;```swift&#10;var last:T? &#123; get &#125;</span><br></pre></td></tr></table></figure></p>
<p>很明显<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#22914;&#26524;&#22312;Objective-C&#20013;&#37325;&#26032;&#35843;&#29992;&#19978;&#36848;&#26041;&#27861;&#65292;&#25105;&#20204;&#23558;&#20351;&#29992;```NSNull```&#20316;&#20026;&#21344;&#20301;&#31526;&#65292;Objective-C&#30340;&#35843;&#29992;&#35821;&#27861;&#22914;&#19979;&#25152;&#31034;&#65306;&#10;&#10;```swift&#10;[dict valuesForKeys:@[@&#34;1&#34;, @&#34;4&#34;] notFoundMarker:[NSNull null]].lastObject&#10;// 5&#10;[dict valuesForKeys:@[@&#34;1&#34;, @&#34;3&#34;] notFoundMarker:[NSNull null]].lastObject&#10;// NSNull&#10;[dict valuesForKeys:@[] notFoundMarker:[NSNull null]].lastObject&#10;// nil</span><br></pre></td></tr></table></figure></p>
<p>不管是Swift版本还是Objective-C版本，返回值为<figure class="highlight"><figcaption><span>但是如果返回是```Optional(nil)```或者Objective-C中的```NSNull```都表示数组中的最后一个元素存在，但是元素的内容是空的。在Objective-C中只能借助```NSNull```作为占位符来达到这个目的，但是Swift却可以语言系统类型的角度的实现。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#60;a name=&#34;#provide-default&#34;&#62;&#60;/a&#62;&#10;#### &#25552;&#20379;&#19968;&#20010;&#40664;&#35748;&#20540;&#10;&#10;&#36827;&#19968;&#27493;&#23553;&#35013;&#65292;&#22914;&#26524;&#25105;&#23383;&#20856;&#20013;&#30340;&#26576;&#20010;&#25110;&#26576;&#20123;&#20803;&#32032;&#19981;&#23384;&#22312;&#65292;&#25105;&#20204;&#24819;&#25552;&#20379;&#19968;&#20010;&#40664;&#35748;&#20540;&#24590;&#20040;&#21150;&#21602;&#65311;&#23454;&#29616;&#26041;&#27861;&#24456;&#31616;&#21333;&#65306;&#10;&#10;```swift&#10;extension Dictionary &#123;&#10;&#9;func valuesForKeys( keys:[Key], notFoundMarker: Value)-&#62;[Value]&#123;&#10;&#9;&#9;return self.valueForKeys(kes).map&#123; $0 ?? notFoundMarker &#125;&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict.<span class="function"><span class="title">valuesForKeys</span><span class="params">([<span class="string">"1"</span>, <span class="string">"5"</span>], notFoundMarker: <span class="string">"Anonymous"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>和Objective-C相比，其需要占位符来达到占位的目的，但是Swift却已经从语言类型系统的层面原生的支持了这种用法，同时提供了丰富的语法功能。这就是Swift可选类型的强大之处。同时注意上述例子中用到了空合运算符<code>??</code>。</p>
<hr>
<p>本章节不是老码的原创，是老码认真的阅读了苹果的官方博客，自己的练习总结，如果小伙伴们费了吃奶的劲还是看不懂，请找度娘谷歌。还是看不懂？请到老码<a href="http://weibo.com/u/5241713117" target="_blank" rel="external">官方微博</a>咆哮。  </p>
<h5 id="本文由翻译自Apple_Swift_Blog_：Optionals_Case_Study:_valuesForKeys">本文由翻译自Apple Swift Blog ：<a href="https://developer.apple.com/swift/blog/?id=12" target="_blank" rel="external">Optionals Case Study: valuesForKeys</a></h5></span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/19/awesome-power-mode-master/" itemprop="url">
                代码震动插件Awesome Power Mode
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-19T07:56:29+08:00" content="2015-12-19">
            2015-12-19
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/blog/" itemprop="url" rel="index">
                  <span itemprop="name">blog</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/19/awesome-power-mode-master/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/19/awesome-power-mode-master/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Awesome_Power_Mode">Awesome Power Mode</h1><blockquote>
<p>A curated list of power modes as popularized in <a href="https://github.com/codeinthedark/editor/pull/1" target="_blank" rel="external">https://github.com/codeinthedark/editor/pull/1</a> by <a href="https://github.com/joelbesada" target="_blank" rel="external">@JoelBesada</a>.</p>
</blockquote>
<h2 id="Atom">Atom</h2><ul>
<li><a href="https://github.com/JoelBesada/activate-power-mode" target="_blank" rel="external">https://github.com/JoelBesada/activate-power-mode</a></li>
</ul>
<h2 id="Codemirror">Codemirror</h2><ul>
<li><a href="https://github.com/chinchang/code-blast-codemirror" target="_blank" rel="external">https://github.com/chinchang/code-blast-codemirror</a></li>
</ul>
<h2 id="JavaScript">JavaScript</h2><ul>
<li><a href="https://github.com/disjukr/activate-power-mode" target="_blank" rel="external">https://github.com/disjukr/activate-power-mode</a></li>
</ul>
<h2 id="VIM">VIM</h2><ul>
<li><a href="https://github.com/mattn/vim-particle" target="_blank" rel="external">https://github.com/mattn/vim-particle</a></li>
</ul>
<h2 id="Visual_Studio">Visual Studio</h2><ul>
<li><a href="https://github.com/LiamMorrow/Visual-Studio-Power-Mode" target="_blank" rel="external">https://github.com/LiamMorrow/Visual-Studio-Power-Mode</a></li>
</ul>
<h2 id="Windows">Windows</h2><ul>
<li><a href="https://github.com/if1live/ParticleOnTextCursor" target="_blank" rel="external">https://github.com/if1live/ParticleOnTextCursor</a></li>
</ul>
<h2 id="XCode">XCode</h2><ul>
<li><a href="https://github.com/poboke/ActivatePowerMode" target="_blank" rel="external">https://github.com/poboke/ActivatePowerMode</a></li>
<li><a href="https://github.com/qfish/XActivatePowerMode" target="_blank" rel="external">https://github.com/qfish/XActivatePowerMode</a></li>
<li><a href="https://github.com/Dawn-/CoderPower" target="_blank" rel="external">https://github.com/Dawn-/CoderPower</a></li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/18/avos/ios_start/" itemprop="url">
                未命名
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-18T18:18:16+08:00" content="2015-12-18">
            2015-12-18
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/18/avos/ios_start/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/18/avos/ios_start/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h4 id="自动安装">自动安装</h4><p><a href="http://www.cocoapods.org" target="_blank" rel="external">CocoaPods</a> 是一个很好的依赖管理工具，我们推荐您使用这个方法来安装 SDK，最大化的简化安装过程。</p>
<p>LeanCloud SDK for iOS 同时支持动态库和静态库，使用 CocoaPods 进行集成时要进行区分。</p>
<p>如果使用 <strong>静态库</strong> 方式进行集成，则在 Podfile 中添加：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">'AVOSCloud'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用实时通信功能，可以添加：</span></span><br><span class="line">pod <span class="string">'AVOSCloudIM'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用崩溃收集功能，可以添加：</span></span><br><span class="line">pod <span class="string">'AVOSCloudCrashReporting'</span></span><br></pre></td></tr></table></figure>
<p>如果使用 <strong>动态库</strong> 方式进行集成，则在 Podfile 中添加：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use_frameworks!</span><br><span class="line"></span><br><span class="line">pod <span class="string">'AVOSCloudDynamic'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用实时通信功能，可以添加：</span></span><br><span class="line">pod <span class="string">'AVOSCloudIMDynamic'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用崩溃收集功能，可以添加：</span></span><br><span class="line">pod <span class="string">'AVOSCloudCrashReportingDynamic'</span></span><br></pre></td></tr></table></figure>
<p>然后在项目根目录执行 <code>pod install</code> 命令，就能将 LeanCloud SDK for iOS 集成到你的项目中。</p>
<h4 id="手动安装">手动安装</h4><p>你也可以手动将 LeanCloud SDK for iOS 集成到项目中。</p>
<p>iOS 从 8.0 开始支持动态库，如果你的项目只支持 iOS 8 及以上，使用动态库是个不错的选择。</p>
<h5 id="目录结构">目录结构</h5><p>首先，从下面的地址下载最新版本的 iOS SDK：</p>
<p><a class="btn btn-default" href="sdk_down.html">下载 iOS SDK</a></p>

<p>下载完成后，解压缩下载的文件，可以看到每个模块有如下的目录结构：</p>
<p><img src="images/quick_start/ios/dir_tree.png" alt="img"></p>
<p>就像目录名描述的那样，Dynamic 目录下存放着动态库，Static 目录下存放着静态库。</p>
<h5 id="安装动态库">安装动态库</h5><p>首先，准备好待集成的模块。将它们放入同一个目录中：</p>
<p><img src="images/quick_start/ios/all_frameworks.png" alt="img"></p>
<p>请注意，所有 frameworks 都是 Dynamic 目录下面的，确保它们都是动态库。</p>
<p>然后，将这个目录拖入你的项目中：</p>
<p><img src="images/quick_start/ios/1.png" alt="img"></p>
<p>确保 <strong>Copy items if needed</strong> 选择框处于选中状态：</p>
<p><img src="images/quick_start/ios/2.png" alt="img"></p>
<p>做完上面这些步骤后，项目看起来是这样：</p>
<p><img src="images/quick_start/ios/3.png" alt="img"></p>
<p>然后切换到 Targets 的 General 选项卡，点击 <strong>Embedded Binaries</strong> 左下角的加号按钮，添加 frameworks：</p>
<p><img src="images/quick_start/ios/embedded_binaries.png" alt="img"></p>
<p>最后，由于 Xcode 对动态库的处理不当，导致提交审核时，iTunes Connect 校验失败。需要一个额外的步骤来纠正。</p>
<p>在 Build Phases 选项卡中，添加一个 Run Script：</p>
<p><img src="images/quick_start/ios/create_run_script.png" alt="img"></p>
<p>确保 Shell 是默认的 <code>/bin/sh</code>，然后将以下脚本粘贴进去：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">APP_PATH=<span class="string">"<span class="variable">$&#123;TARGET_BUILD_DIR&#125;</span>/<span class="variable">$&#123;WRAPPER_NAME&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">find <span class="string">"<span class="variable">$APP_PATH</span>"</span> -name <span class="string">'*.framework'</span> -type d | <span class="keyword">while</span> <span class="built_in">read</span> -r FRAMEWORK; <span class="keyword">do</span></span><br><span class="line">    EXTRACTED_ARCHS=()</span><br><span class="line"></span><br><span class="line">    FRAMEWORK_EXECUTABLE_NAME=$(defaults <span class="built_in">read</span> <span class="string">"<span class="variable">$FRAMEWORK</span>/Info.plist"</span> CFBundleExecutable)</span><br><span class="line">    FRAMEWORK_EXECUTABLE_PATH=<span class="string">"<span class="variable">$FRAMEWORK</span>/<span class="variable">$FRAMEWORK_EXECUTABLE_NAME</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ARCH <span class="keyword">in</span> <span class="variable">$ARCHS</span>; <span class="keyword">do</span></span><br><span class="line">        lipo -extract <span class="string">"<span class="variable">$ARCH</span>"</span> <span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>"</span> -o <span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>-<span class="variable">$ARCH</span>"</span></span><br><span class="line">        EXTRACTED_ARCHS+=(<span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>-<span class="variable">$ARCH</span>"</span>)</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    lipo -o <span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>-merged"</span> -create <span class="string">"<span class="variable">$&#123;EXTRACTED_ARCHS[@]&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    mv <span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>-merged"</span> <span class="string">"<span class="variable">$FRAMEWORK_EXECUTABLE_PATH</span>"</span></span><br><span class="line">    rm <span class="string">"<span class="variable">$&#123;EXTRACTED_ARCHS[@]&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    /usr/bin/codesign <span class="operator">-f</span> <span class="operator">-s</span> <span class="string">"<span class="variable">$&#123;CODE_SIGN_IDENTITY&#125;</span>"</span> <span class="variable">$FRAMEWORK</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>这样就集成完毕了。</p>
<h5 id="安装静态库">安装静态库</h5><div class="callout callout-info">确保你正在使用最新版本的 Xcode（4.6+），并且面向 iOS 4.3 或者更高版本。我们推荐 Xcode 5 和 iOS 5 或以上系统。</div>

<p>首先，跟安装动态库一样，准备好待集成的模块。将它们放入同一个目录中：</p>
<p><img src="images/quick_start/ios/all_frameworks.png" alt="img"></p>
<p>请注意，所有 frameworks 都是 Static 目录下面的，确保它们都是静态库。</p>
<p>然后，将这个目录拖入你的项目中：</p>
<p><img src="images/quick_start/ios/1.png" alt="img"></p>
<p>确保 <strong>Copy items if needed</strong> 选择框处于选中状态：</p>
<p><img src="images/quick_start/ios/2.png" alt="img"></p>
<p>做完上面这些步骤后，项目看起来是这样：</p>
<p><img src="images/quick_start/ios/3.png" alt="img"></p>
<p>切换到 Targets 的 <strong>Build Phases</strong> 选项卡，展开 <strong>Link Binary With Libraries</strong> 可以看到：</p>
<p><img src="images/quick_start/ios/4.png" alt="img"></p>
<p>点击 <strong>Link Binary With Libraries</strong> 部分左下角的加号按钮：</p>
<p><img src="images/quick_start/ios/6.png" alt="img"></p>
<p>添加下列 framework 以及连接选项：</p>
<ul>
<li>手动添加下列依赖库：<ul>
<li>SystemConfiguration.framework</li>
<li>MobileCoreServices.framework</li>
<li>CoreTelephony.framework</li>
<li>CoreLocation.framework</li>
</ul>
</li>
<li>在 Target 的 <em>Build Settings</em> 中，为 <em>Other Linker Flags</em> 增加：<ul>
<li><code>-lz</code></li>
<li><code>-licucore</code></li>
<li><code>-ObjC</code></li>
<li><code>-lc++</code> （Crash Reporting 模块需要）</li>
<li><code>-lsqlite3</code> （IM 模块需要）</li>
</ul>
</li>
</ul>
<p><img src="images/quick_start/ios/all_load.png" alt="img"></p>
<h4 id="初始化_SDK">初始化 SDK</h4><p>打开 AppDelegate.m 文件，添加下列导入语句到头部：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">&lt;AVOSCloud/AVOSCloud.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>然后粘贴下列代码到 <code>application:didFinishLaunchingWithOptions</code> 函数内：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果使用美国站点，请加上这行代码 [AVOSCloud useAVCloudUS];</span></span><br><span class="line">[AVOSCloud <span class="string">setApplicationId:</span>@<span class="string">"&#123;&#123;appid&#125;&#125;"</span></span><br><span class="line"><span class="label">              clientKey:</span>@<span class="string">"&#123;&#123;appkey&#125;&#125;"</span>];</span><br></pre></td></tr></table></figure>
<p>如果想跟踪统计应用的打开情况，后面还可以添加下列代码：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[AVAnalytics trackAppOpenedWithLaunchOptions:launchOptions]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>创建应用后，可以在 <a href="/app.html?appid=#/key">控制台 &gt; 应用设置</a> 里面找到应用对应的 id 和 key。</p>
<p>修改编译选项 <strong>Architectures</strong> 值为 <strong>Standard architectures(armv7,arm64)</strong>：</p>
<p><img src="images/quick_start/ios/arm64.png" alt="img"></p>
<p>保证在你的 <strong>.h</strong> 头文件里包含了 SDK 库文件：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">&lt;AVOSCloud/AVOSCloud.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>将下面的代码拷贝到你的 app 里，比如在 <code>viewDidLoad</code> 方法（或者其他在运行 app 时会调用到的方法）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AVObject *<span class="built_in">test</span>Object = [AVObject objectWithClassName:@<span class="string">"TestObject"</span>];</span><br><span class="line">[<span class="built_in">test</span>Object <span class="built_in">set</span>Object:@<span class="string">"bar"</span> <span class="keyword">for</span>Key:@<span class="string">"foo"</span>];</span><br><span class="line">[<span class="built_in">test</span>Object save];</span><br></pre></td></tr></table></figure>
<p>运行 app，一个类名为 <code>TestObject</code> 的新对象会被发送到 LeanCloud 并保存下来。当做完这一切，访问 <a href="/data.html?appid=#/TestObject">控制台 &gt; 数据管理</a> 可以看到上面创建的 TestObject 的相关数据。</p>
<h4 id="社交组件">社交组件</h4><p>最后，如果希望使用社交组件功能，可以使用我们的开源组件：<a href="https://github.com/leancloud/leancloud-social-ios" target="_blank" rel="external">leancloud-social-ios</a>。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/18/avos/android_push_guide/" itemprop="url">
                未命名
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-18T18:16:12+08:00" content="2015-12-18">
            2015-12-18
          </time>
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/18/avos/android_push_guide/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/18/avos/android_push_guide/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Android_消息推送开发指南">Android 消息推送开发指南</h1><p>请先阅读 <a href="push_guide.html">消息推送概览</a> 了解相关概念。</p>
<p>Android 推送功能除了需要必须的 avoscloud.jar 以外，还需要额外的 avospush.jar。</p>
<p>Android 消息推送有专门的 Demo，请见 <a href="https://github.com/leancloud/android-push-demo" target="_blank" rel="external">Android-Push-Demo</a> 项目。</p>
<h2 id="Installation">Installation</h2><p>当应用在用户设备上安装好以后，如果要使用消息推送功能，LeanCloud SDK 会自动生成一个 Installation 对象。该对象本质上是应用在设备上生成的安装信息，也包含了推送所需要的所有数据，因此，要使用它来进行消息推送。</p>
<h3 id="保存_Installation">保存 Installation</h3><p>你可以通过以下代码保存你的 Installation id。如果你的系统之前还没有 Installation id, 系统会为你自动生成一个。如果你的应用卸载后，Installation id也将会被删除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AVInstallation.getCurrentInstallation().saveInBackground();</span><br></pre></td></tr></table></figure>
<p><strong>这段代码应该在应用启动的时候调用一次，保证设备注册到 LeanCloud 平台，你可以监听调用回调，获取 installationId 做数据关联</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AVInstallation.getCurrentInstallation().saveInBackground(<span class="keyword">new</span> SaveCallback() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">done</span><span class="params">(AVException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 保存成功</span></span><br><span class="line">            String installationId = AVInstallation.getCurrentInstallation().getInstallationId();</span><br><span class="line">            <span class="comment">// 关联  installationId 到用户表等操作……</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 保存失败，输出错误信息</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="启动推送服务">启动推送服务</h2><p>通过调用以下代码启动推送服务，同时设置默认打开的 Activity。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置默认打开的 Activity</span></span><br><span class="line">PushService.setDefaultPushCallback(<span class="keyword">this</span>, PushDemo.<span class="keyword">class</span>);</span><br></pre></td></tr></table></figure>
<h2 id="订阅频道">订阅频道</h2><p>你的应用可以订阅某个频道（channel）的消息，只要在保存 Installation 之前调用 <code>PushService.subscribe</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅频道，当该频道消息到来的时候，打开对应的 Activity</span></span><br><span class="line"><span class="comment">// 参数依次为：当前的 context、频道名称、回调对象的类</span></span><br><span class="line">PushService.subscribe(<span class="keyword">this</span>, <span class="string">"public"</span>, PushDemo.class);</span><br><span class="line">PushService.subscribe(<span class="keyword">this</span>, <span class="string">"private"</span>, Callback1.class);</span><br><span class="line">PushService.subscribe(<span class="keyword">this</span>, <span class="string">"protected"</span>, Callback2.class);</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>频道名称：<strong>每个 channel 名称只能包含 26 个英文字母和数字。</strong></li>
<li>回调对象：指用户点击通知栏的通知进入的 Activity 页面。</li>
</ul>
<p>退订频道也很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PushService.unsubscribe(context, <span class="string">"protected"</span>);</span><br><span class="line"><span class="comment">//退订之后需要重新保存 Installation</span></span><br><span class="line">AVInstallation.getCurrentInstallation().saveInBackground();</span><br></pre></td></tr></table></figure>
<h2 id="推送消息">推送消息</h2><h3 id="配置">配置</h3><p>请确保你的 <code>AndroidManifest.xml</code> 的 <code>&lt;application&gt;</code> 中包含如下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">service</span> <span class="attribute">android:name</span>=<span class="value">"com.avos.avoscloud.PushService"</span></span><br><span class="line">  <span class="attribute">android:exported</span>=<span class="value">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时设置了必要的权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.INTERNET"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>为了让应用能在关闭的情况下也可以收到推送，你需要在 <code>&lt;application&gt;</code> 中加入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">receiver</span> <span class="attribute">android:name</span>=<span class="value">"com.avos.avoscloud.AVBroadcastReceiver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.USER_PRESENT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.net.conn.CONNECTIVITY_CHANGE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="推送给所有的设备">推送给所有的设备</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AVPush push = <span class="keyword">new</span> AVPush();</span><br><span class="line">JSONObject object = <span class="keyword">new</span> JSONObject();</span><br><span class="line">object.put(<span class="string">"alert"</span>, <span class="string">"push message to android device directly"</span>);</span><br><span class="line">push.setPushToAndroid(<span class="keyword">true</span>);</span><br><span class="line">push.setData(object);</span><br><span class="line">push.sendInBackground(<span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(AVException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// push successfully.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// something wrong.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="发送给特定的用户">发送给特定的用户</h3><p>发送给「public」频道的用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AVQuery pushQuery = AVInstallation.getQuery();</span><br><span class="line">pushQuery.whereEqualTo(<span class="string">"channels"</span>, <span class="string">"public"</span>);</span><br><span class="line">AVPush push = <span class="keyword">new</span> AVPush();</span><br><span class="line">push.setQuery(pushQuery);</span><br><span class="line">push.setMessage(<span class="string">"Push to channel."</span>);</span><br><span class="line">push.setPushToAndroid(<span class="keyword">true</span>);</span><br><span class="line">push.sendInBackground(<span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(AVException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;   <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>发送给某个 Installation id 的用户，通常来说，你会将 AVInstallation 关联到设备的登录用户 AVUser 上作为一个属性，然后就可以通过下列代码查询 InstallationId 的方式来发送消息给特定用户，实现类似私信的功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">AVQuery pushQuery = AVInstallation.getQuery();</span><br><span class="line"><span class="comment">// 假设 THE_INSTALLATION_ID 是保存在用户表里的 installationId，</span></span><br><span class="line"><span class="comment">// 可以在应用启动的时候获取并保存到用户表</span></span><br><span class="line">pushQuery.whereEqualTo(<span class="string">"installationId"</span>, THE_INSTALLATION_ID);</span><br><span class="line">AVPush.sendMessageInBackground(<span class="string">"message to installation"</span>,  pushQuery, <span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(AVException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在 2.6.7 以后，我们加入了通过 CQL 来筛选推送目标的功能，主要代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">AVPush push = <span class="keyword">new</span> AVPush();</span><br><span class="line">JSONObject data =</span><br><span class="line">    <span class="keyword">new</span> JSONObject(</span><br><span class="line">        <span class="string">"&#123;\"action\": \"com.avos.UPDATE_STATUS\", \"name\": \"Vaughn\", \"newsItem\": \"Man bites dog\"  &#125;"</span>);</span><br><span class="line">push.setData(data);</span><br><span class="line">String installationId = AVInstallation.getCurrentInstallation().getInstallationId();</span><br><span class="line">push.setCloudQuery(<span class="string">"select * from _Installation where installationId ='"</span> + installationId</span><br><span class="line">    + <span class="string">"'"</span>);</span><br><span class="line">push.sendInBackground(<span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(AVException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<div class="callout callout-info">CQL 与 AVQuery 同时只能设置一个，并且 <code>setPushTarget</code> 类函数（setPushToAndroid / setPushToIOS / setPushToWindowsPhone）只能与 AVQuery 一起使用。在设置 CQL 时，只能在 CQL 语句中设定目标机器的类型。</div>

<h3 id="自定义_Receiver">自定义 Receiver</h3><p>如果你想推送消息，但不显示在 Andoid 系统的通知栏中，而是执行应用程序预定义的逻辑，你需要在你的 Android 项目中添加如下配置：</p>
<p>AndroidManifest.xml 中声明你的 Receiver：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">receiver</span> <span class="attribute">android:name</span>=<span class="value">"com.avos.avoscloud.PushDemo.MyCustomReceiver"</span> <span class="attribute">android:exported</span>=<span class="value">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.USER_PRESENT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.net.conn.CONNECTIVITY_CHANGE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"com.avos.UPDATE_STATUS"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>com.avos.avoscloud.PushDemo.MyCustomReceiver</code> 是你的 Android 的 Receiver 类。</p>
<p>而 <code>&lt;action android:name=&quot;com.avos.UPDATE_STATUS&quot; /&gt;</code> 需要与 push 的 data 中指定的 action 相对应。</p>
<p>你的 Receiver 可以按照如下方式实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyCustomReceiver"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        LogUtil.log.d(TAG, <span class="string">"Get Broadcat"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String action = intent.getAction();</span><br><span class="line">            String channel = intent.getExtras().getString(<span class="string">"com.avos.avoscloud.Channel"</span>);</span><br><span class="line">            <span class="comment">//获取消息内容</span></span><br><span class="line">            JSONObject json = <span class="keyword">new</span> JSONObject(intent.getExtras().getString(<span class="string">"com.avos.avoscloud.Data"</span>));</span><br><span class="line"></span><br><span class="line">            Log.d(TAG, <span class="string">"got action "</span> + action + <span class="string">" on channel "</span> + channel + <span class="string">" with:"</span>);</span><br><span class="line">            Iterator itr = json.keys();</span><br><span class="line">            <span class="keyword">while</span> (itr.hasNext()) &#123;</span><br><span class="line">                String key = (String) itr.next();</span><br><span class="line">                Log.d(TAG, <span class="string">"..."</span> + key + <span class="string">" =&gt; "</span> + json.getString(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"JSONException: "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，要求发送推送的请求也做相应更改，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"X-LC-Id: &#123;&#123;appid&#125;&#125;"</span>          \</span><br><span class="line">  -H <span class="string">"X-LC-Key: &#123;&#123;appkey&#125;&#125;"</span>        \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  <span class="operator">-d</span> <span class="string">'&#123;</span><br><span class="line">        "channels":[ "public"],</span><br><span class="line">        "data": &#123;</span><br><span class="line">          "action": "com.avos.UPDATE_STATUS",</span><br><span class="line">          "name": "LeanCloud."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;'</span> \</span><br><span class="line">  https://leancloud.cn/<span class="number">1.1</span>/push</span><br></pre></td></tr></table></figure>
<div class="callout callout-info">如果你使用自定义的 Receiver，发送的消息必须带 action，并且其值在自定义的 Receiver 配置的 <code>&lt;intent-filter&gt;</code> 列表里存在，比如这里的 ‘com.avos.UPDATE_STATUS’，请使用自己的 action，尽量不要跟其他应用混淆，推荐采用域名来定义。</div>

<h3 id="跟踪_Android_推送和应用的打开情况">跟踪 Android 推送和应用的打开情况</h3><p>你可以在订阅频道对应的 Activity 中添加跟踪应用打开情况的统计代码，你的 Activity 可以按照如下方式实现 <code>onStart</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.onStart();</span><br><span class="line"></span><br><span class="line">		Intent intent = getIntent();</span><br><span class="line">		AVAnalytics.trackAppOpened(intent);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以在 <a href="/apistat.html?appid=#/_appOpenWithPush">请求分析</a> 菜单里看到通知和应用的打开情况。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/18/bilibili/2831578/" itemprop="url">
                中二病也要谈恋爱！恋 Lite＋SP 合辑【BD1080P】
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-18T07:56:29+08:00" content="2015-12-18">
            2015-12-18
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/helloworld/" itemprop="url" rel="index">
                  <span itemprop="name">helloworld</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/18/bilibili/2831578/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/18/bilibili/2831578/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><div class="bili_video"><embed height="452" width="544" quality="high" allowfullscreen="true" type="application/x-shockwave-flash" src="http://share.acg.tv/flash.swf" flashvars="aid=2831578&page=1" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash"></div>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/15/swift/proposals/0004-remove-pre-post-inc-decrement/" itemprop="url">
                0004-remove-pre-post-inc-decrement
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-15T12:30:00+08:00" content="2015-12-15">
            2015-12-15
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/blog/" itemprop="url" rel="index">
                  <span itemprop="name">blog</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/15/swift/proposals/0004-remove-pre-post-inc-decrement/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/15/swift/proposals/0004-remove-pre-post-inc-decrement/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Remove_the_++_and_-_operators">Remove the <code>++</code> and <code>--</code> operators</h1><ul>
<li>Proposal: <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0004-remove-pre-post-inc-decrement.md" target="_blank" rel="external">SE-0004</a></li>
<li>Author: <a href="https://github.com/lattner" target="_blank" rel="external">Chris Lattner</a></li>
<li>Status: <strong>Accepted</strong></li>
</ul>
<h2 id="Introduction">Introduction</h2><p>The increment/decrement operators in Swift were added very early in the<br>development of Swift, as a carry-over from C.  These were added without much<br>consideration, and haven’t been thought about much since then.  This document<br>provides a fresh look at them, and ultimately recommends we just remove them<br>entirely, since they are confusing and not carrying their weight.</p>
<p>As a quick refresher, there are four operators in this family:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = ++x  <span class="comment">// pre-increment  - returns input value after mutation</span></span><br><span class="line"><span class="keyword">let</span> b = x++  <span class="comment">// post-increment - returns copy of input value before mutation</span></span><br><span class="line"><span class="keyword">let</span> <span class="built_in">c</span> = --x  <span class="comment">// pre-decrement  - returns input value after mutation</span></span><br><span class="line"><span class="keyword">let</span> d = x--  <span class="comment">// post-decrement - returns copy of input value before mutation</span></span><br></pre></td></tr></table></figure>
<p>However, the result value of these operators are frequently ignored.</p>
<h2 id="Advantages_of_These_Operators">Advantages of These Operators</h2><p>The primary advantage of these operators is their expressive capability.  They<br>are shorthand for (e.g.) <code>x += 1</code> on a numeric type, or <code>x.advance()</code> on an<br>iterator-like value.  When the return value is needed, the Swift <code>+=</code> operator<br>cannot be used in-line, since (unlike C) it returns <code>Void</code>.</p>
<p>The second advantage of Swift supporting this family of operators is continuity<br>with C, and other common languages in the extended C family (C++, Objective-C,<br>Java, C#, Javascript, etc).  People coming to Swift from these other languages<br>may reasonably expect these operators to exist.  That said, there are also<br>popular languages which have kept the majority of C operators but dropped these<br>(e.g. Python).</p>
<h2 id="Disadvantages_of_These_Operators">Disadvantages of These Operators</h2><ol>
<li><p>These operators increase the burden to learn Swift as a first programming<br>language - or any other case where you don’t already know these operators from a<br>different language.</p>
</li>
<li><p>Their expressive advantage is minimal - <code>x++</code> is not much shorter<br>than <code>x += 1</code>.</p>
</li>
<li><p>Swift already deviates from C in that the <code>=</code>, <code>+=</code> and other assignment-like<br>operations returns <code>Void</code> (for a number of reasons).  These operators are<br>inconsistent with that model.</p>
</li>
<li><p>Swift has powerful features that eliminate many of the common reasons you’d<br>use <code>++i</code> in a C-style for loop in other languages, so these are relatively<br>infrequently used in well-written Swift code.  These features include<br>the <code>for-in</code> loop, ranges, <code>enumerate</code>, <code>map</code>, etc.</p>
</li>
<li><p>Code that actually uses the result value of these operators is often<br>confusing and subtle to a reader/maintainer of code.  They encourage “overly<br>tricky” code which may be cute, but difficult to understand.</p>
</li>
<li><p>While Swift has well defined order of evaluation, any code that depended on<br>it (like <code>foo(++a, a++)</code>) would be undesirable even if it was well-defined.</p>
</li>
<li><p>These operators are applicable to relatively few types: integer and floating<br>point scalars, and iterator-like concepts. They do not apply to complex numbers,<br>matrices, etc.  </p>
</li>
</ol>
<p>Finally, these fail the metric of “if we didn’t already have these, would we add<br>them to Swift 3?”</p>
<h2 id="Proposed_Approach">Proposed Approach</h2><p>We should just drop these operators entirely.  In terms of roll-out, we should<br>deprecate them in the Spring Swift 2.x release (with a nice Fixit hint to cover<br>common cases), and remove them completely in Swift 3.</p>
<h2 id="Alternatives_considered">Alternatives considered</h2><p>Simplest alternative: we could keep them. More interesting to consider, we could<br>change these operators to return Void.  This solves some of the problems above,<br>but introduces a new question: once the result is gone, the difference between<br>the prefix and postfix form also vanishes.  Given that, we would have to pick<br>between these unfortunate choices:</p>
<p>1) Keep both <code>x++</code> and <code>++x</code> in the language, even though they do the same<br>thing.</p>
<p>2) Drop one of <code>x++</code> or <code>++x</code>.  C++ programmers generally prefer the prefix<br>forms, but everyone else generally prefers the postfix forms.  Dropping either<br>one would be a significant deviation from C.</p>
<p>Despite considering these options carefully, they still don’t justify the<br>complexity that the operators add to Swift.</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/12/15/swift/proposals/0003-remove-var-parameters-patterns/" itemprop="url">
                0003-remove-var-parameters-patterns
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-15T12:30:00+08:00" content="2015-12-15">
            2015-12-15
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/blog/" itemprop="url" rel="index">
                  <span itemprop="name">blog</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/15/swift/proposals/0003-remove-var-parameters-patterns/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/15/swift/proposals/0003-remove-var-parameters-patterns/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h1 id="Removing_var_from_Function_Parameters_and_Pattern_Matching">Removing <code>var</code> from Function Parameters and Pattern Matching</h1><ul>
<li>Proposal: <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0003-remove-var-parameters-patterns.md" target="_blank" rel="external">SE-0003</a></li>
<li>Author(s): <a href="https://github.com/bitjammer" target="_blank" rel="external">David Farler</a></li>
<li>Status: <strong>Accepted</strong></li>
<li>Review manager: <a href="https://github.com/jopamer" target="_blank" rel="external">Joe Pamer</a></li>
</ul>
<h2 id="Introduction">Introduction</h2><p>Value types are a major asset to the Swift language, affording safety and the<br>ability to reason about the effects of mutation by working with a locally copied<br>instance. When you want to create a <em>mutable</em> copy of a value, you create a<br><em>variable</em>, marked with the <code>var</code> keyword. Not only can you create variables as<br>explicit declarations, you can override bindings that are normally immutable<br><em>constants</em> by marking them with <code>var</code> too.</p>
<p>Function parameters are immutable by default:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(i: Int)</span></span> &#123;</span><br><span class="line">  i += <span class="number">1</span> <span class="comment">// illegal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">foo</span><span class="params">(<span class="keyword">var</span> i: Int)</span></span> &#123;</span><br><span class="line">  i += <span class="number">1</span> <span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So-called <em>refutable pattern</em> matches, that will bind an optional value and<br>provide the binding to a body of code are also immutable by default:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> x = getOptionalFoo() &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// illegal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">var</span> x = getOptionalFoo() &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> x = gen.next() &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// illegal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">var</span> x = gen.next() &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">guard <span class="keyword">let</span> x = gen.next() <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">x.mutatingMethod() <span class="comment">// illegal</span></span><br><span class="line"></span><br><span class="line">guard <span class="keyword">var</span> x = gen.next() <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">x.mutatingMethod() <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> optionalInt &#123;</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">None</span>: <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">case</span> .<span class="type">Some</span>(<span class="keyword">let</span> x):</span><br><span class="line">    x += <span class="number">1</span> <span class="comment">// illegal</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> optionalInt &#123;</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">None</span>: <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">case</span> .<span class="type">Some</span>(<span class="keyword">var</span> x):</span><br><span class="line">    x += <span class="number">1</span> <span class="comment">// OK</span></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For-in statements also allow variable bindings:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> sequence &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// illegal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">var</span> x <span class="keyword">in</span> sequence &#123;</span><br><span class="line">  x.mutatingMethod() <span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Using <code>var</code> annotations on function parameters and pattern bindings in if-,<br>while-, guard-, case-, and for-in statements have limited utility, optimizing<br>for a line of code at the cost of confusion. To emphasize the fact these values<br>are unique copies, we should not allow use of <code>var</code> in these places.</p>
<h2 id="Motivation">Motivation</h2><p><code>var</code> allows one to reassign and call mutating methods on value types, but there<br>is an <em>implicit</em> local copy of the value, yet there can be confusion that <code>var</code><br>somehow makes values types have <em>reference semantics</em> or <em>inout semantics</em>. To<br>make it very clear, we want to require a separated, <em>explicit</em> <code>var</code> declaration<br>and make bindings of function parameters and pattern matches <em>always</em> their<br>default - immutable constants.</p>
<h3 id="Function_Parameters">Function Parameters</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">doSomethingWithVar</span><span class="params">(<span class="keyword">var</span> x: Int)</span></span> &#123;</span><br><span class="line">  x = <span class="number">2</span> <span class="comment">// The caller of this function can't observe this assignment.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here, the <em>local copy</em> of <code>x</code> mutates but the write does not propagate back to<br>the original value that was passed, so the caller can never observe the change<br>directly.  For that to happen to value types, you have to mark the parameter<br>with <code>inout</code>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">doSomethingWithInout</span><span class="params">(<span class="keyword">inout</span> i: Int)</span></span> &#123;</span><br><span class="line">  i = <span class="number">2</span> <span class="comment">// This will have an effect on the caller's Int that was passed.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">doSomethingWithVar(x)</span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">doSomethingWithInout(&amp;x)</span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<h3 id="var_Bindings_in_Pattern_Matching"><code>var</code> Bindings in Pattern Matching</h3><p>This problem can also manifest in the local scopes wherever pattern matching is<br>allowed:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">getOptionalNumber</span><span class="params">()</span></span> -&gt; <span class="type">Int</span>? &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = getOptionalNumber()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">var</span> x = x &#123;</span><br><span class="line">  x = doSomethingWith(x) <span class="comment">// Whoops! Doesn't affect the original `x`!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>In summary, the problems that motivate this change are:</p>
<ul>
<li><code>var</code> is often confused with <code>inout</code> in function parameters.</li>
<li><code>var</code> is often confused to make value types have reference semantics.</li>
<li>Use of <code>var</code> at these sites don’t make the intention of creating a unique,<br>local, mutable copy as explicit and clear as it could be.</li>
</ul>
<h2 id="Proposed_solution">Proposed solution</h2><ul>
<li>All function parameters are either unannotated constants or are marked with <code>inout</code>.</li>
<li>Only <code>if let</code> is allowed, not <code>if var</code>.</li>
<li>Only <code>guard let</code> is allowed, not <code>guard var</code>.</li>
<li>Only <code>while let</code> is allowed, not <code>while var</code>.</li>
<li>Only <code>case .Some(let x)</code> is allowed, not <code>case .Some(var x)</code>.</li>
<li>Only <code>for x in</code> is allowed, not <code>for var x in</code>.</li>
</ul>
<h2 id="Design">Design</h2><p>The above changes can be made almost entirely in the parser, triggering error<br>diagnostics.  Function parameters explictly marked with <code>let</code> will be a warning<br>because they are immutable by default. In addition, the compiler will stop<br>suggesting <code>var</code> when trying to directly mutate function arguments.</p>
<h2 id="Impact_on_existing_code">Impact on existing code</h2><p>As a purely mechanical migration away from these uses of <code>var</code>, a temporary<br>variable can be immediately introduced that shadows the immutable copy in all of<br>the above uses. For example:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> x = getOptionalInt() &#123;</span><br><span class="line">  <span class="keyword">var</span> x = x</span><br><span class="line">  x += <span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>However, uses of these variable bindings often indicate an anti-pattern or<br>misunderstanding of the scope of mutation of value types. For example:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">mkdtemp</span><span class="params">(<span class="keyword">var</span> <span class="keyword">prefix</span>: String?)</span></span> -&gt; <span class="type">Path</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">prefix</span> == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">prefix</span> = getenv(<span class="string">"TMPDIR"</span>) ?? <span class="string">"/tmp"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="type">Path</span>(<span class="keyword">prefix</span>, getUniqueSuffix())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>prefix</code> is only ever assigned once so the following code suffices and<br>only uses immutable values:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">mkdtemp</span><span class="params">(<span class="keyword">prefix</span>: String?)</span></span> -&gt; <span class="type">Path</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Path</span>(<span class="keyword">prefix</span> ?? getenv(<span class="string">"TMPDIR"</span>) ?? <span class="string">"/tmp"</span>, getUniqueSuffix())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So, we expect users of Swift to rethink some of their existing code where these<br>are used.</p>
<h2 id="Alternatives_considered">Alternatives considered</h2><p>This is the best approach to alternate/new syntax or terminology because:</p>
<ul>
<li>It removes confusion by offering only one “switch” to flip to get a mutable<br>value.</li>
<li>It makes use of mutable variables stand out as an explicit line of code<br>instead of being embedded in other syntax.</li>
<li>It promotes use of immutable constants.</li>
<li>It makes the language smaller.</li>
</ul>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/">&laquo;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/9/">&raquo;</a>
  </nav>

 </div>

        

        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars2.githubusercontent.com/u/14305708?v=3&s=460" alt="terry" itemprop="image"/>
          <p class="site-author-name" itemprop="name">terry</p>
        </div>
        <p class="site-description motion-element" itemprop="description">terry yang's blog | java | scala | bi</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">130</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yangwei8888" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/microsoftgoogles" target="_blank">weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/run-zhi-38" target="_blank">zhihu</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">terry</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'yangwei888';
      var disqus_identifier = 'page/8/index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
